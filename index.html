<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬7å¤©6å¤œ - æ—…è¡ŒåŠ©æ‰‹</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ—¼</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/localforage/dist/localforage.min.js"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tokyo: { DEFAULT: '#e11d48', 50: '#fff1f2', 100: '#ffe4e6', 500: '#f43f5e', 600: '#e11d48', 900: '#881337' }
                    }
                }
            }
        }
    </script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SortableJS (æ–°å¢) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Map Markers */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin { width: 30px; height: 30px; border-radius: 50% 50% 50% 0; background: #e11d48; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 5px rgba(0,0,0,0.3); }
        .marker-pin::after { content: ''; width: 14px; height: 14px; margin: 8px 0 0 8px; background: #fff; position: absolute; border-radius: 50%; }
        .marker-icon { position: absolute; width: 22px; font-size: 16px; left: 0; right: 0; margin: 6px auto; text-align: center; color: white; z-index: 10; transform: rotate(45deg); }

        /* Sync Status Animation */
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        .status-syncing { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Animation for modal */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Token input styles */
        .token-input-container { position: relative; }
        .token-input-container i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6b7280; }
        .token-help { font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem; }
        .token-help a { color: #e11d48; text-decoration: underline; }
        
        /* å¿«é€Ÿé‡‘é¡æŒ‰éˆ• */
        .quick-amount-btn { transition: all 0.2s ease; }
        .quick-amount-btn:active { transform: scale(0.95); }
		
        /* è·³å‹•å‹•ç•« */
		@keyframes bounce {
			0%, 100% { transform: translateY(0) scale(1); }
			50% { transform: translateY(-12px) scale(1.15); }
		}

		.marker-bounce {
			animation: bounce 0.6s ease-in-out 4;
		}

		/* è„ˆè¡å…‰æšˆæ•ˆæœ */
		@keyframes pulse-glow {
			0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
			70% { box-shadow: 0 0 0 12px rgba(255, 215, 0, 0); }
			100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
		}

		.marker-glow {
			animation: pulse-glow 1.5s infinite;
		}
		
		/* åœ°åœ–å®¹å™¨å„ªåŒ– */
		#mapContainer {
			transition: opacity 0.3s ease;
		}
		
		.map-loading {
			opacity: 0.5;
		}
		
		/* ä¿®å¾©åœ°åœ–å®¹å™¨ */
		.leaflet-container {
			background: #e0e7ff !important;
		}
		
		.dark .leaflet-container {
			background: #1e293b !important;
		}
		
		/* ä¿®å¾©æ¨™è¨˜åœ¨ç¸®æ”¾æ™‚ä¸æ›´æ–°çš„å•é¡Œ */
		.leaflet-zoom-animated {
			will-change: transform;
		}
		
		/* ç¢ºä¿æ¨™è¨˜å®¹å™¨å¯ä»¥ç¸®æ”¾ */
		.leaflet-marker-icon {
			transition: transform 0.3s ease;
		}
		
		/* SortableJS æ‹–æ›³æ¨£å¼ (æ–°å¢) */
        .sortable-ghost { opacity: 0.4; background-color: #f3f4f6; }
        .dark .sortable-ghost { background-color: #374151; }
        .sortable-drag { cursor: grabbing; }

        /* è¡Œææ¸…å–®è‡ªå®šç¾©è¤‡é¸æ¡† */
        .custom-checkbox input:checked + div {
            background-color: #e11d48;
            border-color: #e11d48;
        }
        .custom-checkbox input:checked + div svg {
            display: block;
        }
		/* æ©«å‘æ»¾å‹•å®¹å™¨å„ªåŒ– */
		.scroll-container {
			-webkit-overflow-scrolling: touch; /* iOS å¹³æ»‘æ»¾å‹• */
			scrollbar-width: none; /* Firefox éš±è—æ»¾å‹•æ¢ */
			-ms-overflow-style: none; /* IE/Edge éš±è—æ»¾å‹•æ¢ */
		}

		.scroll-container::-webkit-scrollbar {
			display: none; /* Chrome/Safari éš±è—æ»¾å‹•æ¢ */
		}

		/* åˆ†é¡å°è¦½å„ªåŒ– */
		.category-navigation {
			position: relative;
			margin-bottom: 12px;
		}

		/* æ»¾å‹•æç¤º - å·¦å´æ¼¸è®Šé™°å½± */
		.scroll-gradient-left {
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 20px;
			background: linear-gradient(to right, 
				rgba(255,255,255,1) 0%, 
				rgba(255,255,255,0) 100%);
			z-index: 10;
			pointer-events: none;
		}

		.dark .scroll-gradient-left {
			background: linear-gradient(to right, 
				rgba(30, 41, 59, 1) 0%, 
				rgba(30, 41, 59, 0) 100%);
		}

		/* æ»¾å‹•æç¤º - å³å´æ¼¸è®Šé™°å½± */
		.scroll-gradient-right {
			position: absolute;
			right: 0;
			top: 0;
			bottom: 0;
			width: 20px;
			background: linear-gradient(to left, 
				rgba(255,255,255,1) 0%, 
				rgba(255,255,255,0) 100%);
			z-index: 10;
			pointer-events: none;
		}

		.dark .scroll-gradient-right {
			background: linear-gradient(to left, 
				rgba(30, 41, 59, 1) 0%, 
				rgba(30, 41, 59, 0) 100%);
		}

		/* åˆ†é¡æŒ‰éˆ•å„ªåŒ– */
		.category-button {
			flex-shrink: 0;
			transition: all 0.2s ease;
			user-select: none;
			-webkit-tap-highlight-color: transparent;
		}

		.category-button:active {
			transform: scale(0.95);
		}
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 h-screen w-screen overflow-hidden">

    <div id="app" class="h-full flex flex-col relative max-w-lg mx-auto bg-white dark:bg-slate-900 shadow-2xl transition-colors duration-300">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-tokyo-600 to-rose-700 text-white px-4 py-3 shadow-md z-30 flex-shrink-0">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-torii-gate text-2xl"></i>
                    <div>
                        <h1 class="text-lg font-bold tracking-wide">æ±äº¬7å¤©6å¤œ</h1>
                        <div class="flex items-center gap-1 text-[10px] opacity-90 font-mono">
                            <span :class="statusColorClass" class="w-2 h-2 rounded-full inline-block"></span>
                            {{ statusText }}
                            <span v-if="lastUpdatedBy" class="ml-1 opacity-75">by {{ lastUpdatedBy }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Right side buttons - å„ªåŒ–é«˜åº¦ä¸€è‡´ -->
                <div class="flex items-center gap-1.5">
                    <!-- Dark mode toggle -->
                    <button @click="toggleDarkMode" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-lg backdrop-blur-sm hover:bg-white/30 transition">
                        <i class="fa-solid fa-moon text-white text-sm" v-if="!isDarkMode"></i>
                        <i class="fa-solid fa-sun text-white text-sm" v-else></i>
                    </button>
                    
                    <!-- Identify User -->
                    <button @click="handleIdentityClick" class="h-8 px-3 bg-white/20 rounded-lg backdrop-blur-sm flex items-center gap-1.5 hover:bg-white/30 transition text-xs min-w-[70px] justify-center">
                        <i class="fa-solid fa-user-circle text-sm"></i> 
                        <span class="truncate max-w-[50px]">{{ currentUser }}</span>
                    </button>
                    
                    <!-- Token Settings -->
                    <button @click="showTokenModal = true" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-lg backdrop-blur-sm hover:bg-white/30 transition">
                        <i class="fa-solid fa-key text-white text-sm"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-center text-xs bg-black/10 rounded-lg p-1.5 backdrop-blur-sm">
                <span><i class="fa-regular fa-clock mr-1"></i>æ›´æ–°: {{ formattedLastUpdate }}</span>
                <button @click="forceSync" class="hover:text-yellow-300 transition" :disabled="syncStatus === 'syncing' || !hasToken">
                    <i class="fa-solid fa-rotate" :class="{'status-syncing': syncStatus === 'syncing'}"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50 dark:bg-slate-900">
            
            <!-- Loading Overlay -->
            <div v-if="isInitialLoading" class="absolute inset-0 z-50 bg-white dark:bg-slate-900 flex flex-col items-center justify-center">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-tokyo-600 mb-4"></i>
                <p class="text-gray-500 font-bold">æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è¡Œç¨‹...</p>
            </div>

            <!-- Error Banner -->
            <div v-if="errorMessage" class="bg-red-500 text-white text-xs p-2 text-center">
                {{ errorMessage }}
            </div>
            
            <!-- No Token Warning -->
            <div v-if="!hasToken && !isInitialLoading" class="bg-amber-500 text-white text-xs p-2 text-center">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                è«‹å…ˆè¨­å®š GitHub Token æ‰èƒ½ä½¿ç”¨åŒæ­¥åŠŸèƒ½
                <button @click="showTokenModal = true" class="ml-2 underline font-bold">ç«‹å³è¨­å®š</button>
            </div>

            <!-- 1. Schedule Tab -->
			<div v-show="currentTab === 'schedule'" class="pb-24 animate-fade-in overflow-y-auto h-full">
                <!-- Date Selector -->
                <div class="sticky top-0 z-20 bg-gray-50/95 dark:bg-slate-900/95 backdrop-blur border-b border-gray-200 dark:border-slate-800 px-2 py-3 flex gap-2 overflow-x-auto no-scrollbar shadow-sm">
                    <button v-for="(day, index) in days" :key="index"
                        @click="currentDayIndex = index"
                        :class="['flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all duration-300', 
                                currentDayIndex === index 
                                ? 'bg-tokyo-600 text-white shadow-lg shadow-rose-200 dark:shadow-none scale-105 transform' 
                                : 'bg-white dark:bg-slate-800 text-gray-400 dark:text-gray-500 border border-gray-100 dark:border-slate-700']">
                        <span class="text-[10px] font-bold uppercase tracking-wider">{{ day.week }}</span>
                        <span class="text-lg font-bold font-mono">{{ day.date.split('/')[1] }}</span>
                    </button>
                </div>

                <!-- Action Button -->
                <div class="px-4 mt-4 flex justify-end">
                    <button @click="openEventModal" class="bg-tokyo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg hover:bg-tokyo-700 active:scale-95 transition flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹
                    </button>
                </div>

                <!-- Timeline -->
                <div class="p-4 space-y-5">
                    <div v-if="currentDayEvents.length === 0" class="flex flex-col items-center justify-center py-20 opacity-50">
                        <i class="fa-brands fa-pagelines text-5xl mb-4 text-tokyo-600"></i>
                        <p class="text-sm font-medium">æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
                    </div>

                    <div v-for="(event, idx) in currentDayEvents" :key="event.id" class="relative pl-2 group">
                        <div class="flex gap-4">
                            <!-- Time Column -->
                            <div class="flex flex-col items-center pt-1 w-12 shrink-0">
                                <span class="text-xs font-bold text-gray-500 dark:text-gray-400 font-mono">{{ formatTime(event.time) }}</span>
                                <div class="h-full w-[2px] bg-gray-200 dark:bg-slate-700 my-2 rounded-full relative group-last:bg-transparent">
                                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-3 h-3 rounded-full border-2 border-white dark:border-slate-800 shadow-sm" :class="getCategoryColor(event.category, true)"></div>
                                </div>
                            </div>

                            <!-- Card -->
                            <div @click="editEvent(event)" class="flex-1 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 active:scale-[0.98] transition-transform">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg leading-tight">{{ event.title }}</h3>
                                    <span :class="['text-[10px] px-2 py-1 rounded-full font-bold text-white', getCategoryColor(event.category, true)]">
                                        {{ event.category }}
                                    </span>
                                </div>
                                <div v-if="event.location" class="flex items-start text-xs text-gray-500 dark:text-gray-400 mb-2">
                                    <i class="fa-solid fa-location-dot mt-0.5 mr-1.5 text-tokyo-500"></i>
                                    <span class="line-clamp-1">{{ event.location }}</span>
                                </div>
                                <div v-if="event.note" class="bg-rose-50 dark:bg-slate-700/50 p-2.5 rounded-lg text-xs text-rose-800 dark:text-rose-200 mb-3 whitespace-pre-wrap leading-relaxed border border-rose-100 dark:border-slate-700">
                                    {{ event.note }}
                                </div>
                                <div class="flex gap-2 mt-2 pt-2 border-t border-gray-50 dark:border-slate-700" @click.stop>
                                    <button @click="openMap(event)" class="flex-1 h-10 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-xs font-bold hover:bg-blue-100 transition flex items-center justify-center gap-1">
                                        <i class="fa-solid fa-location-arrow"></i> å°èˆª
                                    </button>
                                    <button @click="editEvent(event)" class="w-10 h-10 rounded-lg bg-gray-50 dark:bg-slate-700 text-gray-400 hover:bg-gray-100 transition flex items-center justify-center">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Expense Tab -->
			<div v-show="currentTab === 'expense'" class="pb-24 animate-fade-in overflow-y-auto h-full">
                 <div class="px-4 mt-4 flex justify-end gap-2">
                    <button @click="showMemberModal = true" class="bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 px-3 py-2 rounded-full text-sm font-bold">
                        <i class="fa-solid fa-users"></i> æˆå“¡
                    </button>
                    <button @click="openExpenseModal" class="bg-tokyo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg hover:bg-tokyo-700 active:scale-95 transition">
                        <i class="fa-solid fa-plus"></i> è¨˜å¸³
                    </button>
                </div>

                <!-- Dashboard -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-5 m-4 rounded-2xl shadow-xl relative overflow-hidden">
                    <div class="flex justify-between items-end mb-4 relative z-10">
                        <div>
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">ç¸½æ”¯å‡º</p>
                            <h2 class="text-3xl font-bold font-mono">Â¥ {{ formatNumber(totalExpense) }}</h2>
                        </div>
                    </div>
                    <!-- Stats Bar -->
                    <div class="flex h-3 rounded-full overflow-hidden bg-slate-700 w-full mb-4">
                        <div v-for="cat in expenseStats" :key="cat.name" :style="{ width: cat.percent + '%', backgroundColor: cat.color }" class="h-full"></div>
                    </div>
                    
                    <!-- è¦–è¦ºåŒ–åœ–è¡¨å€åŸŸ -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <!-- æ¯äººæ”¯å‡ºæ¯”ä¾‹åœ–è¡¨ -->
						<div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm border border-white/10">
							<p class="text-[10px] text-slate-300 font-bold mb-2">æ¯äººæ‡‰ä»˜é‡‘é¡</p>
							<div v-for="member in memberBalances" :key="member.name" class="flex items-center mb-1.5">
								<div class="w-2 h-2 rounded-full mr-2" :style="{backgroundColor: member.color}"></div>
								<span class="text-xs flex-1 truncate">{{ member.name }}</span>
								<span class="text-xs font-mono">Â¥{{ formatNumber(Math.round(member.share)) }}</span>
							</div>
						</div>
                        
                        <!-- åˆ†é¡æ”¯å‡ºé•·æ¢åœ– -->
                        <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm border border-white/10">
                            <p class="text-[10px] text-slate-300 font-bold mb-2">åˆ†é¡æ”¯å‡º</p>
                            <div v-for="cat in expenseStats" :key="cat.name" class="mb-1.5">
                                <div class="flex justify-between text-[10px] mb-0.5">
                                    <span>{{ cat.name }}</span>
                                    <span>{{ cat.percent.toFixed(0) }}%</span>
                                </div>
                                <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                    <div :style="{width: cat.percent+'%', backgroundColor: cat.color}" class="h-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settlement -->
                    <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm border border-white/10">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] text-emerald-400 font-bold">çµç®—å»ºè­°</p>
                            <button @click="clearAllSettlementsPaid" v-if="hasSettlementsPaid" 
                                    class="text-[10px] text-slate-400 hover:text-slate-300 px-2 py-1 rounded hover:bg-white/5 transition-colors">
                                <i class="fa-solid fa-rotate-right mr-1"></i>é‡ç½®
                            </button>
                        </div>
                        <div v-for="(s, i) in settlements" :key="i" class="flex justify-between items-center text-xs py-2 border-b border-white/10 last:border-0">
                            <div class="flex items-center gap-2">
                                <button @click="toggleSettlementPaid(s)" class="w-4 h-4 rounded border flex items-center justify-center transition-all" 
                                        :class="s.paid ? 'bg-emerald-500 border-emerald-500' : 'border-slate-400 hover:border-emerald-400'">
                                    <i v-if="s.paid" class="fa-solid fa-check text-white text-[8px]"></i>
                                </button>
                                <span class="font-bold">{{ s.from }}</span>
                                <i class="fa-solid fa-arrow-right text-slate-500"></i>
                                <span class="font-bold text-emerald-300">{{ s.to }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-mono">Â¥{{ formatNumber(s.amount) }}</span>
                                <span v-if="s.paid" class="text-[10px] text-emerald-400 px-2 py-0.5 bg-emerald-900/30 rounded-full">å·²çµæ¸…</span>
                            </div>
                        </div>
                        <div v-if="settlements.length === 0" class="text-xs text-center text-slate-400 py-2">å¸³ç›®å¹³è¡¡</div>
                    </div>
                </div>

                <!-- List -->
                <div class="px-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æœ€è¿‘æ”¯å‡º</h3>
                    <div v-for="item in sortedExpenses" :key="item.id" class="bg-white dark:bg-slate-800 p-3.5 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 mb-3 flex justify-between items-center group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm" :class="getCategoryColor(item.category, true)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 dark:text-gray-200 text-sm">{{ item.title }}</p>
                                <p class="text-[10px] text-gray-400 dark:text-gray-500 font-medium">
                                    {{ item.date }} â€¢ <span class="text-tokyo-600 dark:text-tokyo-400">{{ item.payer }}</span> å…ˆä»˜
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-800 dark:text-gray-200 font-mono">Â¥{{ formatNumber(item.amount) }}</p>
                            <button @click="deleteExpense(item.id)" class="text-[10px] text-red-400 opacity-0 group-hover:opacity-100 px-2 py-1">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Map Tab -->
			<div v-show="currentTab === 'map'" class="absolute inset-0 pb-24">
				<!-- åœ°åœ–è¼‰å…¥ç‹€æ…‹ -->
				<div v-if="mapLoading" class="absolute inset-0 z-10 bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
					<div class="text-center">
						<i class="fa-solid fa-compass fa-spin text-4xl text-tokyo-600 mb-2"></i>
						<p class="text-sm text-gray-600 dark:text-gray-300">è¼‰å…¥åœ°åœ–ä¸­...</p>
					</div>
				</div>
				
				<div id="mapContainer" style="width: 100%; height: 100%;"></div>
				
				<!-- åœ–ä¾‹ - ä¿®æ”¹ç‚ºä½¿ç”¨å…§è¯æ¨£å¼ç¢ºä¿é¡è‰²ä¸€è‡´ -->
				<div class="absolute top-4 right-4 bg-white/90 dark:bg-slate-900/90 backdrop-blur p-2 rounded-lg shadow-lg z-[400] text-[10px] flex flex-col gap-1">
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full" style="background-color: #f43f5e"></div>æ™¯é»</div>
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full" style="background-color: #f97316"></div>ç¾é£Ÿ</div>
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full" style="background-color: #3b82f6"></div>äº¤é€š</div>
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full" style="background-color: #8b5cf6"></div>ä½å®¿</div>
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full" style="background-color: #10b981"></div>è³¼ç‰©</div>
				</div>
				
				<!-- Map Card -->
				<div v-if="mapSelectedEvent" class="absolute bottom-28 left-4 right-4 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-2xl z-[500] border border-gray-100 dark:border-slate-700 animate-slide-up max-h-48 overflow-y-auto">
					<div class="flex justify-between items-start mb-2">
						<h3 class="font-bold text-lg text-gray-800 dark:text-white">{{ mapSelectedEvent.title }}</h3>
						<button @click="mapSelectedEvent = null" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-xmark"></i></button>
					</div>
					<p class="text-xs text-gray-500 mb-4">{{ mapSelectedEvent.location }}</p>
					<a :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapSelectedEvent.location)}`" target="_blank"
					   class="block w-full text-center bg-tokyo-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg">é–‹å•Ÿ Google Maps</a>
				</div>
				
				<!-- åœ°åœ–æ§åˆ¶æŒ‰éˆ• -->
				<div class="absolute bottom-28 right-4 z-[450] flex flex-col gap-2">
					<button @click="resetMapView" class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors">
						<i class="fa-solid fa-earth-asia text-gray-600 dark:text-gray-300"></i>
					</button>
				</div>
			</div>

            <!-- 4. Packing Tab (è¡Œææ¸…å–®åˆ†é ) -->
			<div v-show="currentTab === 'packing'" class="pb-24 animate-fade-in overflow-y-auto h-full">
                <!-- é€²åº¦æ¢ -->
				<div class="bg-white dark:bg-slate-800 p-4 m-4 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700">
					<div class="flex justify-between items-center mb-2">
						<h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 flex items-center">
							<i class="fa-solid fa-suitcase-rolling mr-2 text-tokyo-500"></i> è¡Œææ¸…å–® ({{ currentUser }})
						</h3>
						<span class="text-sm font-bold text-tokyo-600 dark:text-tokyo-400">{{ packedCount }}/{{ packingList.length }} ({{ packedPercentage }}%)</span>
					</div>
					<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
						<div class="bg-tokyo-600 h-2.5 rounded-full transition-all duration-500" :style="{ width: packedPercentage + '%' }"></div>
					</div>
				</div>

				<!-- æŒ‰éˆ•å€åŸŸ -->
				<div class="px-4 mt-4 flex justify-between">
					<button @click="clearAllPackingChecks" class="bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 px-4 py-2 rounded-full text-sm font-bold shadow hover:bg-gray-200 dark:hover:bg-slate-700 transition flex items-center gap-2">
						<i class="fa-solid fa-square-check"></i> å–æ¶ˆå…¨é¸
					</button>
					<button @click="openPackingModal()" class="bg-tokyo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg hover:bg-tokyo-700 active:scale-95 transition flex items-center gap-2">
						<i class="fa-solid fa-plus"></i> æ–°å¢ç‰©å“
					</button>
				</div>

                <!-- è¡Œæåˆ†çµ„ -->
                <div class="p-4 space-y-6">
                    <div v-if="packingList.length === 0" class="text-center py-10 text-gray-500 dark:text-gray-400">
                        <p>æ¸…å–®æ˜¯ç©ºçš„...</p>
                        <button @click="resetPackingList" class="mt-2 text-tokyo-500 underline text-sm">è¼‰å…¥é è¨­æ¸…å–®</button>
                    </div>

                    <div v-for="(group, type) in groupedPackingList" :key="type" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden border border-gray-100 dark:border-slate-700">
                        <div class="bg-gray-100 dark:bg-slate-700/50 px-4 py-3 font-bold text-gray-700 dark:text-gray-200 flex justify-between items-center border-b border-gray-100 dark:border-slate-700">
                            <span><i :class="getCarryTypeIcon(type)" class="mr-2 text-gray-500 dark:text-gray-400"></i> {{ type }}</span>
                            <span class="text-xs bg-gray-200 dark:bg-slate-600 px-2 py-0.5 rounded-full text-gray-600 dark:text-gray-300">{{ group.filter(i => i.checked).length }}/{{ group.length }}</span>
                        </div>
                        <!-- ä¿®æ”¹ï¼šåŠ å…¥ packing-sortable-group é¡åˆ¥å’Œ data-group-type -->
                        <div class="divide-y divide-gray-100 dark:divide-slate-700 packing-sortable-group" :data-group-type="type">
                            <!-- ä¿®æ”¹ï¼šåŠ å…¥ data-id å±¬æ€§ -->
                            <div v-for="item in group" :key="item.id" :data-id="item.id" class="p-3 flex items-center transition duration-150 select-none">
								<label class="custom-checkbox flex items-center cursor-pointer mr-3">
									<input type="checkbox" class="hidden" v-model="item.checked" @change="savePackingList">
									<div class="w-6 h-6 border-2 border-gray-300 dark:border-gray-500 rounded-md flex items-center justify-center transition-colors bg-white dark:bg-slate-800">
										<svg class="w-4 h-4 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
									</div>
								</label>
								<div class="flex-grow cursor-pointer" @click="editPackingItem(item)">
									<p :class="['font-medium transition-all text-sm', item.checked ? 'text-gray-400 dark:text-gray-500 line-through' : 'text-gray-800 dark:text-gray-100']">
										{{ item.name }}
										<span v-if="item.quantity > 1" class="text-xs bg-tokyo-100 dark:bg-tokyo-900/30 text-tokyo-800 dark:text-tokyo-300 px-1.5 rounded ml-1 font-bold">x{{ item.quantity }}</span>
									</p>
									<div class="flex flex-wrap gap-1 mt-1">
										<span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300 border border-blue-100 dark:border-blue-900/30">{{ item.category }}</span>
										<span v-if="item.note" class="text-[10px] text-gray-500 dark:text-gray-400 truncate max-w-[150px]"><i class="fa-regular fa-note-sticky mr-0.5"></i>{{ item.note }}</span>
									</div>
								</div>
								<button @click="editPackingItem(item)" class="text-gray-400 hover:text-tokyo-500 p-2"><i class="fa-solid fa-pen"></i></button>
							</div>
                        </div>
                    </div>
                </div>
            </div>
			
			<!-- 5. Shopping & Must-Eat List Tab -->
			<div v-show="currentTab === 'shopping'" class="pb-24 animate-fade-in overflow-y-auto h-full">
				<!-- é€²åº¦çµ±è¨ˆ -->
				<div class="bg-white dark:bg-slate-800 p-4 m-4 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700">
					<div class="flex justify-between items-center mb-2">
						<h3 class="text-lg font-bold text-gray-800 dark:text-gray-100 flex items-center">
							<i class="fa-solid fa-cart-shopping mr-2 text-tokyo-500"></i> è³¼è²·ï¼å¿…åƒæ¸…å–®
						</h3>
						<div class="flex items-center gap-3">
							<span class="text-sm font-bold text-tokyo-600 dark:text-tokyo-400">{{ purchasedCount }}/{{ shoppingList.length }} ({{ purchasedPercentage }}%)</span>
							<div class="relative group">
								<button @click="showShoppingFilter = !showShoppingFilter" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center">
									<i class="fa-solid fa-filter text-sm text-gray-600 dark:text-gray-300"></i>
								</button>
								<div v-if="showShoppingFilter" class="absolute top-full right-0 mt-2 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-gray-200 dark:border-slate-700 z-40 w-48 p-3">
									<p class="text-xs font-bold text-gray-400 mb-2">ç¯©é¸åˆ†é¡</p>
									<div class="space-y-1">
										<label v-for="cat in shoppingCategories" :key="cat" class="flex items-center gap-2 cursor-pointer">
											<input type="checkbox" v-model="activeShoppingCategories" :value="cat" @change="saveShoppingList" class="w-3 h-3 rounded border-gray-300 dark:border-gray-600">
											<span class="text-xs text-gray-700 dark:text-gray-300">{{ cat }}</span>
										</label>
									</div>
									<button @click="activeShoppingCategories = [...shoppingCategories]" class="w-full mt-2 text-xs text-tokyo-600 dark:text-tokyo-400 py-1">å…¨é¸</button>
								</div>
							</div>
						</div>
					</div>
					<div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
						<div class="bg-tokyo-600 h-2.5 rounded-full transition-all duration-500" :style="{ width: purchasedPercentage + '%' }"></div>
					</div>
				</div>

				<!-- åˆ†é¡å°è¦½ -->
				<div class="category-navigation px-4 mb-4">
					<!-- å·¦å´æ»¾å‹•æç¤ºï¼ˆå‹•æ…‹é¡¯ç¤ºï¼‰ -->
					<div 
						class="scroll-gradient-left" 
						:class="{ 'opacity-0': !showLeftGradient }"
						style="transition: opacity 0.3s ease;">
					</div>
					
					<!-- å³å´æ»¾å‹•æç¤ºï¼ˆå‹•æ…‹é¡¯ç¤ºï¼‰ -->
					<div 
						class="scroll-gradient-right" 
						:class="{ 'opacity-0': !showRightGradient }"
						style="transition: opacity 0.3s ease;">
					</div>
					
					<div 
						ref="categoryScroll"
						class="flex gap-2 pb-2 scroll-container overflow-x-auto"
						style="scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;"
						@scroll="handleCategoryScroll"
						@touchstart.passive="handleTouchStart"
						@touchmove.passive="handleTouchMove"
						@touchend="handleTouchEnd"
						@mousedown="isCategoryDragging = true"
						@mousemove="handleMouseMove"
						@mouseup="isCategoryDragging = false"
						@mouseleave="isCategoryDragging = false">
						
						<button 
							v-for="cat in shoppingCategories" 
							:key="cat"
							@click="toggleShoppingCategory(cat)"
							@mousedown="handleCategoryMouseDown"
							:class="[
								'category-button px-4 py-2.5 rounded-full text-sm font-bold transition-all flex-shrink-0 min-w-max select-none',
								activeShoppingCategories.includes(cat) 
									? 'bg-tokyo-600 text-white shadow-md shadow-tokyo-200 dark:shadow-tokyo-900/30' 
									: 'bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700'
							]"
							style="scroll-snap-align: start;">
							{{ cat }}
							<span class="ml-1 text-xs opacity-80 font-normal">
								({{ shoppingList.filter(i => i.category === cat && !i.purchased).length }})
							</span>
						</button>
					</div>
				</div>

				<!-- æŒ‰éˆ•å€åŸŸ -->
				<div class="px-4 mt-4 flex justify-between">
					<div class="flex gap-2">
						<button @click="clearAllShoppingChecks" class="bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 px-4 py-2 rounded-full text-sm font-bold shadow hover:bg-gray-200 dark:hover:bg-slate-700 transition flex items-center gap-2">
							<i class="fa-solid fa-square-check"></i> å–æ¶ˆå…¨é¸
						</button>
						<button @click="toggleViewMode" class="bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 px-4 py-2 rounded-full text-sm font-bold shadow hover:bg-gray-200 dark:hover:bg-slate-700 transition flex items-center gap-2">
							<i class="fa-solid" :class="viewMode === 'grid' ? 'fa-list' : 'fa-grid-2'"></i>
							{{ viewMode === 'grid' ? 'åˆ—è¡¨' : 'ç¶²æ ¼' }}
						</button>
					</div>
					<button @click="openShoppingModal()" class="bg-tokyo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg hover:bg-tokyo-700 active:scale-95 transition flex items-center gap-2">
						<i class="fa-solid fa-plus"></i> æ–°å¢é …ç›®
					</button>
				</div>

				<!-- åœ¨ç¶²æ ¼æª¢è¦–ä¸­é¡¯ç¤ºåœ–ç‰‡ -->
				<div v-if="viewMode === 'grid'" class="p-4">
                    <!-- ä¿®æ”¹ï¼šåŠ å…¥ ID shopping-grid-container -->
					<div id="shopping-grid-container" class="grid grid-cols-2 gap-4">
                        <!-- ä¿®æ”¹ï¼šåŠ å…¥ data-id -->
						<div v-for="item in filteredShoppingList" :key="item.id" :data-id="item.id"
							 @click="editShoppingItem(item)"
							 class="bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden border border-gray-100 dark:border-slate-700 group cursor-pointer hover:shadow-md transition-all duration-300 select-none">
							
							<!-- åœ–ç‰‡å€åŸŸ -->
							<div class="relative h-32 overflow-hidden bg-gray-100 dark:bg-slate-700">
								<!-- å¦‚æœæœ‰åœ–ç‰‡é è¦½ -->
								<div v-if="item.imagePreview" class="w-full h-full">
									<img :src="item.imagePreview" :alt="item.name" class="w-full h-full object-cover">
								</div>
								
								<!-- åªæœ‰æª”åï¼ˆå¾ localStorage è¼‰å…¥ï¼‰ -->
								<div v-else-if="item.imageName" class="w-full h-full flex flex-col items-center justify-center p-4">
									<i class="fa-solid fa-image text-3xl text-tokyo-500 mb-2"></i>
									<p class="text-xs text-center text-gray-600 dark:text-gray-300 line-clamp-2">
										{{ item.imageName }}
									</p>
									<p class="text-[10px] text-gray-400 mt-1">é»æ“Šé‡æ–°é¸æ“‡åœ–ç‰‡</p>
								</div>
								
								<!-- å®Œå…¨æ²’æœ‰åœ–ç‰‡ -->
								<div v-else class="w-full h-full flex items-center justify-center">
									<i class="fa-solid fa-image text-3xl text-gray-300 dark:text-slate-600"></i>
								</div>
								
								<!-- åˆ†é¡æ¨™ç±¤ -->
								<div class="absolute top-2 left-2">
									<span class="text-[10px] px-2 py-1 rounded-full font-bold text-white" 
										  :style="{ backgroundColor: shoppingCategoryColors[item.category] }">
										{{ item.category }}
									</span>
								</div>
								
								<!-- è³¼è²·ç‹€æ…‹ -->
								<button @click.stop="toggleShoppingPurchased(item)" 
										class="absolute top-2 right-2 w-6 h-6 rounded-full bg-white/90 backdrop-blur-sm flex items-center justify-center shadow">
									<i class="fa-solid" :class="item.purchased ? 'fa-check-circle text-emerald-500' : 'fa-circle text-gray-300'"></i>
								</button>
							</div>
							
							<!-- å…§å®¹å€åŸŸ - ä¿®å¾©é€™è£¡ -->
							<div class="p-3">
								<h4 class="font-bold text-gray-800 dark:text-gray-100 text-sm mb-1 line-clamp-1">{{ item.name }}</h4>
								
								<!-- åº—å®¶è³‡è¨Š -->
								<p v-if="item.shop" class="text-xs text-gray-500 dark:text-gray-400 mb-1 line-clamp-1">
									<i class="fa-solid fa-store mr-1"></i>{{ item.shop }}
								</p>
								
								<!-- åœ°é» -->
								<p v-if="item.location" class="text-xs text-gray-500 dark:text-gray-400 mb-1 line-clamp-1">
									<i class="fa-solid fa-location-dot mr-1"></i>{{ item.location }}
								</p>
								
								<!-- å„ªå…ˆåº¦ -->
								<div v-if="item.priority" class="inline-block">
									<span :class="[
										'text-[10px] px-2 py-0.5 rounded-full font-bold',
										item.priority === 'é«˜' ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300' :
										item.priority === 'ä¸­' ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-300' :
										'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300'
									]">
										{{ item.priority }}å„ªå…ˆ
									</span>
								</div>
								
								<!-- å¦‚æœåªæœ‰æª”åï¼Œé¡¯ç¤ºæé†’ -->
								<div v-if="item.imageName && !item.imagePreview" 
									 class="text-xs text-amber-600 dark:text-amber-400 mt-2 flex items-center">
									<i class="fa-solid fa-info-circle mr-1"></i>
									å·²é¸æ“‡åœ–ç‰‡ï¼Œéœ€é‡æ–°ä¸Šå‚³æ‰èƒ½é¡¯ç¤º
								</div>
								
								<!-- å‚™è¨» -->
								<p v-if="item.note" class="text-xs text-gray-400 dark:text-gray-500 mt-2 line-clamp-2">
									{{ item.note }}
								</p>
							</div>
						</div>
					</div>
				</div>
				<!-- åˆ—è¡¨æª¢è¦– -->
                <!-- ä¿®æ”¹ï¼šåŠ å…¥ ID shopping-list-container -->
				<div v-else-if="viewMode === 'list' && filteredShoppingList.length > 0" id="shopping-list-container" class="p-4 space-y-3">
                    <!-- ä¿®æ”¹ï¼šåŠ å…¥ data-id -->
					<div v-for="item in filteredShoppingList" :key="item.id" :data-id="item.id"
						 class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 select-none">
						
						<div class="flex gap-3">
						
						<div class="flex gap-3">
							<!-- åœ–ç‰‡ -->
							<div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 dark:bg-slate-700 flex-shrink-0">
								<!-- å„ªå…ˆä½¿ç”¨ imagePreview -->
								<div v-if="item.imagePreview" class="w-full h-full">
									<img :src="item.imagePreview" :alt="item.name" 
										 @error="handleImageError(item)"
										 class="w-full h-full object-cover">
								</div>
								<!-- å¦‚æœæœ‰ imageIdï¼Œé¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ -->
								<div v-else-if="item.imageId" class="w-full h-full flex items-center justify-center">
									<i class="fa-solid fa-spinner fa-spin text-xl text-tokyo-500"></i>
								</div>
								<!-- å¦‚æœåªæœ‰ imageUrlï¼ˆURLæ ¼å¼ï¼‰ -->
								<div v-else-if="item.imageUrl && item.imageUrl.startsWith('http')" class="w-full h-full">
									<img :src="item.imageUrl" :alt="item.name" class="w-full h-full object-cover">
								</div>
								<!-- å®Œå…¨æ²’æœ‰åœ–ç‰‡ -->
								<div v-else class="w-full h-full flex items-center justify-center">
									<i class="fa-solid fa-image text-xl text-gray-300 dark:text-slate-600"></i>
								</div>
							</div>
							
							<!-- å…§å®¹ - ä¿®å¾©é€™è£¡ -->
							<div class="flex-1 min-w-0">
								<div class="flex justify-between items-start mb-1">
									<h4 class="font-bold text-gray-800 dark:text-gray-100 text-sm line-clamp-1">{{ item.name }}</h4>
									<button @click.stop="toggleShoppingPurchased(item)" 
											class="w-5 h-5 flex-shrink-0 ml-2">
										<i class="fa-solid" :class="item.purchased ? 'fa-check-circle text-emerald-500' : 'fa-circle text-gray-300'"></i>
									</button>
								</div>
								
								<!-- åˆ†é¡å’Œå„ªå…ˆåº¦ -->
								<div class="flex items-center gap-2 mb-1">
									<span class="text-[10px] px-2 py-0.5 rounded-full font-bold text-white" 
										  :style="{ backgroundColor: shoppingCategoryColors[item.category] }">
										{{ item.category }}
									</span>
									
									<span v-if="item.priority" :class="[
										'text-[10px] px-2 py-0.5 rounded-full font-bold',
										item.priority === 'é«˜' ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300' :
										item.priority === 'ä¸­' ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-900/30 dark:text-yellow-300' :
										'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-300'
									]">
										{{ item.priority }}
									</span>
								</div>
								
								<!-- åº—å®¶è³‡è¨Š -->
								<p v-if="item.shop" class="text-xs text-gray-500 dark:text-gray-400 mb-1 line-clamp-1">
									<i class="fa-solid fa-store mr-1"></i>{{ item.shop }}
								</p>
								
								<!-- åœ°é» -->
								<p v-if="item.location" class="text-xs text-gray-500 dark:text-gray-400 mb-1 line-clamp-1">
									<i class="fa-solid fa-location-dot mr-1"></i>{{ item.location }}
								</p>
								
								<!-- å‚™è¨» -->
								<p v-if="item.note" class="text-xs text-gray-400 dark:text-gray-500 line-clamp-2">
									{{ item.note }}
								</p>
								
								<!-- æ“ä½œæŒ‰éˆ• -->
								<div class="flex gap-2 mt-2">
									<button @click.stop="editShoppingItem(item)" 
											class="text-xs text-tokyo-600 dark:text-tokyo-400 hover:text-tokyo-700">
										<i class="fa-solid fa-pen mr-1"></i>ç·¨è¼¯
									</button>
									<button v-if="item.location" @click.stop="() => openShoppingMap(item)" 
											class="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-700">
										<i class="fa-solid fa-map mr-1"></i>åœ°åœ–
									</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- ç©ºç‹€æ…‹ -->
				<div v-if="filteredShoppingList.length === 0" class="text-center py-10 px-4">
					<div class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-slate-800 dark:to-slate-900 rounded-2xl p-8">
						<i class="fa-solid fa-cart-shopping text-4xl text-gray-300 dark:text-slate-600 mb-4"></i>
						<h4 class="text-lg font-bold text-gray-700 dark:text-gray-300 mb-2">æ¸…å–®æ˜¯ç©ºçš„...</h4>
						<p class="text-sm text-gray-500 dark:text-gray-400 mb-4">é–‹å§‹æ–°å¢ä½ æƒ³è³¼è²·çš„ä¼´æ‰‹ç¦®æˆ–å¿…åƒç¾é£Ÿï¼</p>
					</div>
				</div>
			</div>

			<!-- æ–°å¢è³¼ç‰©æ¸…å–®æ¨¡æ…‹çª— -->
			<div v-if="showShoppingModal" class="absolute inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end justify-center p-0 sm:p-4">
			  <div class="bg-white dark:bg-slate-900 w-full sm:w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up border-t border-gray-100 dark:border-slate-800 h-[85vh] sm:max-h-[90vh] flex flex-col">
				<!-- æ‹–æ‹½æŒ‡ç¤ºæ¢ï¼ˆåªåœ¨æ‰‹æ©Ÿä¸Šé¡¯ç¤ºï¼‰ -->
				<div class="w-12 h-1.5 bg-gray-200 dark:bg-slate-700 rounded-full mx-auto mb-4 sm:mb-6 flex-shrink-0"></div>
				
				<!-- æ¨™é¡Œå€åŸŸ -->
				<div class="flex-shrink-0">
				  <h3 class="text-xl font-bold mb-4 sm:mb-6 text-slate-800 dark:text-white flex items-center gap-2">
					<span class="w-1 h-6 bg-tokyo-600 rounded-full inline-block"></span>
					{{ isShoppingEditing ? 'ç·¨è¼¯é …ç›®' : 'æ–°å¢é …ç›®' }}
				  </h3>
				</div>
				
				<!-- å¯æ»¾å‹•çš„è¡¨å–®å€åŸŸ -->
				<form @submit.prevent="saveShoppingItem" class="flex-1 overflow-y-auto space-y-4 pb-4">
				  <!-- åœ–ç‰‡ä¸Šå‚³/é è¦½ -->
				<div class="flex-shrink-0">
					<label class="block text-sm font-bold mb-2">åœ–ç‰‡</label>
					<div class="flex flex-col items-center gap-3">
						<!-- åœ–ç‰‡é è¦½/ä¸Šå‚³å€åŸŸ -->
						<div class="w-full max-w-xs mx-auto">
							<div class="w-full h-48 rounded-xl overflow-hidden bg-gray-100 dark:bg-slate-800 border-2 border-dashed border-gray-300 dark:border-slate-700 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors"
								 @click="triggerImageUpload">
								
								<!-- å¦‚æœæœ‰åœ–ç‰‡é è¦½ -->
								<div v-if="shoppingForm.imagePreview" class="w-full h-full relative">
									<img :src="shoppingForm.imagePreview" :alt="shoppingForm.name || 'ä¸Šå‚³çš„åœ–ç‰‡'" class="w-full h-full object-cover">
									<div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
										<div class="bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full text-sm font-bold text-gray-700 flex items-center gap-2">
											<i class="fa-solid fa-camera"></i>
											<span>æ›´æ›åœ–ç‰‡</span>
										</div>
									</div>
								</div>
								
								<!-- å¾ localStorage è¼‰å…¥æ™‚ï¼ˆåªæœ‰æª”åï¼‰ -->
								<div v-else-if="shoppingForm.imageName" class="text-center p-4">
									<i class="fa-solid fa-image text-4xl text-tokyo-500 mb-3"></i>
									<p class="text-sm font-medium text-gray-600 dark:text-gray-300 line-clamp-1">
										{{ shoppingForm.imageName }}
									</p>
									<p class="text-xs text-gray-400 mt-2">é»æ“Šé‡æ–°é¸æ“‡åœ–ç‰‡</p>
								</div>
								
								<!-- å®Œå…¨æ²’æœ‰åœ–ç‰‡ -->
								<div v-else class="text-center p-4">
									<i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-400 dark:text-gray-600 mb-3"></i>
									<p class="text-sm font-medium text-gray-600 dark:text-gray-300">é»æ“Šä¸Šå‚³åœ–ç‰‡</p>
									<p class="text-xs text-gray-400 mt-1">æ”¯æ´ JPGã€PNG æ ¼å¼</p>
									<p class="text-xs text-gray-400">å»ºè­°å°ºå¯¸ 800x800px</p>
								</div>
							</div>
							
							<!-- åœ–ç‰‡æ“ä½œæŒ‰éˆ•ï¼ˆå¦‚æœæœ‰åœ–ç‰‡ï¼‰ -->
							<div v-if="shoppingForm.imagePreview || shoppingForm.imageName" 
								 class="flex justify-center gap-2 mt-3">
								<button type="button" @click="triggerImageUpload" 
										class="px-3 py-1.5 bg-tokyo-50 dark:bg-tokyo-900/30 text-tokyo-600 dark:text-tokyo-400 rounded-lg text-xs font-bold">
									<i class="fa-solid fa-rotate mr-1"></i>æ›´æ›
								</button>
								<button type="button" @click="clearImage" 
										class="px-3 py-1.5 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg text-xs font-bold">
									<i class="fa-solid fa-trash mr-1"></i>ç§»é™¤
								</button>
							</div>
						</div>
						
						<!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
						<input type="file" ref="imageInput" @change="handleImageUpload" accept="image/*" class="hidden">
						
						<!-- åœ–ç‰‡ä¸Šå‚³æç¤º -->
						<div class="w-full bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/30 rounded-lg p-3">
							<p class="text-xs text-blue-600 dark:text-blue-400 flex items-start gap-2">
								<i class="fa-solid fa-info-circle mt-0.5 flex-shrink-0"></i>
								<span>åœ–ç‰‡æœƒå£“ç¸®å„²å­˜ï¼Œä¸æœƒä¸Šå‚³åˆ°ç¶²è·¯ï¼Œåƒ…ä¿å­˜åœ¨æ‚¨çš„è£ç½®ä¸­</span>
							</p>
						</div>
					</div>
				</div>
				  
				  <!-- åç¨±å’Œåˆ†é¡ - æ”¹ç‚ºéŸ¿æ‡‰å¼å¸ƒå±€ -->
				  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 flex-shrink-0">
					<div>
					  <label class="block text-sm font-bold mb-2">åç¨± *</label>
					  <input v-model="shoppingForm.name" placeholder="ä¾‹ï¼šé›·ç¥å·§å…‹åŠ›" 
							 class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-transparent focus:border-tokyo-500 outline-none font-bold dark:text-white text-sm" required>
					</div>
					<div>
					  <label class="block text-sm font-bold mb-2">åˆ†é¡ *</label>
					  <select v-model="shoppingForm.category" 
							  class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-transparent focus:border-tokyo-500 outline-none font-bold dark:text-white text-sm appearance-none">
						<option v-for="cat in shoppingCategories" :value="cat">{{ cat }}</option>
					  </select>
					</div>
				  </div>
				  
				  <!-- åº—å®¶è³‡è¨Š - æ”¹ç‚ºéŸ¿æ‡‰å¼å¸ƒå±€ -->
				  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 flex-shrink-0">
					<div>
					  <label class="block text-sm font-bold mb-2">åº—å®¶</label>
					  <input v-model="shoppingForm.shop" placeholder="åº—å" 
							 class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-transparent focus:border-tokyo-500 outline-none dark:text-white text-sm">
					</div>
					<div>
					  <label class="block text-sm font-bold mb-2">å„ªå…ˆåº¦</label>
					  <select v-model="shoppingForm.priority" 
							  class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-transparent focus:border-tokyo-500 outline-none dark:text-white text-sm">
						<option value="">ç„¡</option>
						<option value="é«˜">é«˜</option>
						<option value="ä¸­">ä¸­</option>
						<option value="ä½">ä½</option>
					  </select>
					</div>
				  </div>
				  
				  <!-- åœ°é» - å„ªåŒ–æ‰‹æ©Ÿé¡¯ç¤º -->
				  <div class="flex-shrink-0">
					<label class="block text-sm font-bold mb-2">åœ°é»</label>
					<div class="flex flex-col sm:flex-row gap-2">
					  <input v-model="shoppingForm.location" placeholder="åœ°å€æˆ–åœ°æ¨™" 
							 class="flex-1 bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-transparent focus:border-tokyo-500 outline-none dark:text-white text-sm">
					  <button type="button" @click="openShoppingMapModal" 
							  class="mt-2 sm:mt-0 min-w-[60px] h-[48px] bg-gray-100 dark:bg-slate-800 rounded-xl flex items-center justify-center active:scale-95 transition-transform">
						<i class="fa-solid fa-map text-gray-600 dark:text-gray-400 text-lg"></i>
					  </button>
					</div>
					<div v-if="shoppingForm.lat && shoppingForm.lng" class="flex flex-wrap items-center gap-2 mt-2">
					  <span class="text-xs text-emerald-600 dark:text-emerald-400">
						<i class="fa-solid fa-check-circle"></i> å·²è¨­å®šåº§æ¨™
					  </span>
					  <button type="button" @click="clearShoppingLocation" class="text-xs text-red-500 hover:text-red-600">
						<i class="fa-solid fa-trash"></i> æ¸…é™¤
					  </button>
					</div>
				  </div>
				  
				  <!-- å‚™è¨» - èª¿æ•´é«˜åº¦é©æ‡‰æ‰‹æ©Ÿ -->
				  <div class="flex-shrink-0">
					<label class="block text-sm font-bold mb-2">å‚™è¨»</label>
					<textarea v-model="shoppingForm.note" placeholder="å‚™è¨»ã€è³¼è²·åŸå› ..." rows="2" 
							  class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-transparent focus:border-tokyo-500 outline-none resize-none dark:text-white text-sm"></textarea>
				  </div>
				</form>
				
				<!-- æ“ä½œæŒ‰éˆ•ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ -->
				<div class="flex gap-3 mt-4 pt-4 border-t border-gray-100 dark:border-slate-700 flex-shrink-0">
				  <button type="button" @click="showShoppingModal = false" 
						  class="flex-1 py-3 rounded-xl bg-gray-100 dark:bg-slate-800 text-gray-500 dark:text-gray-400 font-bold hover:bg-gray-200 dark:hover:bg-slate-700 transition text-sm">
					å–æ¶ˆ
				  </button>
				  <button v-if="isShoppingEditing" type="button" @click="deleteShoppingItem" 
						  class="w-14 rounded-xl bg-red-50 dark:bg-red-900/20 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/40 flex items-center justify-center transition">
					<i class="fa-solid fa-trash-can"></i>
				  </button>
				  <button type="submit" @click="saveShoppingItem"
						  class="flex-[2] bg-tokyo-600 text-white rounded-xl font-bold py-3 hover:bg-tokyo-700 transition text-sm">
					å„²å­˜
				  </button>
				</div>
			  </div>
			</div>
			<!-- åœ°é»é¸æ“‡æ¨¡æ…‹çª— -->
			<div v-if="showLocationModal" class="absolute inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
				<div class="bg-white dark:bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
					<h3 class="text-xl font-bold mb-4 dark:text-white">é¸æ“‡åœ°é»</h3>
					
					<div class="mb-4">
						<input v-model="locationSearch" @input="searchLocation" 
							   placeholder="æœå°‹åœ°é»..." 
							   class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 dark:text-white">
					</div>
					
					<div class="h-64 overflow-y-auto mb-4">
						<!-- æœå°‹çµæœ -->
						<div v-if="locationSearchResults.length > 0">
							<div v-for="result in locationSearchResults" :key="result.id" 
								 @click="selectLocation(result)"
								 class="p-3 border-b border-gray-100 dark:border-slate-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-800">
								<p class="font-medium dark:text-white">{{ result.name }}</p>
								<p class="text-xs text-gray-500 dark:text-gray-400">{{ result.address }}</p>
							</div>
						</div>
						
						<!-- è¿‘æœŸè¡Œç¨‹åœ°é» -->
						<div v-else>
							<p class="text-sm font-bold text-gray-400 mb-2">è¡Œç¨‹ä¸­çš„åœ°é»</p>
							<!-- ä¿®æ”¹é€™è£¡ï¼šå°‡ event é‡å‘½åç‚º scheduleEvent -->
							<template v-for="event in schedule" :key="event.id">
								<div v-if="event.location"
									 @click="useEventLocation(event)"
									 class="p-3 border-b border-gray-100 dark:border-slate-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-800">
									<p class="font-medium dark:text-white">{{ event.title }}</p>
									<p class="text-xs text-gray-500 dark:text-gray-400">{{ event.location }}</p>
								</div>
							</template>
							<div v-if="schedule.filter(event => event.location).length === 0" class="text-center py-4 text-gray-400">
								æš«ç„¡è¡Œç¨‹åœ°é»
							</div>
						</div>
					</div>
					
					<div class="flex gap-3">
						<button @click="showLocationModal = false" class="flex-1 py-3 bg-gray-100 dark:bg-slate-800 text-gray-500 font-bold rounded-xl">
							å–æ¶ˆ
						</button>
						<button @click="useCurrentLocation" class="flex-1 py-3 bg-blue-500 text-white font-bold rounded-xl">
							ä½¿ç”¨ç›®å‰ä½ç½®
						</button>
					</div>
				</div>
			</div>
		</main>

        <!-- Bottom Nav -->
		<nav class="bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-800 flex justify-around items-center h-[85px] pb-5 px-2 safe-bottom z-30 absolute bottom-0 w-full shadow-lg">
			<!-- è¡Œç¨‹ -->
			<button @click="switchTab('schedule')" :class="['flex flex-col items-center justify-center w-full h-full rounded-xl relative', currentTab === 'schedule' ? 'text-tokyo-600 dark:text-tokyo-400' : 'text-gray-400']">
				<i class="fa-solid fa-calendar-days text-xl mb-1"></i>
				<span class="text-[10px] font-bold">è¡Œç¨‹</span>
			</button>
			
			<!-- åˆ†å¸³ -->
			<button @click="switchTab('expense')" :class="['flex flex-col items-center justify-center w-full h-full rounded-xl relative', currentTab === 'expense' ? 'text-tokyo-600 dark:text-tokyo-400' : 'text-gray-400']">
				<i class="fa-solid fa-wallet text-xl mb-1"></i>
				<span class="text-[10px] font-bold">åˆ†å¸³</span>
			</button>
			
			<!-- åœ°åœ– -->
			<button @click="switchTab('map')" :class="['flex flex-col items-center justify-center w-full h-full rounded-xl relative', currentTab === 'map' ? 'text-tokyo-600 dark:text-tokyo-400' : 'text-gray-400']">
				<i class="fa-solid fa-map-location-dot text-xl mb-1"></i>
				<span class="text-[10px] font-bold">åœ°åœ–</span>
			</button>
			
			<!-- è¡Œæ -->
			<button @click="switchTab('packing')" :class="['flex flex-col items-center justify-center w-full h-full rounded-xl relative', currentTab === 'packing' ? 'text-tokyo-600 dark:text-tokyo-400' : 'text-gray-400']">
				<div class="relative">
					<i class="fa-solid fa-suitcase-rolling text-xl"></i>
					<!-- æ›´å°çš„æ¨™è¨˜ -->
					<div class="absolute -top-1 -right-2 w-3 h-3 bg-tokyo-500 rounded-full flex items-center justify-center">
						<i class="fa-solid fa-user text-[6px] text-white"></i>
					</div>
				</div>
				<span class="text-[10px] font-bold mt-1">è¡Œæ</span>
			</button>

			<!-- è³¼ç‰© -->
			<button @click="switchTab('shopping')" :class="['flex flex-col items-center justify-center w-full h-full rounded-xl relative', currentTab === 'shopping' ? 'text-tokyo-600 dark:text-tokyo-400' : 'text-gray-400']">
				<div class="relative">
					<i class="fa-solid fa-cart-shopping text-xl"></i>
					<!-- æ›´å°çš„æ¨™è¨˜ -->
					<div class="absolute -top-1 -right-2 w-3 h-3 bg-tokyo-500 rounded-full flex items-center justify-center">
						<i class="fa-solid fa-user text-[6px] text-white"></i>
					</div>
				</div>
				<span class="text-[10px] font-bold mt-1">è³¼ç‰©</span>
			</button>
		</nav>

        <!-- Identity Modal (First Load) -->
        <div v-if="showIdentityModal" class="absolute inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <div class="text-center mb-6">
                    <i class="fa-solid fa-user-astronaut text-4xl text-tokyo-600 mb-2"></i>
                    <h3 class="text-xl font-bold">è«‹å•ä½ æ˜¯èª°ï¼Ÿ</h3>
                    <p class="text-xs text-gray-500">é€™æœƒé¡¯ç¤ºåœ¨æœ€å¾Œç·¨è¼¯è€…è³‡è¨Šä¸­</p>
                </div>
                <input v-model="tempIdentity" @keyup.enter="saveIdentity" placeholder="è¼¸å…¥æš±ç¨± (ä¾‹å¦‚: Alice)" class="w-full bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center font-bold text-lg border-2 border-transparent focus:border-tokyo-500 outline-none mb-4 dark:text-white">
                <button @click="saveIdentity" :disabled="!tempIdentity" class="w-full bg-tokyo-600 text-white py-3 rounded-xl font-bold disabled:opacity-50">é–‹å§‹ä½¿ç”¨</button>
            </div>
        </div>
        
        <!-- Token Setup Modal -->
        <div v-if="showTokenModal" class="absolute inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <div class="text-center mb-6">
                    <i class="fa-solid fa-key text-4xl text-tokyo-600 mb-2"></i>
                    <h3 class="text-xl font-bold">GitHub Token è¨­å®š</h3>
                    <p class="text-xs text-gray-500">éœ€è¦ Token æ‰èƒ½åŒæ­¥è³‡æ–™åˆ°é›²ç«¯</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-bold mb-2">GitHub Token</label>
                    <div class="token-input-container">
                        <input 
                            :type="showTokenInput ? 'text' : 'password'" 
                            v-model="tempToken" 
                            placeholder="è¼¸å…¥æ‚¨çš„ GitHub Personal Access Token" 
                            class="w-full bg-gray-50 dark:bg-slate-800 p-4 rounded-xl border-2 border-transparent focus:border-tokyo-500 outline-none dark:text-white pr-10">
                        <i @click="showTokenInput = !showTokenInput" :class="showTokenInput ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                    </div>
                    <p class="token-help">
                        <a href="https://github.com/settings/tokens/new" target="_blank" class="font-bold">å¦‚ä½•å–å¾— Tokenï¼Ÿ</a>
                        éœ€è¦æˆäºˆ gist æ¬Šé™ï¼Œä¸¦å„²å­˜åœ¨æœ¬åœ°ç«¯
                    </p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Gist ID</label>
                    <input v-model="tempGistId" placeholder="è¼¸å…¥ Gist ID" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 dark:text-white">
                    <p class="token-help">é è¨­ç‚ºç¯„ä¾‹ Gist IDï¼Œå¯æ”¹ç‚ºè‡ªå·±çš„</p>
                </div>
                
                <div class="flex gap-3">
                    <button @click="showTokenModal = false" class="px-5 py-3 rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 font-bold flex-1">
                        å–æ¶ˆ
                    </button>
                    <button @click="saveToken" :disabled="!tempToken" class="px-5 py-3 rounded-xl bg-tokyo-600 text-white font-bold flex-1 disabled:opacity-50">
                        å„²å­˜è¨­å®š
                    </button>
                </div>
            </div>
        </div>

        <!-- Event Modal -->
        <div v-if="showEventModal" class="absolute inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="showEventModal = false">
            <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-auto max-h-[90vh] overflow-y-auto animate-slide-up">
                <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-4">
                    <input v-model="eventForm.title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold dark:text-white">
                    <div class="flex gap-2">
                        <input type="time" v-model="eventForm.time" class="w-1/3 bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold text-center dark:text-white">
                        <select v-model="eventForm.category" class="flex-1 bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold dark:text-white">
                            <option value="æ™¯é»">ğŸ—» æ™¯é»</option><option value="ç¾é£Ÿ">ğŸ± ç¾é£Ÿ</option><option value="äº¤é€š">ğŸš„ äº¤é€š</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                        </select>
                    </div>
                    <input v-model="eventForm.location" placeholder="åœ°é» (Google Map)" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 dark:text-white">
                    <textarea v-model="eventForm.note" placeholder="å‚™è¨»..." rows="3" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 resize-none dark:text-white"></textarea>
                </div>
                <div class="flex gap-3 mt-6">
                    <button v-if="isEditing" @click="deleteEvent" class="w-12 h-12 rounded-xl bg-red-50 text-red-500 flex items-center justify-center">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <button @click="showEventModal = false" class="px-5 py-3 rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 font-bold">
                        å–æ¶ˆ
                    </button>
                    <button @click="saveEvent" class="flex-1 bg-tokyo-600 text-white rounded-xl font-bold py-3">
                        å„²å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- Expense Modal -->
        <div v-if="showExpenseModal" class="absolute inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="showExpenseModal = false">
            <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">æ–°å¢æ”¯å‡º</h3>
				<!-- ğŸ‘ˆ åœ¨é€™è£¡åŠ å…¥éŒ¯èª¤è¨Šæ¯é¡¯ç¤º -->
				<div v-if="errorMessage" class="bg-red-500 text-white text-sm p-3 rounded-lg mb-4 flex items-center gap-2 animate-slide-up">
					<i class="fa-solid fa-triangle-exclamation"></i>
					<span>{{ errorMessage }}</span>
				</div>
                <div class="space-y-4">
                    <input v-model="expenseForm.title" placeholder="é …ç›®" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold dark:text-white">
                    
                    <!-- å¿«é€Ÿé‡‘é¡æŒ‰éˆ• -->
                    <div>
                        <p class="text-xs font-bold text-gray-400 mb-2">å¿«é€Ÿé‡‘é¡</p>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button v-for="amt in [500, 1000, 2000, 5000, 10000, 20000]" 
                                    @click="expenseForm.amount = amt"
                                    class="quick-amount-btn px-3 py-2 bg-gray-100 dark:bg-slate-700 rounded-lg text-sm font-mono hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors">
                                Â¥{{ amt.toLocaleString() }}
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-gray-400 font-bold">Â¥</span>
                        <input type="number" 
                               v-model.number="expenseForm.amount" 
                               inputmode="decimal"
                               placeholder="è¼¸å…¥é‡‘é¡"
                               class="w-full bg-gray-50 dark:bg-slate-800 pl-8 p-3 rounded-xl border border-gray-200 dark:border-slate-700 text-xl font-mono font-bold dark:text-white">
                    </div>
                    
                    <select v-model="expenseForm.category" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold dark:text-white">
                         <option value="é¤é£²">ğŸ± é¤é£²</option><option value="äº¤é€š">ğŸš„ äº¤é€š</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option><option value="å…¶ä»–">ğŸ”¹ å…¶ä»–</option>
                    </select>
                    
                    <!-- åˆ†æ”¤æ–¹å¼é¸æ“‡ -->
                    <div>
                        <p class="text-xs font-bold text-gray-400 mb-2">åˆ†æ”¤æ–¹å¼</p>
                        <div class="flex gap-2 mb-3">
                            <button @click="expenseForm.splitMethod = 'equal'" 
                                    :class="['px-3 py-2 rounded-lg text-sm font-bold border', expenseForm.splitMethod === 'equal' ? 'bg-blue-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-gray-500 border-gray-200 dark:border-slate-700']">
                                å¹³å‡åˆ†æ”¤
                            </button>
                            <button @click="expenseForm.splitMethod = 'participants'" 
                                    :class="['px-3 py-2 rounded-lg text-sm font-bold border', expenseForm.splitMethod === 'participants' ? 'bg-blue-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-gray-500 border-gray-200 dark:border-slate-700']">
                                é¸æ“‡åƒèˆ‡è€…
                            </button>
                        </div>
                        
                        <!-- é¸æ“‡åƒèˆ‡è€… -->
                        <div v-if="expenseForm.splitMethod === 'participants'" class="mt-2">
                            <p class="text-xs font-bold text-gray-400 mb-2">åƒèˆ‡è€…</p>
                            <div class="flex flex-wrap gap-2">
                                <button v-for="m in members" :key="m" 
                                        @click="toggleParticipant(m)"
                                        :class="['px-3 py-1.5 rounded-lg text-sm font-bold border', expenseForm.participants.includes(m) ? 'bg-emerald-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-gray-500 border-gray-200 dark:border-slate-700']">
                                    {{ m }}
                                </button>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div>
                        <p class="text-xs font-bold text-gray-400 mb-2">ä»˜æ¬¾äºº</p>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="m in members" :key="m" 
                                    @click="expenseForm.payer = m" 
                                    :class="['px-3 py-2 rounded-lg text-sm font-bold border', expenseForm.payer === m ? 'bg-emerald-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-gray-500 border-gray-200 dark:border-slate-700']">
                                {{ m }}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showExpenseModal = false" class="px-5 py-3 rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 font-bold">
                        å–æ¶ˆ
                    </button>
                    <button @click="saveExpense" class="flex-1 bg-tokyo-600 text-white rounded-xl font-bold py-3">
                        è¨˜å¸³
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Member Modal -->
        <div v-if="showMemberModal" class="absolute inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="showMemberModal = false">
            <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold mb-4 dark:text-white">æ—…ä¼´ç®¡ç†</h3>
                <div class="flex flex-wrap gap-2 mb-4">
                    <div v-for="(m, idx) in members" :key="idx" class="bg-gray-100 dark:bg-slate-800 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 dark:text-white">
                        {{ m }} <button @click="removeMember(idx)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <!-- åŠ å…¥ min-w-0 ç¢ºä¿è¼¸å…¥æ¡†åœ¨çª„è¢å¹•ä¸‹èƒ½æ­£ç¢ºç¸®å° -->
                    <input v-model="newMemberName" placeholder="åå­—" class="flex-1 bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 dark:text-white min-w-0">
                    <!-- åŠ å…¥ flex-shrink-0 é˜²æ­¢æŒ‰éˆ•è¢«æ“ å£“ï¼Œwhitespace-nowrap é˜²æ­¢æ–‡å­—æ›è¡Œ -->
                    <button @click="addMember" class="px-5 bg-slate-800 text-white rounded-xl font-bold flex-shrink-0 whitespace-nowrap">æ–°å¢</button>
                </div>
                <button @click="showMemberModal = false" class="w-full mt-4 py-3 bg-gray-100 dark:bg-slate-800 text-gray-500 font-bold rounded-xl">å®Œæˆ</button>
            </div>
        </div>

        <!-- Packing Modal (è¡Œææ¸…å–®æ¨¡æ…‹çª—) -->
        <div v-if="showPackingModal" class="absolute inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-4">
            <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up border-t border-gray-100 dark:border-slate-800">
                <div class="w-12 h-1.5 bg-gray-200 dark:bg-slate-700 rounded-full mx-auto mb-6"></div>
                <h3 class="text-xl font-bold mb-6 text-slate-800 dark:text-white flex items-center gap-2">
                    <span class="w-1 h-6 bg-tokyo-600 rounded-full inline-block"></span>
                    {{ isEditing ? 'ç·¨è¼¯ç‰©å“' : 'æ–°å¢ç‰©å“' }}
                </h3>
                <form @submit.prevent="savePackingItem" class="space-y-4">
                    <input v-model="packingForm.name" placeholder="ç‰©å“åç¨± (å¦‚: è­·ç…§)" class="w-full bg-gray-50 dark:bg-slate-800 p-3.5 rounded-xl border border-transparent focus:border-tokyo-500 outline-none font-bold dark:text-white transition-all" required>
                    <div class="flex gap-3">
                        <select v-model="packingForm.category" class="flex-1 bg-gray-50 dark:bg-slate-800 p-3.5 rounded-xl border border-transparent focus:border-tokyo-500 outline-none font-bold dark:text-white appearance-none transition-all">
                            <option value="3Cç”¨å“">3Cç”¨å“</option><option value="æ—¥å¸¸ã€é¹½æ´—ç”¨å“">æ—¥å¸¸/ç›¥æ´—</option><option value="è¡£ç‰©é¡">è¡£ç‰©é¡</option><option value="æ–‡ä»¶/è­‰ä»¶">æ–‡ä»¶/è­‰ä»¶</option><option value="è—¥å“">è—¥å“</option><option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                        <input type="number" v-model.number="packingForm.quantity" class="w-20 bg-gray-50 dark:bg-slate-800 p-3.5 rounded-xl border border-transparent focus:border-tokyo-500 outline-none font-bold dark:text-white text-center transition-all" min="1" placeholder="æ•¸é‡">
                    </div>
                    <select v-model="packingForm.carry_type" class="w-full bg-gray-50 dark:bg-slate-800 p-3.5 rounded-xl border border-transparent focus:border-tokyo-500 outline-none font-bold dark:text-white appearance-none transition-all">
                        <option value="æ‰‹æè¡Œæ">ğŸ’ æ‰‹æè¡Œæ (éš¨èº«)</option>
                        <option value="è¨—é‹è¡Œæ">ğŸ§³ è¨—é‹è¡Œæ</option>
                        <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                    </select>
                    <textarea v-model="packingForm.note" placeholder="å‚™è¨»..." rows="2" class="w-full bg-gray-50 dark:bg-slate-800 p-3.5 rounded-xl border border-transparent focus:border-tokyo-500 outline-none resize-none dark:text-white text-sm transition-all"></textarea>
                    
                    <div class="flex gap-3 mt-8">
                        <button type="button" @click="showPackingModal = false" class="flex-1 py-3.5 rounded-xl bg-gray-100 dark:bg-slate-800 text-gray-500 dark:text-gray-400 font-bold hover:bg-gray-200 dark:hover:bg-slate-700 transition">å–æ¶ˆ</button>
                        <button v-if="isEditing" type="button" @click="deletePackingItem" class="w-14 rounded-xl bg-red-50 dark:bg-red-900/20 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/40 flex items-center justify-center transition"><i class="fa-solid fa-trash-can"></i></button>
                        <button type="submit" class="flex-[2] bg-tokyo-600 text-white rounded-xl font-bold py-3.5 hover:bg-tokyo-700 transition">å„²å­˜</button>
                    </div>
                </form>
            </div>
        </div>

		<!-- èº«åˆ†ç¢ºèªæ¨¡æ…‹çª— - ä¿®æ­£ç‰ˆï¼Œç¢ºä¿ currentUser æœ‰å€¼ -->
		<div v-if="showIdentityConfirmModal && currentUser" class="absolute inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
			<div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
				<div class="text-center mb-6">
					<!-- æ ¹æ“šæƒ…å¢ƒé¡¯ç¤ºä¸åŒåœ–æ¨™ -->
					<i v-if="currentUser === 'è¨ªå®¢'" class="fa-solid fa-user-plus text-4xl text-tokyo-600 mb-2"></i>
					<i v-else class="fa-solid fa-user-edit text-4xl text-tokyo-600 mb-2"></i>
					
					<!-- æ ¹æ“šæƒ…å¢ƒé¡¯ç¤ºä¸åŒæ¨™é¡Œ -->
					<h3 class="text-xl font-bold">
						<span v-if="currentUser === 'è¨ªå®¢'">æ­¡è¿ä½¿ç”¨æ±äº¬æ—…éŠåŠ©æ‰‹</span>
						<span v-else>è®Šæ›´èº«åˆ†</span>
					</h3>
					
					<!-- åªæœ‰ç•¶ currentUser ä¸æ˜¯ 'è¨ªå®¢' æ™‚é¡¯ç¤ºç›®å‰èº«åˆ† -->
					<div v-if="currentUser && currentUser !== 'è¨ªå®¢'">
						<p class="text-xs text-gray-500 mt-2">æ‚¨ç›®å‰çš„èº«åˆ†æ˜¯</p>
						<p class="text-lg font-bold text-tokyo-600 mt-1">{{ currentUser }}</p>
					</div>
					
					<p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
						<span v-if="currentUser === 'è¨ªå®¢'">è«‹è¨­å®šæ‚¨çš„æš±ç¨±ï¼Œæ–¹ä¾¿æ—…ä¼´è­˜åˆ¥æ‚¨çš„ç·¨è¼¯è¨˜éŒ„</span>
						<span v-else>è«‹è¼¸å…¥æ–°çš„æš±ç¨±</span>
					</p>
				</div>
				
				<div class="space-y-4">
					<!-- æ ¹æ“šæƒ…å¢ƒé¡¯ç¤ºä¸åŒè¼¸å…¥æç¤º -->
					<input v-model="tempIdentity" 
						   @keyup.enter="saveIdentity" 
						   :placeholder="currentUser === 'è¨ªå®¢' ? 'ä¾‹å¦‚ï¼šå°æ˜ã€Aliceã€æ—…è¡Œå°ç·¨...' : 'è¼¸å…¥æ–°çš„æš±ç¨±'"
						   class="w-full bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center font-bold text-lg border-2 border-transparent focus:border-tokyo-500 outline-none dark:text-white">
					
					<!-- åˆæ¬¡ä½¿ç”¨æç¤º -->
					<div v-if="currentUser === 'è¨ªå®¢'" class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
						<p class="text-xs text-blue-600 dark:text-blue-400">
							<i class="fa-solid fa-info-circle mr-1"></i>
							è¨­å®šå¾Œï¼Œæ‚¨çš„ç·¨è¼¯è¨˜éŒ„æœƒé¡¯ç¤ºé€™å€‹æš±ç¨±ï¼Œæ–¹ä¾¿æ—…ä¼´å”ä½œ
						</p>
					</div>
				</div>
				
				<div class="flex gap-3 mt-6">
					<!-- åˆæ¬¡ä½¿ç”¨æ™‚ä¸é¡¯ç¤ºå–æ¶ˆæŒ‰éˆ• -->
					<button v-if="currentUser && currentUser !== 'è¨ªå®¢'" 
							@click="cancelIdentityChange" 
							class="flex-1 px-5 py-3 rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 font-bold">
						å–æ¶ˆ
					</button>
					
					<!-- æ ¹æ“šæƒ…å¢ƒé¡¯ç¤ºä¸åŒæŒ‰éˆ•æ–‡å­— -->
					<button @click="saveIdentity" 
							:disabled="!tempIdentity" 
							:class="[(!currentUser || currentUser === 'è¨ªå®¢') ? 'w-full' : 'flex-1', 'px-5 py-3 bg-tokyo-600 text-white rounded-xl font-bold disabled:opacity-50']">
						<span v-if="!currentUser || currentUser === 'è¨ªå®¢'">é–‹å§‹ä½¿ç”¨</span>
						<span v-else>ç¢ºèªè®Šæ›´</span>
					</button>
				</div>
			</div>
		</div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch, onBeforeUnmount } = Vue;

        // ==========================================
        // é è¨­ Gist ID (ç¯„ä¾‹è³‡æ–™)
        // ==========================================
        const DEFAULT_GIST_ID = 'df4aba5cee34ffcce2af18ab3de7ccda'; 
        const GIST_FILENAME = 'tokyo_trip_data.json';
        const POLL_INTERVAL = 5000; // 5ç§’æª¢æŸ¥ä¸€æ¬¡

        // é è¨­è¡Œææ¸…å–®
        const DEFAULT_PACKING_LIST = [			
			{ name: "è¡Œå‹•é›»æº", category: "3Cç”¨å“", carry_type: "æ‰‹æè¡Œæ", quantity: 1, checked: false },
			{ name: "å……é›»ç·š(æ‰‹æ©Ÿã€å…¶ä»–3Cç”¨å“)", category: "3Cç”¨å“", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "è‡ªæ‹æ£’", category: "3Cç”¨å“", carry_type: "æ‰‹æè¡Œæ", quantity: 1, checked: false },
			{ name: "æ‰‹æ©Ÿ", category: "3Cç”¨å“", carry_type: "æ‰‹æè¡Œæ", quantity: 1, checked: false },
			{ name: "è€³æ©Ÿ", category: "3Cç”¨å“", carry_type: "æ‰‹æè¡Œæ", quantity: 1, checked: false },
			{ name: "eSIMå¡/æ‰‹æ©Ÿæ¼«éŠ/ä¸Šç¶²å¡", category: "3Cç”¨å“", carry_type: "æ‰‹æè¡Œæ", quantity: 1, checked: false },
			{ name: "è­·å”‡è†", category: "æ—¥å¸¸ã€é¹½æ´—ç”¨å“", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "ç‰™ç·š", category: "æ—¥å¸¸ã€é¹½æ´—ç”¨å“", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "æ¸…æ½”ç”¨å“(ç‰™åˆ·/ç‰™è†/æ¯›å·¾)", category: "æ—¥å¸¸ã€é¹½æ´—ç”¨å“", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "ä¿é¤Šå“(ä¹³æ¶²/åŒ–å¦æ£‰/æ½”è†šæ°´)", category: "æ—¥å¸¸ã€é¹½æ´—ç”¨å“", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "é˜²æ›¬ä¹³/é˜²èšŠæ¶²/é˜²èšŠè²¼ç´™", category: "æ—¥å¸¸ã€é¹½æ´—ç”¨å“", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "è¡›ç”Ÿç´™/æ¿•ç´™å·¾/æ‰‹å¸•", category: "æ—¥å¸¸ã€é¹½æ´—ç”¨å“", carry_type: "æ‰‹æè¡Œæ", quantity: 1, checked: false },
			{ name: "å£ç½©", category: "æ—¥å¸¸ã€é¹½æ´—ç”¨å“", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "åˆ®é¬åˆ€", category: "æ—¥å¸¸ã€é¹½æ´—ç”¨å“", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "ä¸Šè¡£", category: "è¡£ç‰©é¡", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "è¤²å­", category: "è¡£ç‰©é¡", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "æ‹–é‹", category: "è¡£ç‰©é¡", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "å…æ´—è¤²/å…æ´—å…§è¡£", category: "è¡£ç‰©é¡", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
			{ name: "é«®åœˆ", category: "è¡£ç‰©é¡", carry_type: "è¨—é‹è¡Œæ", quantity: 1, checked: false },
		];

        createApp({
            setup() {
				// æ–°å¢ï¼šåœ°åœ–åŠ è¼‰ç‹€æ…‹
				const mapLoading = ref(false);
				// åœ¨ setup ä¸­æ–°å¢ä¸€å€‹ ref ä¾†å„²å­˜è·³å‹•çš„æ¨™è¨˜ ID
				const bouncingMarkerId = ref(null);
                
                // å®šç¾©çµ±ä¸€çš„é¡è‰²æ˜ å°„ - ä½¿ç”¨æ–¹æ¡ˆä¸‰
                const categoryColorMap = {
                    'æ™¯é»': '#f43f5e',  // rose-500
                    'ç¾é£Ÿ': '#f97316',  // orange-500
                    'äº¤é€š': '#3b82f6',  // blue-500
                    'ä½å®¿': '#8b5cf6',  // purple-500
                    'è³¼ç‰©': '#10b981'   // emerald-500
                };
                
                // --- Sync State ---
                const syncStatus = ref('idle'); // idle, syncing, error, offline
                const lastUpdated = ref(null);
                const lastUpdatedBy = ref('');
                const currentUser = ref('');
                const isInitialLoading = ref(true);
                const errorMessage = ref('');
                
                // --- Token Management ---
                const githubToken = ref(localStorage.getItem('tokyo_github_token') || '');
                const gistId = ref(localStorage.getItem('tokyo_gist_id') || DEFAULT_GIST_ID);
                const hasToken = computed(() => !!githubToken.value);
                const showTokenModal = ref(false);
                const tempToken = ref('');
                const tempGistId = ref('');
                const showTokenInput = ref(false);

                // --- Dark Mode State ---
                const isDarkMode = ref(localStorage.getItem('tokyo_dark_mode') === 'true' || window.matchMedia('(prefers-color-scheme: dark)').matches);

                // --- App State ---
                const currentTab = ref('schedule');
                const currentDayIndex = ref(0);
                const days = [
                    { date: '12/18', week: 'é€±å››' }, { date: '12/19', week: 'é€±äº”' },
                    { date: '12/20', week: 'é€±å…­' }, { date: '12/21', week: 'é€±æ—¥' },
                    { date: '12/22', week: 'é€±ä¸€' }, { date: '12/23', week: 'é€±äºŒ' },
                    { date: '12/24', week: 'é€±ä¸‰' }
                ];
				
				const imageStore = localforage.createInstance({
				  name: 'tokyo_trip_images',
				  storeName: 'shopping_images'
				});

                // Data Containers
                const schedule = ref([]);
                const expenses = ref([]);
                const members = ref(['æˆ‘', 'æ—…ä¼´A']);
                
                // è¡Œææ¸…å–® State (æ–°åŠŸèƒ½)
                const packingList = ref([]);
                
                // æ–°å¢ï¼šåˆ†å¸³ç‹€æ…‹è¿½è¹¤
                const settlementsPaid = ref({});

                // Forms & Modals
                const showEventModal = ref(false);
                const showExpenseModal = ref(false);
                const showMemberModal = ref(false);
                const showIdentityModal = ref(!localStorage.getItem('tokyo_user_identity'));
                const showIdentityConfirmModal = ref(false); // æ–°å¢ï¼šèº«åˆ†ç¢ºèªæ¨¡æ…‹çª—
                const showPackingModal = ref(false); // æ–°å¢è¡Œæ Modal
                const isEditing = ref(false);
                const eventForm = ref({});
                const expenseForm = ref({ 
                    title: '', 
                    amount: '', 
                    payer: '', 
                    category: 'é¤é£²',
                    splitMethod: 'equal', // equal, participants, custom
                    participants: [],
                    customSplits: {}
                });
                const packingForm = ref({}); // æ–°å¢è¡Œæ Form
                const newMemberName = ref('');
                const tempIdentity = ref('');

                // Map
                const mapInstance = ref(null);
                const mapMarkers = ref([]);
                const mapSelectedEvent = ref(null);
				const highlightedLocation = ref(null);
				// æ–°å¢ï¼šåœ°åœ–ä¸­å¿ƒé»è¨˜æ†¶
				const mapCenter = ref([35.6895, 139.6917]);
				const mapZoom = ref(11);
				// æ–°å¢ï¼šé˜²æ­¢åœ°åœ–é‡è¤‡åˆå§‹åŒ–çš„æ¨™èªŒ
				const mapInitialized = ref(false);
				// æ–°å¢ï¼šè¿½è¹¤åœ°åœ–ç¸®æ”¾ç‹€æ…‹
				const isMapZooming = ref(false);

                // --- è¡Œææ¸…å–®é‚è¼¯ (LocalStorage) ---
                const getPackingListKey = () => `tokyo_packing_list_${currentUser.value}`; // ç¶å®šä½¿ç”¨è€…æš±ç¨±
				
				// æ–°å¢ï¼šä¸€éµå–æ¶ˆæ‰€æœ‰å‹¾é¸
				const clearAllPackingChecks = () => {
					if (packingList.value.length === 0) return;
					
					if (confirm(`ç¢ºå®šè¦å–æ¶ˆæ‰€æœ‰ ${packingList.value.length} å€‹é …ç›®çš„å‹¾é¸å—ï¼Ÿ`)) {
						packingList.value.forEach(item => {
							item.checked = false;
						});
						savePackingList();
					}
				};

                const loadPackingList = () => {
                    const key = getPackingListKey();
                    const saved = localStorage.getItem(key);
                    if (saved) {
                        packingList.value = JSON.parse(saved);
                    } else {
                        // è¼‰å…¥é è¨­å€¼ä¸¦ç”Ÿæˆ ID
                        packingList.value = DEFAULT_PACKING_LIST.map(item => ({
                            ...item,
                            id: Date.now() + Math.random().toString(36).substr(2, 9),
                            note: ''
                        }));
                        savePackingList();
                    }
                };

                const savePackingList = () => {
                    localStorage.setItem(getPackingListKey(), JSON.stringify(packingList.value));
                };

                const resetPackingList = () => {
                    if(confirm("ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­æ¸…å–®å—ï¼Ÿç›®å‰çš„ä¿®æ”¹å°‡æœƒéºå¤±ã€‚")) {
                        localStorage.removeItem(getPackingListKey());
                        loadPackingList();
                    }
                };

                const groupedPackingList = computed(() => {
					// å®šç¾©å›ºå®šçš„åˆ†çµ„é †åº
					const groupOrder = ['æ‰‹æè¡Œæ', 'è¨—é‹è¡Œæ', 'å…¶ä»–'];
					const groups = {};
					
					// åˆå§‹åŒ–æ‰€æœ‰åˆ†çµ„
					groupOrder.forEach(type => {
						groups[type] = [];
					});
					
					// å¡«å……é …ç›®åˆ°å°æ‡‰åˆ†çµ„
					packingList.value.forEach(item => {
						const type = item.carry_type || 'å…¶ä»–';
						if (groups[type]) {
							groups[type].push(item);
						}
					});
					
					return groups;
				});

                const packedCount = computed(() => packingList.value.filter(i => i.checked).length);
                const packedPercentage = computed(() => packingList.value.length ? Math.round((packedCount.value / packingList.value.length) * 100) : 0);

                const getCarryTypeIcon = (type) => {
                    if (type.includes('æ‰‹æ')) return 'fa-solid fa-suitcase';
                    if (type.includes('è¨—é‹')) return 'fa-solid fa-cart-flatbed-suitcase';
                    return 'fa-solid fa-box-open';
                };

                // è¡Œæ CRUD
                const openPackingModal = () => { 
                    isEditing.value = false; 
                    packingForm.value = { id: null, name: '', category: 'å…¶ä»–', carry_type: 'è¨—é‹è¡Œæ', quantity: 1, note: '' }; 
                    showPackingModal.value = true; 
                };
                const editPackingItem = (item) => { 
                    isEditing.value = true; 
                    packingForm.value = { ...item }; 
                    showPackingModal.value = true; 
                };
                const savePackingItem = () => {
                    if (!packingForm.value.name) return;
                    if (isEditing.value) {
                        const idx = packingList.value.findIndex(i => i.id === packingForm.value.id);
                        if (idx !== -1) packingList.value[idx] = { ...packingList.value[idx], ...packingForm.value };
                    } else {
                        packingList.value.push({ ...packingForm.value, id: Date.now().toString(), checked: false });
                    }
                    savePackingList();
                    showPackingModal.value = false;
                };
                const deletePackingItem = () => {
                    if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç‰©å“ï¼Ÿ")) {
                        packingList.value = packingList.value.filter(i => i.id !== packingForm.value.id);
                        savePackingList();
                        showPackingModal.value = false;
                    }
                };

                // --- èº«åˆ†ç®¡ç†å‡½æ•¸ ---
                const handleIdentityClick = () => {
                    if (currentUser.value === 'è¨ªå®¢' || !localStorage.getItem('tokyo_user_identity')) {
                        // å¦‚æœæ²’æœ‰è¨­å®šéèº«åˆ†ï¼Œç›´æ¥æ‰“é–‹è¨­å®šè¦–çª—
                        showIdentityModal.value = true;
                        tempIdentity.value = '';
                    } else {
                        // å¦‚æœå·²ç¶“æœ‰èº«åˆ†ï¼Œæ‰“é–‹ç¢ºèª/ä¿®æ”¹è¦–çª—
                        tempIdentity.value = currentUser.value;
                        showIdentityConfirmModal.value = true;
                    }
                };
                
                const saveIdentity = () => {
                    if (tempIdentity.value.trim()) {
                        currentUser.value = tempIdentity.value.trim();
                        localStorage.setItem('tokyo_user_identity', currentUser.value);
                        
                        // é—œé–‰æ¨¡æ…‹çª—
                        showIdentityModal.value = false;
                        showIdentityConfirmModal.value = false;
                        tempIdentity.value = '';
                        
                        // å¦‚æœæœ‰ tokenï¼Œæ›´æ–°è³‡æ–™ä»¥åæ˜ æ–°çš„ç·¨è¼¯è€…
                        if (hasToken.value) {
                            saveData();
                        }
                        
                        // é‡æ–°è¼‰å…¥è¡Œææ¸…å–®ï¼ˆä½¿ç”¨æ–°çš„ä½¿ç”¨è€…èº«åˆ†ï¼‰
                        loadPackingList();
                    }
                };
     
                const cancelIdentityChange = () => {
                    showIdentityConfirmModal.value = false;
                    tempIdentity.value = '';
                };

                // --- Token Functions ---
                const saveToken = () => {
                    if (tempToken.value) {
                        githubToken.value = tempToken.value;
                        localStorage.setItem('tokyo_github_token', tempToken.value);
                        
                        if (tempGistId.value) {
                            gistId.value = tempGistId.value;
                            localStorage.setItem('tokyo_gist_id', tempGistId.value);
                        }
                        
                        showTokenModal.value = false;
                        tempToken.value = '';
                        tempGistId.value = '';
                        
                        // è¼‰å…¥è³‡æ–™
                        loadData();
                    }
                };
                
                const clearToken = () => {
                    if (confirm('ç¢ºå®šè¦æ¸…é™¤ Token å—ï¼Ÿé€™æœƒåœæ­¢åŒæ­¥åŠŸèƒ½ã€‚')) {
                        localStorage.removeItem('tokyo_github_token');
                        githubToken.value = '';
                        syncStatus.value = 'error';
                        errorMessage.value = 'Token å·²æ¸…é™¤ï¼Œè«‹é‡æ–°è¨­å®šä»¥å•Ÿç”¨åŒæ­¥åŠŸèƒ½';
                    }
                };

                // --- Dark Mode Functions ---
                const toggleDarkMode = () => {
                    isDarkMode.value = !isDarkMode.value;
                    if (isDarkMode.value) {
                        document.documentElement.classList.replace('light', 'dark');
                    } else {
                        document.documentElement.classList.replace('dark', 'light');
                    }
                    localStorage.setItem('tokyo_dark_mode', isDarkMode.value);
                };

                // --- API Service ---
                const fetchGistData = async () => {
                    if (!gistId.value) return null;
                    try {
                        const response = await fetch(`https://api.github.com/gists/${gistId.value}`);
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        const content = JSON.parse(data.files[GIST_FILENAME].content);
                        return content;
                    } catch (error) {
                        console.error('Fetch error:', error);
                        syncStatus.value = 'error';
                        if (!hasToken.value) {
                            errorMessage.value = 'è«‹å…ˆè¨­å®š GitHub Token';
                        } else {
                            errorMessage.value = 'è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Gist ID å’Œ Token æ˜¯å¦æ­£ç¢º';
                        }
                        return null;
                    }
                };
				
				const shoppingList = ref([]);
				const showShoppingModal = ref(false);
				const isShoppingEditing = ref(false);
				const shoppingForm = ref({});
				const viewMode = ref('grid'); // 'grid' æˆ– 'list'
				const showShoppingFilter = ref(false);
				const activeShoppingCategories = ref([]);
				const showLocationModal = ref(false);
				const locationSearch = ref('');
				const locationSearchResults = ref([]);

				// è³¼ç‰©æ¸…å–®åˆ†é¡å’Œé¡è‰²
				const shoppingCategories = ['ä¼´æ‰‹ç¦®', 'è—¥å¦', 'ç¾é£Ÿ', 'ä¾¿åˆ©å•†åº—', 'æœé£¾', 'é›»å™¨', 'å…¶ä»–'];
				const shoppingCategoryColors = {
					'ä¼´æ‰‹ç¦®': '#f43f5e',
					'è—¥å¦': '#8b5cf6',
					'ç¾é£Ÿ': '#f97316',
					'ä¾¿åˆ©å•†åº—': '#10b981',
					'æœé£¾': '#3b82f6',
					'é›»å™¨': '#06b6d4',
					'å…¶ä»–': '#64748b'
				};

				// é è¨­è³¼ç‰©æ¸…å–®é …ç›®
				const DEFAULT_SHOPPING_LIST = [];

				// --- è³¼ç‰©æ¸…å–® LocalStorage ç®¡ç† ---
				const getShoppingListKey = () => `tokyo_shopping_list_${currentUser.value}`;

				const loadShoppingList = async () => {
				  const key = getShoppingListKey();
				  const saved = localStorage.getItem(key);
				  if (saved) {
					shoppingList.value = JSON.parse(saved);
					
					// å˜—è©¦ç‚ºæ¯å€‹é …ç›®è¼‰å…¥åœ–ç‰‡
					await enhanceShoppingListWithImages();
				  } else {
					shoppingList.value = DEFAULT_SHOPPING_LIST;
					saveShoppingList();
				  }
				  
				  // åˆå§‹åŒ–ç¯©é¸åˆ†é¡
				  activeShoppingCategories.value = [...shoppingCategories];
				};
				
				// æ–°å¢ï¼šè¼‰å…¥æ‰€æœ‰è³¼ç‰©æ¸…å–®é …ç›®çš„åœ–ç‰‡
				const loadAllShoppingImages = async () => {
				  for (const item of shoppingList.value) {
					// è·³éå·²æœ‰ imagePreview çš„é …ç›®
					if (item.imagePreview && item.imagePreview.startsWith('blob:')) {
					  continue;
					}
					
					// å¾ IndexedDB è¼‰å…¥å£“ç¸®åœ–ç‰‡
					if (item.imageId) {
					  try {
						const imageUrl = await loadShoppingItemImage(item);
						if (imageUrl) {
						  item.imagePreview = imageUrl;
						}
					  } catch (error) {
						console.error('è¼‰å…¥åœ–ç‰‡å¤±æ•—:', error, item);
					  }
					}
				  }
				};
				const saveShoppingList = () => {
					localStorage.setItem(getShoppingListKey(), JSON.stringify(shoppingList.value));
				};

				const resetShoppingList = () => {
					if(confirm("ç¢ºå®šè¦é‡ç½®ç‚ºç¯„ä¾‹æ¸…å–®å—ï¼Ÿç›®å‰çš„ä¿®æ”¹å°‡æœƒéºå¤±ã€‚")) {
						localStorage.removeItem(getShoppingListKey());
						loadShoppingList();
					}
				};

				// --- è³¼ç‰©æ¸…å–®è¨ˆç®—å±¬æ€§ ---
				const purchasedCount = computed(() => shoppingList.value.filter(i => i.purchased).length);
				const purchasedPercentage = computed(() => shoppingList.value.length ? Math.round((purchasedCount.value / shoppingList.value.length) * 100) : 0);

				const filteredShoppingList = computed(() => {
					return shoppingList.value.filter(item => 
						activeShoppingCategories.value.includes(item.category)
					).sort((a, b) => {
						// æœªè³¼è²·çš„æ’å‰é¢ï¼Œç„¶å¾ŒæŒ‰å„ªå…ˆåº¦æ’åº
						if (a.purchased !== b.purchased) return a.purchased ? 1 : -1;
						
						const priorityOrder = { 'é«˜': 1, 'ä¸­': 2, 'ä½': 3, '': 4 };
						return priorityOrder[a.priority] - priorityOrder[b.priority];
					});
				});

				// --- è³¼ç‰©æ¸…å–®æ“ä½œå‡½æ•¸ ---
				const toggleShoppingCategory = (category) => {
					const index = activeShoppingCategories.value.indexOf(category);
					if (index === -1) {
						activeShoppingCategories.value.push(category);
					} else {
						activeShoppingCategories.value.splice(index, 1);
					}
					saveShoppingList();
					
					// æ»¾å‹•åˆ°é¸ä¸­çš„åˆ†é¡
					scrollToCategory(category);
				};

				const toggleViewMode = () => {
					viewMode.value = viewMode.value === 'grid' ? 'list' : 'grid';
				};

				const clearAllShoppingChecks = () => {
					if (shoppingList.value.length === 0) return;
					
					if (confirm(`ç¢ºå®šè¦å–æ¶ˆæ‰€æœ‰ ${shoppingList.value.length} å€‹é …ç›®çš„å‹¾é¸å—ï¼Ÿ`)) {
						shoppingList.value.forEach(item => {
							item.purchased = false;
						});
						saveShoppingList();
					}
				};

				const toggleShoppingPurchased = (item) => {
					item.purchased = !item.purchased;
					saveShoppingList();
				};

				// --- è³¼ç‰©æ¸…å–® CRUD ---
				// ä¿®æ”¹ openShoppingModal å‡½æ•¸
				const openShoppingModal = (item = null) => {
					if (item) {
						isShoppingEditing.value = true;
						shoppingForm.value = { ...item };
						// ç¢ºä¿æ˜¯ URLï¼Œä¸æ˜¯ Base64
						if (shoppingForm.value.imageUrl && shoppingForm.value.imageUrl.startsWith('data:')) {
							shoppingForm.value.imageUrl = ''; // æ¸…é™¤ Base64 æ•¸æ“š
						}
					} else {
						isShoppingEditing.value = false;
						shoppingForm.value = { 
							id: Date.now().toString(36) + Math.random().toString(36).substr(2),
							name: '',
							category: 'ä¼´æ‰‹ç¦®',
							shop: '',
							location: '',
							lat: null,
							lng: null,
							priority: '',
							purchased: false,
							note: ''
						};
					}
					showShoppingModal.value = true;
				};

				const editShoppingItem = async (item) => {
				  isShoppingEditing.value = true;
				  
				  // å…ˆè¤‡è£½é …ç›®æ•¸æ“š
				  shoppingForm.value = { ...item };
				  
				  // ä¿®æ­£ï¼šç§»é™¤é€™è£¡çš„ cleanup å‘¼å«ã€‚
				  // åŸå› ï¼šshoppingForm æ˜¯æ·ºæ‹·è²ï¼Œ_imageCleanup æŒ‡å‘çš„æ˜¯åŸåˆ—è¡¨é …ç›®çš„æ’¤éŠ·å‡½æ•¸ã€‚
				  // å¦‚æœåœ¨é€™è£¡åŸ·è¡Œï¼ŒæœƒæŠŠåˆ—è¡¨ä¸Šæ­£åœ¨é¡¯ç¤ºçš„åœ–ç‰‡ URL çµ¦æ’¤éŠ·æ‰ï¼Œå°è‡´åˆ‡æ›è¦–åœ–å¾Œåœ–ç‰‡ç ´åœ–ã€‚
				  
				  // å˜—è©¦è¼‰å…¥åœ–ç‰‡
				  // ä¿®æ­£ï¼šæ”¹å‚³å…¥ shoppingForm.valueï¼Œç¢ºä¿é€™å¼µæ–°è¼‰å…¥çš„åœ–ç‰‡åŠå…¶ cleanup å‡½æ•¸
				  // æ˜¯ç¶å®šåœ¨ã€Œè¡¨å–®ç‰©ä»¶ã€ä¸Šï¼Œè€Œä¸æ˜¯è¦†è“‹æ‰ã€ŒåŸåˆ—è¡¨é …ç›®ã€çš„å±¬æ€§ã€‚
				  const imageData = await loadShoppingItemImage(shoppingForm.value);
				  
				  if (imageData) {
					shoppingForm.value.imagePreview = imageData;
				  } else if (item.imageName) {
					// åªæœ‰æª”åï¼Œæ²’æœ‰åœ–ç‰‡æ•¸æ“šï¼Œé¡¯ç¤ºæé†’
					console.log('æé†’ï¼šæ­¤é …ç›®æœ‰åœ–ç‰‡æª”åï¼Œéœ€è¦é‡æ–°é¸æ“‡æ‰èƒ½é¡¯ç¤º');
					shoppingForm.value.imagePreview = null;
				  } else {
					shoppingForm.value.imagePreview = null;
				  }
				  
				  showShoppingModal.value = true;
				};
				
				// æ¸…é™¤åœ–ç‰‡æŒ‰éˆ•
				const clearImage = () => {
					if (shoppingForm.value.imagePreview) {
						URL.revokeObjectURL(shoppingForm.value.imagePreview);
					}
					shoppingForm.value.imagePreview = null;
					shoppingForm.value.imageName = null;
					shoppingForm.value.imageSize = null;
					shoppingForm.value.imageType = null;
					shoppingForm.value.imageLastModified = null;
				};

				// ä¿®æ”¹ saveShoppingItem å‡½æ•¸
				const saveShoppingItem = async () => {
				  if (!shoppingForm.value.name) {
					alert('è«‹å¡«å¯«é …ç›®åç¨±');
					return;
				  }
				  
				  try {
					// æº–å‚™è¦ä¿å­˜çš„è³‡æ–™
					const itemToSave = {
					  ...shoppingForm.value,
					  // æ¸…é™¤è‡¨æ™‚é è¦½ URL
					  imagePreview: undefined
					};
					
					// å¦‚æœæœ‰ Blob URLï¼Œé‡‹æ”¾è³‡æº
					if (shoppingForm.value.imagePreview && 
						shoppingForm.value.imagePreview.startsWith('blob:')) {
					  URL.revokeObjectURL(shoppingForm.value.imagePreview);
					  delete shoppingForm.value.imagePreview;
					}
					
					// ä¿å­˜åˆ°è³¼ç‰©æ¸…å–®
					if (isShoppingEditing.value) {
					  const idx = shoppingList.value.findIndex(i => i.id === itemToSave.id);
					  if (idx !== -1) {
						// é‡‹æ”¾èˆŠåœ–ç‰‡çš„ URLï¼ˆå¦‚æœæœ‰ï¼‰
						if (shoppingList.value[idx].imagePreview && 
							shoppingList.value[idx].imagePreview.startsWith('blob:')) {
						  URL.revokeObjectURL(shoppingList.value[idx].imagePreview);
						}
						shoppingList.value[idx] = itemToSave;
					  }
					} else {
					  shoppingList.value.push(itemToSave);
					}
					
					saveShoppingList();
					showShoppingModal.value = false;
					
				  } catch (error) {
					console.error('å„²å­˜å¤±æ•—:', error);
					alert('å„²å­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
				  }
				};
				// æ–°å¢ï¼šè™•ç†åœ°åœ–é»æ“Šçš„å‡½æ•¸
				const handleMapClick = (item) => {
					if (!item) {
						console.error('handleMapClick: item is undefined');
						return;
					}
					
					console.log('é»æ“Šåœ°åœ–æŒ‰éˆ•ï¼Œé …ç›®:', item);
					
					// è¤‡è£½é …ç›®ä»¥é¿å…å¼•ç”¨å•é¡Œ
					const itemCopy = JSON.parse(JSON.stringify(item));
					
					// ç¢ºä¿æœ‰å¿…è¦çš„å±¬æ€§
					if (!itemCopy.location) {
						alert('æ­¤é …ç›®æ²’æœ‰åœ°é»è³‡è¨Š');
						return;
					}
					
					openShoppingMap(itemCopy);
				};
				
				// æ–°å¢ï¼šåœ¨è³¼ç‰©æ¸…å–®è¼‰å…¥æ™‚ï¼Œå¯ä»¥æ‰¹é‡è¼‰å…¥åœ–ç‰‡
				const enhanceShoppingListWithImages = async () => {
				  // å…ˆæ¸…ç†èˆŠçš„ Blob URLs
				  shoppingList.value.forEach(item => {
					if (item._imageCleanup && typeof item._imageCleanup === 'function') {
					  item._imageCleanup();
					}
				  });
				  
				  for (const item of shoppingList.value) {
					// è·³éå·²æœ‰ imagePreview ä¸”ä¸æ˜¯ Blob URL çš„é …ç›®
					if (item.imagePreview && !item.imagePreview.startsWith('blob:')) continue;
					
					// å¾ IndexedDB è¼‰å…¥
					if (item.imageId) {
					  const imageData = await loadShoppingItemImage(item);
					  if (imageData) {
						item.imagePreview = imageData;
					  }
					}
				  }
				  
				  saveShoppingList();
				};
				
				const deleteShoppingItem = () => {
					if (confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ")) {
						shoppingList.value = shoppingList.value.filter(i => i.id !== shoppingForm.value.id);
						saveShoppingList();
						showShoppingModal.value = false;
					}
				};

				// --- åœ–ç‰‡ä¸Šå‚³è™•ç† ---
				const imageInput = ref(null);

				const triggerImageUpload = () => {
					console.log('è§¸ç™¼åœ–ç‰‡ä¸Šå‚³'); // ç”¨æ–¼èª¿è©¦
					if (imageInput.value) {
						imageInput.value.click();
					} else {
						console.error('imageInput ref æœªæ‰¾åˆ°');
					}
				};

				// ä¿®æ”¹ handleImageUpload å‡½æ•¸
				const handleImageUpload = async (event) => {
				  const file = event.target.files[0];
				  if (!file) return;
				  
				  // æª¢æŸ¥æª”æ¡ˆå¤§å°
				  if (file.size > 10 * 1024 * 1024) {
					alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 10MB');
					return;
				  }
				  
				  try {
					// å£“ç¸®åœ–ç‰‡
					const compressionResult = await compressImage(file);
					
					// ç”Ÿæˆå”¯ä¸€ ID
					const imageId = `img_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
					
					// å„²å­˜åˆ° IndexedDBï¼ˆåªå­˜å„²å…ƒä¿¡æ¯å’Œå£“ç¸®å¾Œçš„ ArrayBufferï¼‰
					await imageStore.setItem(imageId, {
					  data: compressionResult.data, // ArrayBuffer
					  name: file.name,
					  type: 'image/jpeg', // çµ±ä¸€ç‚º JPEG æ ¼å¼
					  originalType: file.type,
					  size: compressionResult.compressedSize,
					  originalSize: file.size,
					  width: compressionResult.width,
					  height: compressionResult.height,
					  compressionRatio: compressionResult.compressionRatio,
					  lastModified: Date.now()
					});
					
					// ç‚ºé è¦½ç”Ÿæˆ Blob URLï¼ˆåƒ…ç”¨æ–¼è‡¨æ™‚é¡¯ç¤ºï¼‰
					const blob = compressionResult.blob;
					const previewUrl = URL.createObjectURL(blob);
					
					// æ›´æ–°è¡¨å–®
					shoppingForm.value.imageId = imageId;
					shoppingForm.value.imagePreview = previewUrl; // Blob URL
					shoppingForm.value.imageName = file.name;
					shoppingForm.value.imageSize = compressionResult.compressedSize;
					shoppingForm.value.originalSize = file.size;
					shoppingForm.value.compressionRatio = compressionResult.compressionRatio;
					
					console.log(`åœ–ç‰‡å£“ç¸®å®Œæˆï¼š${file.size} â†’ ${compressionResult.compressedSize} (${compressionResult.compressionRatio})`);
					
				  } catch (error) {
					console.error('åœ–ç‰‡è™•ç†å¤±æ•—:', error);
					alert('åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
				  }
				};
				
				const handleImageError = (item) => {
				  console.log('åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œå˜—è©¦é‡æ–°è¼‰å…¥:', item);
				  // æ¸…ç†ç„¡æ•ˆçš„ URL
				  if (item._imageCleanup) {
					item._imageCleanup();
					delete item._imageCleanup;
				  }
				  delete item.imagePreview;
				  
				  // å˜—è©¦é‡æ–°è¼‰å…¥
				  setTimeout(async () => {
					if (item.imageId) {
					  const newImage = await loadShoppingItemImage(item);
					  if (newImage) {
						item.imagePreview = newImage;
					  }
					}
				  }, 100);
				};
				
				// æ–°å¢ï¼šåœ–ç‰‡å£“ç¸®å‡½æ•¸
				const compressImage = async (file, maxWidth = 800, quality = 0.7) => {
				  return new Promise((resolve, reject) => {
					const reader = new FileReader();
					reader.onload = (e) => {
					  const img = new Image();
					  img.onload = () => {
						const canvas = document.createElement('canvas');
						let width = img.width;
						let height = img.height;
						
						// ç­‰æ¯”ä¾‹ç¸®æ”¾
						if (width > maxWidth) {
						  height = (height * maxWidth) / width;
						  width = maxWidth;
						}
						
						canvas.width = width;
						canvas.height = height;
						
						const ctx = canvas.getContext('2d');
						ctx.drawImage(img, 0, 0, width, height);
						
						// è½‰æ›ç‚ºå£“ç¸®çš„ JPEG æ ¼å¼
						canvas.toBlob(
						  (blob) => {
							const reader = new FileReader();
							reader.onload = (e) => {
							  resolve({
								data: e.target.result, // ArrayBuffer
								blob: blob,
								width: width,
								height: height,
								originalSize: file.size,
								compressedSize: blob.size,
								compressionRatio: (blob.size / file.size * 100).toFixed(1) + '%'
							  });
							};
							reader.readAsArrayBuffer(blob);
						  },
						  'image/jpeg',
						  quality
						);
					  };
					  img.onerror = reject;
					  img.src = e.target.result;
					};
					reader.onerror = reject;
					reader.readAsDataURL(file);
				  });
				};

				const loadShoppingItemImage = async (item) => {
				  try {
					// 1. å¦‚æœæœ‰ imageIdï¼Œå¾ IndexedDB è¼‰å…¥å£“ç¸®åœ–ç‰‡
					if (item.imageId) {
					  const imageData = await imageStore.getItem(item.imageId);
					  if (imageData && imageData.data) {
						// å°‡ ArrayBuffer è½‰æ›ç‚º Blob URL
						const blob = new Blob([imageData.data], { type: imageData.type || 'image/jpeg' });
						const blobUrl = URL.createObjectURL(blob);
						
						// è¨­ç½®æ¸…ç†å›èª¿
						item._imageCleanup = () => {
						  if (blobUrl) {
							URL.revokeObjectURL(blobUrl);
							delete item._imageCleanup;
						  }
						};
						
						return blobUrl;
					  }
					}
					
					// 2. èˆŠæ ¼å¼å…¼å®¹ï¼šå¦‚æœæœ‰ Base64 æ•¸æ“š
					if (item.imageUrl && item.imageUrl.startsWith('data:')) {
					  return item.imageUrl;
					}
					
					return null;
				  } catch (error) {
					console.error('è¼‰å…¥åœ–ç‰‡å¤±æ•—:', error);
					return null;
				  }
				};

				// --- åœ°é»è™•ç† ---
				const openShoppingMapModal = () => {
					locationSearch.value = '';
					locationSearchResults.value = [];
					showLocationModal.value = true;
				};

				const searchLocation = () => {
					// ç°¡æ˜“çš„æ¨¡æ“¬æœå°‹ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­å¯ä»¥æ¥å…¥ Google Places API
					if (locationSearch.value.length < 2) {
						locationSearchResults.value = [];
						return;
					}
					
					// æ¨¡æ“¬æœå°‹çµæœ
					locationSearchResults.value = [
						{
							id: '1',
							name: `${locationSearch.value} (æ±äº¬è»Šç«™åº—)`,
							address: 'æ±äº¬éƒ½åƒä»£ç”°åŒºä¸¸ã®å†…1-9-1',
							lat: 35.681236,
							lng: 139.767125
						},
						{
							id: '2',
							name: `${locationSearch.value} (æ–°å®¿åº—)`,
							address: 'æ±äº¬éƒ½æ–°å®¿åŒºæ–°å®¿3-38-1',
							lat: 35.689487,
							lng: 139.691711
						}
					];
				};

				const selectLocation = (result) => {
					shoppingForm.value.location = `${result.name} - ${result.address}`;
					shoppingForm.value.lat = result.lat;
					shoppingForm.value.lng = result.lng;
					showLocationModal.value = false;
				};

				const useEventLocation = (event) => {
					shoppingForm.value.location = event.location;
					shoppingForm.value.lat = event.lat;
					shoppingForm.value.lng = event.lng;
					showLocationModal.value = false;
				};

				const useCurrentLocation = () => {
					if (navigator.geolocation) {
						navigator.geolocation.getCurrentPosition(
							(position) => {
								shoppingForm.value.lat = position.coords.latitude;
								shoppingForm.value.lng = position.coords.longitude;
								shoppingForm.value.location = 'ç›®å‰ä½ç½®';
								showLocationModal.value = false;
							},
							() => {
								alert('ç„¡æ³•å–å¾—ç›®å‰ä½ç½®');
							}
						);
					} else {
						alert('ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
					}
				};

				const clearShoppingLocation = () => {
					shoppingForm.value.location = '';
					shoppingForm.value.lat = null;
					shoppingForm.value.lng = null;
				};
				
				// --- åˆ†é¡æ»¾å‹•ç›¸é—œ ---
				const categoryScroll = ref(null);
				const categoryTouchStartX = ref(0);
				const categoryScrollStartX = ref(0);
				const isCategoryDragging = ref(false);
				const showLeftGradient = ref(false);
				const showRightGradient = ref(true);

				// è™•ç†åˆ†é¡æ»¾å‹•
				const handleCategoryScroll = () => {
					updateScrollGradients();
				};

				// æ›´æ–°æ»¾å‹•æç¤º
				const updateScrollGradients = () => {
					if (!categoryScroll.value) return;
					
					const container = categoryScroll.value;
					const scrollLeft = container.scrollLeft;
					const scrollWidth = container.scrollWidth;
					const clientWidth = container.clientWidth;
					
					// é¡¯ç¤ºå·¦å´é™°å½±ï¼ˆå¦‚æœå·²ç¶“æ»¾å‹•åˆ°å³å´ï¼‰
					showLeftGradient.value = scrollLeft > 0;
					
					// é¡¯ç¤ºå³å´é™°å½±ï¼ˆå¦‚æœé‚„æœ‰å…§å®¹åœ¨å³å´ï¼‰
					showRightGradient.value = scrollLeft + clientWidth < scrollWidth - 5; // 5åƒç´ çš„å®¹éŒ¯å€¼
				};

				// è§¸æ§äº‹ä»¶è™•ç†ï¼ˆæ”¹å–„ç§»å‹•ç«¯é«”é©—ï¼‰
				const handleTouchStart = (e) => {
					if (!categoryScroll.value) return;
					
					categoryTouchStartX.value = e.touches[0].clientX;
					categoryScrollStartX.value = categoryScroll.value.scrollLeft;
					isCategoryDragging.value = true;
					
					// é˜²æ­¢æ»¾å‹•å‚³æ’­
					e.stopPropagation();
				};

				const handleTouchMove = (e) => {
					if (!isCategoryDragging.value || !categoryScroll.value) return;
					
					const touchX = e.touches[0].clientX;
					const diffX = categoryTouchStartX.value - touchX;
					
					// æ»¾å‹•å®¹å™¨
					categoryScroll.value.scrollLeft = categoryScrollStartX.value + diffX;
					
					e.preventDefault();
					e.stopPropagation();
				};

				const handleTouchEnd = () => {
					isCategoryDragging.value = false;
				};

				// æ»¾å‹•åˆ°æŒ‡å®šåˆ†é¡
				const scrollToCategory = (category) => {
					if (!categoryScroll.value) return;
					
					const buttons = categoryScroll.value.querySelectorAll('.category-button');
					const targetButton = Array.from(buttons).find(btn => 
						btn.textContent.includes(category)
					);
					
					if (targetButton) {
						const container = categoryScroll.value;
						const buttonRect = targetButton.getBoundingClientRect();
						const containerRect = container.getBoundingClientRect();
						
						const scrollLeft = targetButton.offsetLeft - (containerRect.width - buttonRect.width) / 2;
						
						container.scrollTo({
							left: scrollLeft,
							behavior: 'smooth'
						});
						
						// æ›´æ–°æ»¾å‹•æç¤º
						setTimeout(updateScrollGradients, 300);
					}
				};

				// è‡ªå‹•æ»¾å‹•åˆ°ç¬¬ä¸€å€‹æœ‰é …ç›®çš„åˆ†é¡
				const autoScrollToFirstCategory = () => {
					nextTick(() => {
						setTimeout(() => {
							// æ‰¾ç¬¬ä¸€å€‹æœ‰æœªè³¼è²·é …ç›®çš„åˆ†é¡
							const firstCategory = shoppingCategories.find(cat => 
								shoppingList.value.some(item => 
									item.category === cat && !item.purchased
								)
							);
							
							if (firstCategory) {
								scrollToCategory(firstCategory);
							}
						}, 500);
					});
				};

				// ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
				const handleResize = () => {
					updateScrollGradients();
				};
				
				// æ»‘é¼ äº‹ä»¶è™•ç†
				const handleMouseMove = (e) => {
					if (!isCategoryDragging.value || !categoryScroll.value) return;
					
					const mouseX = e.clientX;
					const diffX = categoryTouchStartX.value - mouseX;
					
					// æ»¾å‹•å®¹å™¨
					categoryScroll.value.scrollLeft = categoryScrollStartX.value + diffX;
					
					e.preventDefault();
				};
				
				// --- æ‹–æ”¾æ’åºé‚è¼¯ (æ–°å¢) ---
                let sortableInstances = [];

                const initSortable = () => {
                    // æ¸…é™¤èˆŠçš„å¯¦ä¾‹
                    sortableInstances.forEach(s => s.destroy());
                    sortableInstances = [];

                    // 1. åˆå§‹åŒ–è¡Œææ¸…å–®æ’åº
                    if (currentTab.value === 'packing') {
                        const groups = document.querySelectorAll('.packing-sortable-group');
                        groups.forEach(el => {
                            sortableInstances.push(new Sortable(el, {
                                group: 'packing', // é™åˆ¶åªèƒ½åœ¨åŒé¡åˆ¥æ‹–æ›³
                                delay: 300,       // é•·æŒ‰ 300ms è§¸ç™¼
                                delayOnTouchOnly: true,
                                animation: 150,
                                ghostClass: 'sortable-ghost',
                                onEnd: (evt) => {
									const groupType = el.getAttribute('data-group-type');
									const newOrderIds = Array.from(el.children).map(child => child.getAttribute('data-id'));
									
									const itemMap = new Map(packingList.value.map(i => [i.id, i]));
									
									// æŒ‰ç…§å›ºå®šçš„åˆ†çµ„é †åºé‡å»ºåˆ—è¡¨
									const groupOrder = ['æ‰‹æè¡Œæ', 'è¨—é‹è¡Œæ', 'å…¶ä»–'];
									const newList = [];
									
									groupOrder.forEach(group => {
										if (group === groupType) {
											// ç•¶å‰è¢«æ‹–æ›³çš„åˆ†çµ„ï¼Œä½¿ç”¨æ–°é †åº
											const sortedGroupItems = newOrderIds.map(id => itemMap.get(id)).filter(Boolean);
											newList.push(...sortedGroupItems);
										} else {
											// å…¶ä»–åˆ†çµ„ä¿æŒåŸé †åº
											const groupItems = packingList.value.filter(i => (i.carry_type || 'å…¶ä»–') === group);
											newList.push(...groupItems);
										}
									});
									
									packingList.value = newList;
									savePackingList();
								}
                            }));
                        });
                    }

                    // 2. åˆå§‹åŒ–è³¼ç‰©æ¸…å–®æ’åº
                    if (currentTab.value === 'shopping') {
                        const containerId = viewMode.value === 'grid' ? '#shopping-grid-container' : '#shopping-list-container';
                        const el = document.querySelector(containerId);
                        if (el) {
                            sortableInstances.push(new Sortable(el, {
                                delay: 300,
                                delayOnTouchOnly: true,
                                animation: 150,
                                ghostClass: 'sortable-ghost',
                                onEnd: (evt) => {
									const newOrderIds = Array.from(el.children).map(child => child.getAttribute('data-id'));
									
									// å»ºç«‹ ID -> Item çš„æ˜ å°„
									const itemMap = new Map(shoppingList.value.map(i => [i.id, i]));
									
									// ç²å–ç•¶å‰ç¯©é¸å¾Œå¯è¦‹çš„é …ç›®
									const visibleItems = filteredShoppingList.value.map(item => item.id);
									
									// ç²å–ä¸å¯è¦‹çš„é …ç›®(æœªç¯©é¸å‡ºä¾†çš„)
									const invisibleItems = shoppingList.value.filter(item => !visibleItems.includes(item.id));
									
									// æŒ‰ç…§æ–°çš„æ‹–æ›³é †åºé‡å»ºå¯è¦‹é …ç›®åˆ—è¡¨
									const reorderedVisibleItems = newOrderIds
										.map(id => itemMap.get(id))
										.filter(Boolean);
									
									// æ‰¾å‡ºåŸå§‹åˆ—è¡¨ä¸­ç¬¬ä¸€å€‹å¯è¦‹é …ç›®çš„ä½ç½®
									const firstVisibleIndex = shoppingList.value.findIndex(item => 
										visibleItems.includes(item.id)
									);
									
									// é‡å»ºå®Œæ•´åˆ—è¡¨ï¼šä¸å¯è¦‹é …ç›®(å‰) + é‡æ–°æ’åºçš„å¯è¦‹é …ç›® + ä¸å¯è¦‹é …ç›®(å¾Œ)
									const invisibleBefore = invisibleItems.filter((item, idx) => {
										const originalIdx = shoppingList.value.indexOf(item);
										return originalIdx < firstVisibleIndex;
									});
									
									const invisibleAfter = invisibleItems.filter((item, idx) => {
										const originalIdx = shoppingList.value.indexOf(item);
										return originalIdx >= firstVisibleIndex;
									});
									
									shoppingList.value = [
										...invisibleBefore,
										...reorderedVisibleItems,
										...invisibleAfter
									];
									
									saveShoppingList();
								}
                            }));
                        }
                    }
                };

                // ç›£è½æœƒå½±éŸ¿åˆ—è¡¨ DOM çš„è®Šæ•¸
                watch([currentTab, viewMode, activeShoppingCategories], () => {
                    nextTick(() => {
                        initSortable();
                    });
                });

				const handleCategoryMouseDown = (e) => {
					if (!categoryScroll.value) return;
					
					categoryTouchStartX.value = e.clientX;
					categoryScrollStartX.value = categoryScroll.value.scrollLeft;
					isCategoryDragging.value = true;
					
					// é˜²æ­¢æ–‡å­—é¸å–
					e.preventDefault();
				};

				const openShoppingMap = (item) => {
					console.log('ğŸ“ Opening map for item:', item);
					
					// åŠ å¼·éŒ¯èª¤è™•ç†
					if (!item || typeof item !== 'object') {
						console.error('âŒ openShoppingMap: Invalid item parameter', item);
						alert('ç„¡æ³•å–å¾—é …ç›®è³‡è¨Šï¼Œè«‹é‡æ–°é¸æ“‡');
						return;
					}
					
					// æª¢æŸ¥æ˜¯å¦æœ‰åœ°é»è³‡è¨Š
					if (!item.location) {
						console.warn('âš ï¸ Item has no location:', item);
						alert('æ­¤é …ç›®æ²’æœ‰åœ°é»è³‡è¨Š');
						return;
					}
					
					// æª¢æŸ¥åº§æ¨™æ˜¯å¦æœ‰æ•ˆ
					const hasValidCoords = item.lat && item.lng && 
										  !isNaN(parseFloat(item.lat)) && 
										  !isNaN(parseFloat(item.lng));
					
					if (hasValidCoords) {
						// åˆ‡æ›åˆ°åœ°åœ–åˆ†é 
						switchTab('map');
						
						// çµ¦åœ°åœ–ä¸€äº›æ™‚é–“åˆå§‹åŒ–
						nextTick(() => {
							setTimeout(() => {
								initMap();
								
								if (mapInstance.value) {
									console.log('ğŸ—ºï¸ Flying to coordinates:', item.lat, item.lng);
									
									// é£›åˆ°æŒ‡å®šä½ç½®
									mapInstance.value.flyTo([item.lat, item.lng], 15, {
										duration: 1,
										easeLinearity: 0.25
									});
									
									// åœ¨åœ°åœ–ä¸Šæ·»åŠ æ¨™è¨˜
									const marker = L.marker([item.lat, item.lng], {
										icon: L.divIcon({
											className: 'custom-div-icon',
											html: `
												<div class="marker-pin marker-bounce marker-glow" 
													 style="background-color: ${shoppingCategoryColors[item.category] || '#ccc'}; transform: rotate(-45deg);"></div>
												<i class="fa-solid fa-shopping-cart marker-icon text-white" style="transform: rotate(45deg);"></i>
											`,
											iconSize: [30, 42],
											iconAnchor: [15, 42]
										})
									}).addTo(mapInstance.value);
									
									marker.bindPopup(`
										<div class="font-bold">${item.name || 'æœªå‘½å'}</div>
										<div class="text-xs text-gray-600">${item.category || ''}</div>
										<div class="text-xs text-gray-600">${item.shop || ''}</div>
										<div class="text-xs text-blue-600 mt-1">
											<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location || '')}" target="_blank">
												é–‹å•Ÿ Google Maps
											</a>
										</div>
									`).openPopup();
									
									// 3ç§’å¾Œç§»é™¤è·³å‹•æ•ˆæœ
									setTimeout(() => {
										marker.remove();
										updateMarkers();
									}, 3000);
								}
							}, 300);
						});
					} else if (item.location) {
						// æ²’æœ‰åº§æ¨™ä½†æœ‰åœ°å€ï¼Œé–‹å•Ÿ Google Maps
						console.log('ğŸŒ Opening Google Maps for location:', item.location);
						window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`, '_blank');
					} else {
						alert('æ­¤é …ç›®æ²’æœ‰åœ°é»è³‡è¨Š');
					}
				};

                const updateGistData = async (newData) => {
                    if (!gistId.value || !githubToken.value) {
                        errorMessage.value = 'è«‹è¨­å®š Gist ID å’Œ Token';
                        syncStatus.value = 'error';
                        return;
                    }
                    syncStatus.value = 'syncing';
                    try {
                        const payload = {
                            files: {
                                [GIST_FILENAME]: {
                                    content: JSON.stringify(newData)
                                }
                            }
                        };
                        const response = await fetch(`https://api.github.com/gists/${gistId.value}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `token ${githubToken.value}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error('Save failed');
                        syncStatus.value = 'idle';
                        errorMessage.value = '';
                        lastUpdated.value = newData.lastUpdated;
                        lastUpdatedBy.value = newData.lastUpdatedBy;
                    } catch (error) {
                        console.error('Update error:', error);
                        syncStatus.value = 'error';
                        errorMessage.value = 'åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æ˜¯å¦æœ‰æ•ˆ';
                    }
                };

                // --- Sync Logic ---
                const applyData = (data) => {
                    if (!data) return;
                    // Check if remote is newer
                    const remoteTime = new Date(data.lastUpdated).getTime();
                    const localTime = lastUpdated.value ? new Date(lastUpdated.value).getTime() : 0;

                    if (remoteTime > localTime) {
                        schedule.value = data.schedule || [];
                        expenses.value = data.expenses || [];
                        members.value = data.members || [];
                        settlementsPaid.value = data.settlementsPaid || {};
                        lastUpdated.value = data.lastUpdated;
                        lastUpdatedBy.value = data.lastUpdatedBy;
                    }
                };

                const pollData = async () => {
                    if (document.hidden || !hasToken.value) return; // Don't poll if tab hidden or no token
                    const data = await fetchGistData();
                    if (data) applyData(data);
                };

                const saveData = async () => {
                    if (!hasToken.value) {
                        errorMessage.value = 'è«‹å…ˆè¨­å®š GitHub Token æ‰èƒ½åŒæ­¥';
                        return;
                    }
                    
                    const now = new Date().toISOString();
                    const newData = {
                        lastUpdated: now,
                        lastUpdatedBy: currentUser.value,
                        schedule: schedule.value,
                        expenses: expenses.value,
                        members: members.value,
                        settlementsPaid: settlementsPaid.value
                    };
                    // Optimistic update locally
                    lastUpdated.value = now;
                    lastUpdatedBy.value = currentUser.value;
                    
                    await updateGistData(newData);
                };
                
                const loadData = async () => {
                    if (!hasToken.value) {
                        isInitialLoading.value = false;
                        return;
                    }
                    
                    const data = await fetchGistData();
                    if (data) applyData(data);
                    isInitialLoading.value = false;
                };

                // --- Computed ---
                const statusText = computed(() => {
                    if (!hasToken.value) return 'æœªè¨­å®š Token';
                    if (syncStatus.value === 'syncing') return 'åŒæ­¥ä¸­...';
                    if (syncStatus.value === 'error') return 'é€£ç·šéŒ¯èª¤';
                    return 'å·²åŒæ­¥';
                });

                const statusColorClass = computed(() => {
                    if (!hasToken.value) return 'bg-amber-500';
                    if (syncStatus.value === 'syncing') return 'bg-yellow-400 animate-pulse';
                    if (syncStatus.value === 'error') return 'bg-red-500';
                    return 'bg-green-500';
                });

                const formattedLastUpdate = computed(() => {
                    if (!lastUpdated.value) return 'ç„¡è¨˜éŒ„';
                    const date = new Date(lastUpdated.value);
                    return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                });

                const currentDayEvents = computed(() => schedule.value.filter(e => e.dayIdx === currentDayIndex.value).sort((a,b) => a.time.localeCompare(b.time)));
                const sortedExpenses = computed(() => [...expenses.value].reverse());
                const totalExpense = computed(() => expenses.value.reduce((acc, cur) => acc + Number(cur.amount), 0));
                const avgExpense = computed(() => members.value.length ? totalExpense.value / members.value.length : 0);
                
                const expenseStats = computed(() => {
                    const stats = {};
                    expenses.value.forEach(e => stats[e.category] = (stats[e.category] || 0) + Number(e.amount));
                    const colors = { 'é¤é£²': '#f97316', 'äº¤é€š': '#3b82f6', 'ä½å®¿': '#8b5cf6', 'è³¼ç‰©': '#10b981', 'é–€ç¥¨': '#f43f5e', 'å…¶ä»–': '#64748b' };
                    return Object.keys(stats).map(key => ({ name: key, percent: (stats[key]/totalExpense.value)*100, color: colors[key]||'#ccc' })).sort((a,b)=>b.percent-a.percent);
                });
                
                // æ–°å¢ï¼šæ¯äººæ”¯å‡ºçµ±è¨ˆ
				const memberBalances = computed(() => {
					const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#06b6d4'];
					const bal = {};
					
					// åˆå§‹åŒ–æ‰€æœ‰æˆå“¡
					members.value.forEach((m, idx) => {
						bal[m] = { 
							name: m, 
							share: 0,          // æ‡‰ä»˜åˆ†æ”¤é‡‘é¡ï¼ˆé¡¯ç¤ºç”¨ï¼‰
							paid: 0,           // å·²ä»˜æ¬¾é‡‘é¡
							color: colors[idx % colors.length],
							balance: 0         // çµç®—é¤˜é¡ï¼ˆæ­£æ•¸è¡¨ç¤ºå¤šä»˜ï¼Œè² æ•¸è¡¨ç¤ºæ¬ æ¬¾ï¼‰
						};
					});
					
					// è¨ˆç®—æ¯ç­†æ”¯å‡º
					expenses.value.forEach(e => {
						const amount = Number(e.amount);
						const payer = e.payer;
						
						// 1. è¨˜éŒ„ä»˜æ¬¾äººå·²ä»˜é‡‘é¡
						if (bal[payer]) {
							bal[payer].paid += amount;
						}
						
						// 2. è¨ˆç®—åˆ†æ”¤
						let shares = {};
						
						if (e.splitDetails) {
							if (e.splitDetails.method === 'participants') {
								// é¸æ“‡åƒèˆ‡è€…åˆ†æ”¤
								const perPerson = e.splitDetails.perPerson;
								e.splitDetails.participants.forEach(participant => {
									if (bal[participant]) {
										shares[participant] = (shares[participant] || 0) + perPerson;
									}
								});
								
							} else if (e.splitDetails.method === 'custom') {
								// è‡ªè¨‚æ¯”ä¾‹åˆ†æ”¤
								Object.keys(e.splitDetails.splits).forEach(member => {
									const splitAmount = Number(e.splitDetails.splits[member]) || 0;
									if (bal[member] && splitAmount > 0) {
										shares[member] = (shares[member] || 0) + splitAmount;
									}
								});
								
							} else {
								// å¹³å‡åˆ†æ”¤
								const perPerson = amount / members.value.length;
								members.value.forEach(member => {
									if (bal[member]) {
										shares[member] = (shares[member] || 0) + perPerson;
									}
								});
							}
						} else {
							// èˆŠè³‡æ–™ï¼šå¹³å‡åˆ†æ”¤
							const perPerson = amount / members.value.length;
							members.value.forEach(member => {
								if (bal[member]) {
									shares[member] = (shares[member] || 0) + perPerson;
								}
							});
						}
						
						// 3. å°‡åˆ†æ”¤é‡‘é¡åŠ åˆ°æ¯å€‹äººçš„ share
						Object.keys(shares).forEach(member => {
							bal[member].share += shares[member];
						});
					});
					
					// 4. è¨ˆç®—çµç®—é¤˜é¡
					Object.keys(bal).forEach(member => {
						bal[member].balance = bal[member].paid - bal[member].share;
					});
					
					return Object.values(bal);
				});
				// æ–°å¢ï¼šæ˜¯å¦æœ‰å·²ä»˜æ¬¾é …ç›®
                const hasSettlementsPaid = computed(() => {
                    return Object.keys(settlementsPaid.value).length > 0;
                });

                // ä¿®æ”¹ï¼šçµç®—å»ºè­°ï¼ŒåŠ å…¥å·²ä»˜æ¬¾ç‹€æ…‹
                const settlements = computed(() => {
					if(!expenses.value.length) return [];
					
					// ä½¿ç”¨ memberBalances è¨ˆç®—çš„çµç®—é¤˜é¡
					const balances = {};
					memberBalances.value.forEach(m => {
						balances[m.name] = m.balance; // ä½¿ç”¨ balance è€Œé amount
					});
					
					// è½‰æ›ç‚ºå·®é¡é™£åˆ—
					const diffs = Object.keys(balances).map(name => ({ 
						name, 
						val: balances[name] 
					})).sort((a,b) => a.val - b.val);
					
					const res = [];
					let i=0, j=diffs.length-1;
					
					while(i < j) {
						if(Math.abs(diffs[i].val) < 1) { i++; continue; }
						if(Math.abs(diffs[j].val) < 1) { j--; continue; }
						
						const amt = Math.min(Math.abs(diffs[i].val), diffs[j].val);
						res.push({ 
							from: diffs[i].name, 
							to: diffs[j].name, 
							amount: Math.round(amt) 
						});
						
						diffs[i].val += amt;
						diffs[j].val -= amt;
					}
					
					return res;
				});
				
				const memberBalancesForDisplay = computed(() => {
					return memberBalances.value.map(member => ({
						name: member.name,
						amount: member.amount, // æ°¸é æ˜¯æ­£æ•¸
						color: member.color,
						type: member.paid > member.share ? 'å¤šä»˜' : 'æ‡‰ä»˜' // æ¨™è¨»é¡å‹
					}));
				});
				// --- UI Helpers ---
                const formatTime = (t) => t;
                const formatNumber = (n) => n.toLocaleString();
                const getCategoryColor = (c, bg) => { 
                    const map = {
                        'æ™¯é»':'rose-500',
                        'ç¾é£Ÿ':'orange-500',
                        'äº¤é€š':'blue-500',
                        'ä½å®¿':'purple-500',
                        'è³¼ç‰©':'emerald-500'
                    }; 
                    return bg ? `bg-${map[c]||'gray-400'}` : `text-${map[c]||'gray-400'}`; 
                };
                const getCategoryIcon = (c) => ({'æ™¯é»':'fa-camera','ç¾é£Ÿ':'fa-utensils','äº¤é€š':'fa-train','ä½å®¿':'fa-bed','è³¼ç‰©':'fa-bag-shopping'}[c]||'fa-star');
                const switchTab = (t) => { 
					currentTab.value = t; 
					if(t === 'map') {
						nextTick(() => {
							setTimeout(() => {
								initMap();
							}, 100);
						});
					}
				};
					    
                // Map
				const initMap = () => {
					console.log('ğŸ—ºï¸ Initializing map...');
					
					const container = document.getElementById('mapContainer');
					if (!container) {
						console.error('âŒ Map container not found');
						errorMessage.value = 'æ‰¾ä¸åˆ°åœ°åœ–å®¹å™¨';
						return;
					}
					
					console.log('âœ… Map container found:', container);

					// å¦‚æœåœ°åœ–å·²ç¶“åˆå§‹åŒ–ï¼Œåªèª¿æ•´å¤§å°
					if(mapInstance.value && mapInitialized.value) { 
						console.log('ğŸ”„ Map already exists, resizing...');
						setTimeout(() => {
							mapInstance.value.invalidateSize();
							mapInstance.value.setView(mapCenter.value, mapZoom.value);
							updateMarkers();
						}, 100);
						return; 
					}
					
					mapLoading.value = true;
					
					try {
						console.log('ğŸ—ï¸ Creating new map instance...');
						
						// ç¢ºä¿å®¹å™¨æœ‰é«˜åº¦
						container.style.height = '100%';
						
						// å¦‚æœå·²æœ‰åœ°åœ–å¯¦ä¾‹ï¼Œå…ˆç§»é™¤
						if(mapInstance.value && !mapInitialized.value) {
							mapInstance.value.remove();
							mapInstance.value = null;
							mapMarkers.value = [];
						}
						
						// å‰µå»ºåœ°åœ–å¯¦ä¾‹ - ä¿®å¾©ï¼šæ·»åŠ æ›´ç©©å®šçš„é…ç½®
						const map = L.map('mapContainer', {
							center: mapCenter.value,
							zoom: mapZoom.value,
							zoomControl: true,
							preferCanvas: true,
							inertia: true,
							inertiaDeceleration: 3000,
							inertiaMaxSpeed: 1500,
							easeLinearity: 0.2,
							fadeAnimation: true,
							markerZoomAnimation: true,
							transform3DLimit: 0  // ç¢ºä¿æ¨™è¨˜å¯ä»¥ç¸®æ”¾
						});
						
						console.log('âœ… Map instance created');
						
						// æ·»åŠ åœ–å±¤
						L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
							attribution: '&copy; OpenStreetMap',
							maxZoom: 19,
							minZoom: 10
						}).addTo(map);
						
						console.log('âœ… Tile layer added');
						
						mapInstance.value = map;
						mapInitialized.value = true;
						
						// ç›£è½åœ°åœ–äº‹ä»¶ - ä¿®å¾©ï¼šä½¿ç”¨æ›´ç©©å®šçš„äº‹ä»¶è™•ç†
						map.on('moveend', () => {
							const center = map.getCenter();
							mapCenter.value = [center.lat, center.lng];
							mapZoom.value = map.getZoom();
						});
						
						// æ–°å¢ï¼šç›£è½ç¸®æ”¾äº‹ä»¶ï¼Œç¢ºä¿æ¨™è¨˜æ›´æ–°
						map.on('zoomstart', () => {
							isMapZooming.value = true;
						});
						
						map.on('zoomend', () => {
							isMapZooming.value = false;
							// å¼·åˆ¶æ›´æ–°æ¨™è¨˜ä½ç½®
							updateMarkerPositions();
						});
						
						// æ–°å¢ï¼šç›£è½ç¸®æ”¾éç¨‹ä¸­çš„äº‹ä»¶
						map.on('zoom', () => {
							if (mapInstance.value && !isMapZooming.value) {
								isMapZooming.value = true;
							}
						});

						// æ·»åŠ é˜²æŠ–è™•ç†çš„è¦–çª—å¤§å°èª¿æ•´äº‹ä»¶
						let resizeTimeout;
						const handleResize = () => {
							clearTimeout(resizeTimeout);
							resizeTimeout = setTimeout(() => {
								if (map && !map._size) {
									map.invalidateSize();
									updateMarkerPositions();
								}
							}, 250);
						};
						
						window.addEventListener('resize', handleResize);
						
						// å»¶é²æ›´æ–°ä»¥ç¢ºä¿åœ°åœ–å®Œå…¨è¼‰å…¥
						setTimeout(() => {
							console.log('ğŸ”§ Invalidating size and updating markers...');
							map.invalidateSize();
							updateMarkers();
							mapLoading.value = false;
							console.log('âœ… Map initialization complete');
						}, 500);
						
					} catch (error) {
						console.error('âŒ Map initialization error:', error);
						mapLoading.value = false;
						errorMessage.value = 'åœ°åœ–åˆå§‹åŒ–å¤±æ•—: ' + error.message;
					}
				};
				
				// æ–°å¢ï¼šæ›´æ–°æ¨™è¨˜ä½ç½®å‡½æ•¸
				const updateMarkerPositions = () => {
					if (!mapInstance.value || !mapMarkers.value.length) return;
					
					console.log('ğŸ“ Updating marker positions...');
					
					// é‡æ–°è¨­ç½®æ¯å€‹æ¨™è¨˜çš„ä½ç½®
					mapMarkers.value.forEach((marker, index) => {
						if (marker && marker.setLatLng && schedule.value[index]) {
							const event = schedule.value[index];
							if (event.lat && event.lng) {
								marker.setLatLng([event.lat, event.lng]);
							}
						}
					});
					
					// å¼·åˆ¶é‡æ–°ç¹ªè£½åœ°åœ– - æ·»åŠ éŒ¯èª¤æª¢æŸ¥
					if (mapInstance.value && mapInstance.value._renderer) {
						try {
							mapInstance.value._renderer._update();
						} catch (error) {
							console.warn('âš ï¸ Error updating renderer:', error);
							// å˜—è©¦ä½¿ç”¨å…¶ä»–æ–¹æ³•é‡ç¹ª
							if (mapInstance.value.invalidateSize) {
								setTimeout(() => {
									mapInstance.value.invalidateSize();
								}, 100);
							}
						}
					} else {
						console.warn('âš ï¸ Map renderer not available, deferring update');
						// å»¶é²é‡è©¦
						setTimeout(() => {
							if (mapInstance.value && mapInstance.value._renderer) {
								try {
									mapInstance.value._renderer._update();
								} catch (error) {
									console.warn('âš ï¸ Deferred update also failed:', error);
								}
							}
						}, 500);
					}
				};
                
                // æ–°å¢ï¼šé‡ç½®åœ°åœ–è¦–åœ–
				const resetMapView = () => {
					if (mapInstance.value) {
						mapInstance.value.setView([35.6895, 139.6917], 11);
						mapCenter.value = [35.6895, 139.6917];
						mapZoom.value = 11;
					}
				};
					
				
				// æ–°å¢ï¼šèª¿æ•´åœ°åœ–è¦–åœ–ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
				const fitMapToMarkers = () => {
					if (mapInstance.value && mapMarkers.value.length > 0) {
						const markerGroup = L.featureGroup(mapMarkers.value);
						mapInstance.value.fitBounds(markerGroup.getBounds(), {
							padding: [50, 50],
							maxZoom: 15
						});
					}
				};
				
                // ä¿®æ”¹ updateMarkers å‡½æ•¸ï¼Œä½¿ç”¨çµ±ä¸€çš„é¡è‰²æ˜ å°„å’Œå…§è¯æ¨£å¼
				const updateMarkers = () => {
					console.log('ğŸ“ Updating markers...');
					
					if(!mapInstance.value) {
						console.warn('âš ï¸ Map instance not ready');
						return;
					}
					
					// æ¸…é™¤èˆŠæ¨™è¨˜
					mapMarkers.value.forEach(m => {
						try {
							if (m && m.remove) {
								m.remove();
							}
						} catch (e) {
							console.error('Error removing marker:', e);
						}
					});
					mapMarkers.value = [];
					
					let validMarkers = 0;
					
					schedule.value.forEach(e => {
						// æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç¶“ç·¯åº¦
						if(e.lat && e.lng && !isNaN(e.lat) && !isNaN(e.lng)) {
							try {
								// ä½¿ç”¨çµ±ä¸€çš„é¡è‰²æ˜ å°„ç²å–é¡è‰²
								const markerColor = categoryColorMap[e.category] || '#ccc';
								
								// å‰µå»ºè‡ªå®šç¾©åœ–æ¨™ - ä¿®å¾©ç¸®æ”¾å•é¡Œ
								const icon = L.divIcon({
									className: 'custom-div-icon',
									html: `
										<div class="marker-pin ${bouncingMarkerId.value === e.id ? 'marker-bounce marker-glow' : ''}" 
										     style="background-color: ${markerColor}; transform: rotate(-45deg);"></div>
										<i class="fa-solid ${getCategoryIcon(e.category)} marker-icon ${bouncingMarkerId.value === e.id ? 'text-yellow-300' : ''}" style="transform: rotate(45deg);"></i>
									`,
									iconSize: [30, 42],
									iconAnchor: [15, 42],
									popupAnchor: [0, -36]
								});
								
								const m = L.marker([e.lat, e.lng], { 
									icon: icon,
									riseOnHover: true,
									riseOffset: 250
								})
									.addTo(mapInstance.value)
									.on('click', () => {
										mapSelectedEvent.value = e;
										mapInstance.value.setView([e.lat, e.lng], 14, {
											animate: true,
											duration: 0.8
										});
										bouncingMarkerId.value = e.id;
										setTimeout(() => {
											bouncingMarkerId.value = null;
											// æ›´æ–°æ¨™è¨˜ä»¥ç§»é™¤è·³å‹•æ•ˆæœ
											updateMarkers();
										}, 3000);
									});
								
								if (bouncingMarkerId.value === e.id) {
									// ä½¿ç”¨å»¶é²ä»¥ç¢ºä¿åœ°åœ–å·²å®Œå…¨åŠ è¼‰
									setTimeout(() => {
										try {
											m.bindPopup(`<div class="font-bold">${e.title}</div><div class="text-xs text-gray-600">${e.location}</div>`).openPopup();
										} catch (popupError) {
											console.error('Error opening popup:', popupError);
										}
									}, 100);
								}
								
								mapMarkers.value.push(m);
								validMarkers++;
							} catch (error) {
								console.error('Error creating marker:', error, e);
							}
						}
					});
					
					console.log(`âœ… Added ${validMarkers} markers to map`);
					
					// å¦‚æœæ²’æœ‰æ¨™è¨˜ï¼Œé¡¯ç¤ºæç¤º
					if (validMarkers === 0) {
						console.log('â„¹ï¸ No valid markers found. Add some events with locations!');
					}
					
					// ç¢ºä¿æ¨™è¨˜æ›´æ–°å®Œæˆå¾Œï¼Œåœ°åœ–é‡æ–°æ¸²æŸ“
					setTimeout(() => {
						if (mapInstance.value) {
							try {
								if (mapInstance.value._renderer && mapInstance.value._renderer._update) {
									mapInstance.value._renderer._update();
								}
							} catch (e) {
								console.error('Error updating map renderer:', e);
							}
						}
					}, 100);
				};
				
				// ä¿®æ”¹ openMap å‡½æ•¸ - å„ªåŒ–åœ°åœ–è·³è½‰å’ŒéŒ¯èª¤è™•ç†
				const openMap = (e) => {
					switchTab('map');
					
					if(!e.lat) {
						window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.location)}`, '_blank');
					} else {
						// è¨­ç½®è·³å‹•æ¨™è¨˜çš„ ID
						bouncingMarkerId.value = e.id;
						
						// ç­‰å¾…åœ°åœ–åˆå§‹åŒ–å®Œæˆ
						const waitForMap = () => {
							if (mapInstance.value) {
								try {
									// å…ˆé–‹å§‹é£›è¡Œå‹•ç•«
									mapInstance.value.flyTo([e.lat, e.lng], 14, {
										duration: 1.2,
										easeLinearity: 0.25
									});
									
									// å»¶é²é¡¯ç¤ºæç¤ºå­—å’Œé¸ä¸­äº‹ä»¶ï¼Œç­‰å¾…é£›è¡Œå‹•ç•«é–‹å§‹
									setTimeout(() => {
										mapSelectedEvent.value = e;
										highlightedLocation.value = e.location;
										console.log('åœ°åœ–ä¸­å¿ƒé»å·²æ›´æ–°è‡³:', e.lat, e.lng);
									}, 200); // é£›è¡Œå‹•ç•«é€²è¡Œåˆ°ä¸€åŠæ™‚æ‰é¡¯ç¤º
									
									// æ›´æ–°æ¨™è¨˜
									updateMarkers();
									
									// 5ç§’å¾Œåœæ­¢è·³å‹•
									setTimeout(() => {
										bouncingMarkerId.value = null;
										updateMarkers();
									}, 5000);
									
									// 3ç§’å¾Œæ¸…é™¤é«˜äº®
									setTimeout(() => {
										highlightedLocation.value = null;
									}, 3600); // å¾é¡¯ç¤ºé–‹å§‹ç®—3ç§’
								} catch (mapError) {
									console.error('Error during map navigation:', mapError);
									// å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥é–‹å•Ÿ Google Maps
									window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.location)}`, '_blank');
								}
							} else {
								// å¦‚æœåœ°åœ–é‚„æ²’æº–å‚™å¥½ï¼Œå»¶é²é‡è©¦ï¼ˆæœ€å¤šé‡è©¦5æ¬¡ï¼‰
								const maxRetries = 5;
								let retryCount = 0;
								
								const retry = () => {
									if (retryCount < maxRetries) {
										retryCount++;
										setTimeout(waitForMap, 300);
									} else {
										// å¦‚æœåœ°åœ–åŠ è¼‰å¤±æ•—ï¼Œä½¿ç”¨ Google Maps ä½œç‚ºå‚™ç”¨
										window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.location)}`, '_blank');
									}
								};
								
								retry();
							}
						};
						
						// å•Ÿå‹•ç­‰å¾…
						waitForMap();
					}
				};
                // --- åˆ†å¸³ç‹€æ…‹è¿½è¹¤å‡½æ•¸ ---
                const toggleSettlementPaid = (settlement) => {
                    const key = `${settlement.from}-${settlement.to}-${settlement.amount}`;
                    if (settlementsPaid.value[key]) {
                        delete settlementsPaid.value[key];
                    } else {
                        settlementsPaid.value[key] = {
                            from: settlement.from,
                            to: settlement.to,
                            amount: settlement.amount,
                            paidAt: new Date().toISOString(),
                            paidBy: currentUser.value
                        };
                    }
                    saveData();
                };
                
                const clearAllSettlementsPaid = () => {
                    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²ä»˜æ¬¾æ¨™è¨˜å—ï¼Ÿ')) {
                        settlementsPaid.value = {};
                        saveData();
                    }
                };
                

                // --- CRUD ---
                const openEventModal = () => { eventForm.value = {id:Date.now(), dayIdx: currentDayIndex.value, time:'10:00', category:'æ™¯é»'}; isEditing.value=false; showEventModal.value=true; };
                const editEvent = (e) => { eventForm.value = {...e}; isEditing.value=true; showEventModal.value=true; };
                const saveEvent = () => { 
                    if(!eventForm.value.title) return;
                    if(isEditing.value) { const i = schedule.value.findIndex(e=>e.id===eventForm.value.id); if(i!==-1) schedule.value[i] = {...eventForm.value}; }
                    else schedule.value.push({...eventForm.value});
                    saveData(); showEventModal.value=false;
                };
                const deleteEvent = () => { if(confirm('åˆªé™¤?')) { schedule.value = schedule.value.filter(e=>e.id!==eventForm.value.id); saveData(); showEventModal.value=false; } };
                const openExpenseModal = () => { 
                    expenseForm.value={
                        id:Date.now(), 
                        category:'é¤é£²', 
                        date: new Date().toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'}), 
                        payer: members.value[0],
                        splitMethod: 'equal',
                        participants: [...members.value], // é è¨­å…¨å“¡åƒèˆ‡
                        customSplits: {}
                    };
                    initCustomSplits();
                    showExpenseModal.value=true; 
                };
				// æ–°å¢ï¼šåˆ‡æ›åƒèˆ‡è€…é¸æ“‡
				const toggleParticipant = (member) => {
					const index = expenseForm.value.participants.indexOf(member);
					if (index === -1) {
						expenseForm.value.participants.push(member);
					} else {
						expenseForm.value.participants.splice(index, 1);
					}
				};

				// æ–°å¢ï¼šåˆå§‹åŒ–è‡ªè¨‚åˆ†æ”¤é‡‘é¡
				const initCustomSplits = () => {
					const splits = {};
					members.value.forEach(m => {
						splits[m] = 0;
					});
					expenseForm.value.customSplits = splits;
				};
                const saveExpense = () => { 
					if(!expenseForm.value.title || !expenseForm.value.amount) {
						errorMessage.value = 'è«‹å¡«å¯«é …ç›®å’Œé‡‘é¡';
						return;
					}
					
					// æ ¹æ“šåˆ†æ”¤æ–¹å¼è¨ˆç®—æ¯äººæ‡‰ä»˜é‡‘é¡
					const expense = {...expenseForm.value};
					const amount = Number(expense.amount);
					
					// è¨ˆç®—åˆ†æ”¤
					if (expense.splitMethod === 'participants') {
						// é¸æ“‡åƒèˆ‡è€…ï¼šåªåœ¨é¸ä¸­çš„åƒèˆ‡è€…ä¹‹é–“å¹³å‡åˆ†æ”¤
						const validParticipants = expense.participants.filter(p => members.value.includes(p));
						if (validParticipants.length === 0) {
							errorMessage.value = 'è«‹è‡³å°‘é¸æ“‡ä¸€ä½åƒèˆ‡è€…';
							return;
						}
						
						if (!validParticipants.includes(expense.payer)) {
							errorMessage.value = 'ä»˜æ¬¾äººå¿…é ˆæ˜¯åƒèˆ‡è€…ä¹‹ä¸€';
							setTimeout(() => errorMessage.value = '', 3000);
							return;
						}
										
						const perPerson = amount / validParticipants.length;
						expense.splitDetails = {
							method: 'participants',
							participants: [...validParticipants],
							perPerson: perPerson,
							totalParticipants: validParticipants.length
						};
						
					} else if (expense.splitMethod === 'custom') {
						// è‡ªè¨‚æ¯”ä¾‹ï¼šä½¿ç”¨è‡ªè¨‚é‡‘é¡
						let customTotal = 0;
						const customSplits = {};
						
						members.value.forEach(member => {
							const memberAmount = Number(expense.customSplits[member]) || 0;
							customSplits[member] = memberAmount;
							customTotal += memberAmount;
						});
						
						// é©—è­‰è‡ªè¨‚é‡‘é¡ç¸½å’Œæ˜¯å¦ç­‰æ–¼ç¸½é‡‘é¡
						if (Math.abs(customTotal - amount) > 1) { // å…è¨±1å…ƒèª¤å·®
							errorMessage.value = `è‡ªè¨‚é‡‘é¡ç¸½å’Œ (Â¥${customTotal}) ä¸ç­‰æ–¼ç¸½é‡‘é¡ (Â¥${amount})`;
							return;
						}
						
						expense.splitDetails = {
							method: 'custom',
							splits: customSplits,
							totalAmount: customTotal
						};
						
					} else {
						// å¹³å‡åˆ†æ”¤ï¼šæ‰€æœ‰æˆå“¡å¹³å‡åˆ†æ”¤
						const perPerson = amount / members.value.length;
						expense.splitDetails = {
							method: 'equal',
							perPerson: perPerson,
							totalParticipants: members.value.length
						};
					}
					
					// æ¸…é™¤ä¸éœ€è¦çš„è¡¨å–®å±¬æ€§
					delete expense.splitMethod;
					delete expense.participants;
					delete expense.customSplits;
					
					expenses.value.push(expense); 
					saveData(); 
					showExpenseModal.value=false; 
				};
                const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) { expenses.value = expenses.value.filter(e=>e.id!==id); saveData(); } };
                const addMember = () => { if(newMemberName.value && !members.value.includes(newMemberName.value)) { members.value.push(newMemberName.value); newMemberName.value=''; saveData(); } };
                const removeMember = (i) => { if(confirm('ç§»é™¤?')) { members.value.splice(i,1); saveData(); } };
                const forceSync = () => pollData();

                // Init
                onMounted(async () => {
                    // Initialize dark mode
                    if (isDarkMode.value) {
                        document.documentElement.classList.replace('light', 'dark');
                    }
					// åˆå§‹åŒ– user identity
					const savedUser = localStorage.getItem('tokyo_user_identity');
					currentUser.value = savedUser || 'è¨ªå®¢';
                    
                    // åˆå§‹åŒ– token å’Œ gist id
                    tempToken.value = githubToken.value;
                    tempGistId.value = gistId.value;
                    
                    // è¼‰å…¥è¡Œææ¸…å–®
                    loadPackingList();
                    
                    // è¼‰å…¥è¡Œç¨‹è³‡æ–™
                    await loadData();
					
					// è¼‰å…¥è³¼ç‰©æ¸…å–®
					await loadShoppingList();
					
					// è¼‰å…¥æ‰€æœ‰åœ–ç‰‡
					await loadAllShoppingImages();
                    
                    // å¦‚æœæ²’æœ‰ tokenï¼Œé¡¯ç¤ºæç¤º
                    if (!hasToken.value) {
                        syncStatus.value = 'error';
                        errorMessage.value = 'è«‹å…ˆè¨­å®š GitHub Token ä»¥å•Ÿç”¨åŒæ­¥åŠŸèƒ½';
                    }
                    
                    // è¨­å®šå®šæ™‚æª¢æŸ¥
                    setInterval(pollData, POLL_INTERVAL);
                });
				
				// åœ¨ onMounted ä¸­æ·»åŠ äº‹ä»¶ç›£è½
				onMounted(() => {
					// åˆå§‹æ›´æ–°æ»¾å‹•æç¤º
					setTimeout(updateScrollGradients, 300);
					
					// ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
					window.addEventListener('resize', handleResize);
					
					// ç›£è½è³¼ç‰©æ¸…å–®è®ŠåŒ–ï¼Œè‡ªå‹•æ»¾å‹•
					watch(shoppingList, async (newList) => {
					  // å»¶é²è¼‰å…¥åœ–ç‰‡ï¼Œé¿å…é˜»å¡ UI
					  setTimeout(async () => {
						await loadAllShoppingImages();
					  }, 100);
					}, { deep: true });
					
					// è‡ªå‹•æ»¾å‹•åˆ°ç¬¬ä¸€å€‹æœ‰é …ç›®çš„åˆ†é¡
					autoScrollToFirstCategory();
					// åˆå§‹åŒ–æ‹–æ›³æ’åº
                    initSortable();
				});

				// åœ¨ onBeforeUnmount ä¸­æ¸…ç†
				onBeforeUnmount(() => {
				  // æ¸…ç†è³¼ç‰©æ¸…å–®ä¸­çš„æ‰€æœ‰ Blob URL
				  shoppingList.value.forEach(item => {
					if (item._imageCleanup && typeof item._imageCleanup === 'function') {
					  item._imageCleanup();
					}
				  });
				  
				  // æ¸…ç†è¡¨å–®ä¸­çš„ Blob URL
				  if (shoppingForm.value._imageCleanup) {
					shoppingForm.value._imageCleanup();
				  }
				  
				  window.removeEventListener('resize', handleResize);
				});

                // **åœ°åœ–ä¿®æ­£ 1**: ç›£è½ currentTab è®ŠåŒ–ï¼Œåˆ‡æ›åˆ°åœ°åœ–æ™‚é‡æ–°è¨ˆç®—å°ºå¯¸
                watch(currentTab, (val) => {
					console.log('ğŸ“± Tab changed to:', val);
					if (val === 'map') {
						nextTick(() => {
							setTimeout(() => {
								initMap();
							}, 150);
						});
					}
				});
							
				watch(bouncingMarkerId, () => {
					if (currentTab.value === 'map' && mapInstance.value) {
						updateMarkers();
					}
				});
				
				// ç›£è½çª—å£å¤§å°è®ŠåŒ–ï¼Œé‡æ–°èª¿æ•´åœ°åœ–å¤§å°ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
				let resizeTimer;
				window.addEventListener('resize', () => {
					clearTimeout(resizeTimer);
					resizeTimer = setTimeout(() => {
						if (currentTab.value === 'map' && mapInstance.value) {
							try {
								mapInstance.value.invalidateSize();
								// æ›´æ–°æ¨™è¨˜ä½ç½®
								updateMarkerPositions();
							} catch (e) {
								console.error('Error resizing map:', e);
							}
						}
					}, 250);
				});
				
				// ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–ï¼Œä¿®å¾©åœ°åœ–é¡¯ç¤ºå•é¡Œ
				document.addEventListener('visibilitychange', () => {
					if (!document.hidden && currentTab.value === 'map' && mapInstance.value) {
						setTimeout(() => {
							try {
								mapInstance.value.invalidateSize();
								updateMarkerPositions();
							} catch (e) {
								console.error('Error invalidating map size:', e);
							}
						}, 300);
					}
				});
				
                return {
					currentTab, currentDayIndex, days, schedule, expenses, members, sortedExpenses, currentDayEvents,
					totalExpense, avgExpense, expenseStats, memberBalances, settlements, hasSettlementsPaid,
					statusText, statusColorClass, lastUpdatedBy, formattedLastUpdate,
					showEventModal, showExpenseModal, showMemberModal, showIdentityModal, showIdentityConfirmModal, showTokenModal, isEditing, eventForm, expenseForm, 
					newMemberName, tempIdentity, tempToken, tempGistId, showTokenInput,
					mapSelectedEvent, mapLoading, isInitialLoading, errorMessage, syncStatus, currentUser, isDarkMode, hasToken,
					highlightedLocation,
					
					// è¡Œææ¸…å–®ç›¸é—œ
					packingList, clearAllPackingChecks, groupedPackingList, packedCount, packedPercentage, showPackingModal, packingForm,
					
					// è³¼ç‰©æ¸…å–®ç›¸é—œè®Šæ•¸
					shoppingList,
					imageInput,
					filteredShoppingList,
					shoppingCategories,
					shoppingCategoryColors,
					showShoppingModal,
					shoppingForm,
					isShoppingEditing,
					viewMode,
					showShoppingFilter,
					activeShoppingCategories,
					purchasedCount,
					purchasedPercentage,
					loadShoppingItemImage,
					
					// åœ°é»é¸æ“‡ç›¸é—œ
					showLocationModal,
					locationSearch,
					locationSearchResults,
					
					
					// åˆ†é¡æ»¾å‹•ç›¸é—œ
					categoryScroll,
					showLeftGradient,
					showRightGradient,
					isCategoryDragging,
					
					// ä¸»è¦åŠŸèƒ½æ–¹æ³•
					switchTab, openEventModal, editEvent, saveEvent, deleteEvent, openExpenseModal, saveExpense, deleteExpense,
					addMember, removeMember, saveIdentity, cancelIdentityChange, handleIdentityClick, saveToken, clearToken, forceSync, 
					openMap, resetMapView, fitMapToMarkers, formatTime, formatNumber, 
					getCategoryColor, getCategoryIcon, toggleDarkMode,
					toggleSettlementPaid, clearAllSettlementsPaid, toggleParticipant,
					
					// è³¼ç‰©æ¸…å–®æ–¹æ³•
					openShoppingModal,
					editShoppingItem,
					saveShoppingItem,
					deleteShoppingItem,
					toggleShoppingPurchased,
					clearAllShoppingChecks,
					toggleShoppingCategory,
					toggleViewMode,
					resetShoppingList,
					openShoppingMap,
					
					// åœ–ç‰‡è™•ç†æ–¹æ³•ï¼ˆæ–°å¢ï¼‰
					imageInput,
					triggerImageUpload,
					handleImageUpload,
					clearImage,  // æ–°å¢ï¼šæ¸…é™¤åœ–ç‰‡
					
					// åœ°é»æ–¹æ³•
					openShoppingMapModal,
					searchLocation,
					selectLocation,
					useEventLocation,
					useCurrentLocation,
					clearShoppingLocation,
					
					// åˆ†é¡æ»¾å‹•æ–¹æ³•
					handleCategoryScroll,
					handleTouchStart,
					handleTouchMove,
					handleTouchEnd,
					handleMouseMove,
					handleCategoryMouseDown,
					updateScrollGradients,
					scrollToCategory,
					autoScrollToFirstCategory,
					
					// è¡Œææ¸…å–®æ–¹æ³•
					savePackingList,  // æ·»åŠ é€™ä¸€è¡Œ
					openPackingModal, 
					editPackingItem, 
					savePackingItem, 
					deletePackingItem, 
					resetPackingList, 
					getCarryTypeIcon
				};
            }
        }).mount('#app');
    </script>
</body>
</html>
