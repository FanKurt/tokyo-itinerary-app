<!DOCTYPE html>
<html lang="zh-TW" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬7å¤©6å¤œ - æ—…è¡ŒåŠ©æ‰‹</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸ—¼</text></svg>">
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tokyo: { DEFAULT: '#e11d48', 50: '#fff1f2', 100: '#ffe4e6', 500: '#f43f5e', 600: '#e11d48', 900: '#881337' }
                    }
                }
            }
        }
    </script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Map Markers */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin { width: 30px; height: 30px; border-radius: 50% 50% 50% 0; background: #e11d48; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 5px rgba(0,0,0,0.3); }
        .marker-pin::after { content: ''; width: 14px; height: 14px; margin: 8px 0 0 8px; background: #fff; position: absolute; border-radius: 50%; }
        .marker-icon { position: absolute; width: 22px; font-size: 16px; left: 0; right: 0; margin: 6px auto; text-align: center; color: white; z-index: 10; transform: rotate(45deg); }
        .marker-æ™¯é» { background: #f43f5e; } .marker-ç¾é£Ÿ { background: #f97316; } .marker-äº¤é€š { background: #3b82f6; } .marker-ä½å®¿ { background: #8b5cf6; } .marker-è³¼ç‰© { background: #10b981; }

        /* Sync Status Animation */
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        .status-syncing { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Animation for modal */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Token input styles */
        .token-input-container { position: relative; }
        .token-input-container i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6b7280; }
        .token-help { font-size: 0.7rem; color: #6b7280; margin-top: 0.25rem; }
        .token-help a { color: #e11d48; text-decoration: underline; }
        
        /* å¿«é€Ÿé‡‘é¡æŒ‰éˆ• */
        .quick-amount-btn { transition: all 0.2s ease; }
        .quick-amount-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 h-screen w-screen overflow-hidden">

    <div id="app" class="h-full flex flex-col relative max-w-lg mx-auto bg-white dark:bg-slate-900 shadow-2xl transition-colors duration-300">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-tokyo-600 to-rose-700 text-white px-4 py-3 shadow-md z-30 flex-shrink-0">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-torii-gate text-2xl"></i>
                    <div>
                        <h1 class="text-lg font-bold tracking-wide">æ±äº¬7å¤©6å¤œ</h1>
                        <div class="flex items-center gap-1 text-[10px] opacity-90 font-mono">
                            <span :class="statusColorClass" class="w-2 h-2 rounded-full inline-block"></span>
                            {{ statusText }}
                            <span v-if="lastUpdatedBy" class="ml-1 opacity-75">by {{ lastUpdatedBy }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Right side buttons - å„ªåŒ–é«˜åº¦ä¸€è‡´ -->
                <div class="flex items-center gap-1.5">
                    <!-- Dark mode toggle -->
                    <button @click="toggleDarkMode" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-lg backdrop-blur-sm hover:bg-white/30 transition">
                        <i class="fa-solid fa-moon text-white text-sm" v-if="!isDarkMode"></i>
                        <i class="fa-solid fa-sun text-white text-sm" v-else></i>
                    </button>
                    
                    <!-- Identify User -->
                    <button @click="handleIdentityClick" class="h-8 px-3 bg-white/20 rounded-lg backdrop-blur-sm flex items-center gap-1.5 hover:bg-white/30 transition text-xs min-w-[70px] justify-center">
                        <i class="fa-solid fa-user-circle text-sm"></i> 
                        <span class="truncate max-w-[50px]">{{ currentUser }}</span>
                    </button>
                    
                    <!-- Token Settings -->
                    <button @click="showTokenModal = true" class="w-8 h-8 flex items-center justify-center bg-white/20 rounded-lg backdrop-blur-sm hover:bg-white/30 transition">
                        <i class="fa-solid fa-key text-white text-sm"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-center text-xs bg-black/10 rounded-lg p-1.5 backdrop-blur-sm">
                <span><i class="fa-regular fa-clock mr-1"></i>æ›´æ–°: {{ formattedLastUpdate }}</span>
                <button @click="forceSync" class="hover:text-yellow-300 transition" :disabled="syncStatus === 'syncing' || !hasToken">
                    <i class="fa-solid fa-rotate" :class="{'status-syncing': syncStatus === 'syncing'}"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-gray-50 dark:bg-slate-900">
            
            <!-- Loading Overlay -->
            <div v-if="isInitialLoading" class="absolute inset-0 z-50 bg-white dark:bg-slate-900 flex flex-col items-center justify-center">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-tokyo-600 mb-4"></i>
                <p class="text-gray-500 font-bold">æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è¡Œç¨‹...</p>
            </div>

            <!-- Error Banner -->
            <div v-if="errorMessage" class="bg-red-500 text-white text-xs p-2 text-center">
                {{ errorMessage }}
            </div>
            
            <!-- No Token Warning -->
            <div v-if="!hasToken && !isInitialLoading" class="bg-amber-500 text-white text-xs p-2 text-center">
                <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                è«‹å…ˆè¨­å®š GitHub Token æ‰èƒ½ä½¿ç”¨åŒæ­¥åŠŸèƒ½
                <button @click="showTokenModal = true" class="ml-2 underline font-bold">ç«‹å³è¨­å®š</button>
            </div>

            <!-- 1. Schedule Tab -->
            <div v-show="currentTab === 'schedule'" class="pb-24 animate-fade-in">
                <!-- Date Selector -->
                <div class="sticky top-0 z-20 bg-gray-50/95 dark:bg-slate-900/95 backdrop-blur border-b border-gray-200 dark:border-slate-800 px-2 py-3 flex gap-2 overflow-x-auto no-scrollbar shadow-sm">
                    <button v-for="(day, index) in days" :key="index"
                        @click="currentDayIndex = index"
                        :class="['flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl transition-all duration-300', 
                                currentDayIndex === index 
                                ? 'bg-tokyo-600 text-white shadow-lg shadow-rose-200 dark:shadow-none scale-105 transform' 
                                : 'bg-white dark:bg-slate-800 text-gray-400 dark:text-gray-500 border border-gray-100 dark:border-slate-700']">
                        <span class="text-[10px] font-bold uppercase tracking-wider">{{ day.week }}</span>
                        <span class="text-lg font-bold font-mono">{{ day.date.split('/')[1] }}</span>
                    </button>
                </div>

                <!-- Action Button -->
                <div class="px-4 mt-4 flex justify-end">
                    <button @click="openEventModal" class="bg-tokyo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg hover:bg-tokyo-700 active:scale-95 transition flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹
                    </button>
                </div>

                <!-- Timeline -->
                <div class="p-4 space-y-5">
                    <div v-if="currentDayEvents.length === 0" class="flex flex-col items-center justify-center py-20 opacity-50">
                        <i class="fa-brands fa-pagelines text-5xl mb-4 text-tokyo-600"></i>
                        <p class="text-sm font-medium">æœ¬æ—¥å°šç„¡è¡Œç¨‹</p>
                    </div>

                    <div v-for="(event, idx) in currentDayEvents" :key="event.id" class="relative pl-2 group">
                        <div class="flex gap-4">
                            <!-- Time Column -->
                            <div class="flex flex-col items-center pt-1 w-12 shrink-0">
                                <span class="text-xs font-bold text-gray-500 dark:text-gray-400 font-mono">{{ formatTime(event.time) }}</span>
                                <div class="h-full w-[2px] bg-gray-200 dark:bg-slate-700 my-2 rounded-full relative group-last:bg-transparent">
                                    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-3 h-3 rounded-full border-2 border-white dark:border-slate-800 shadow-sm" :class="getCategoryColor(event.category, true)"></div>
                                </div>
                            </div>

                            <!-- Card -->
                            <div @click="editEvent(event)" class="flex-1 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700 active:scale-[0.98] transition-transform">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg leading-tight">{{ event.title }}</h3>
                                    <span :class="['text-[10px] px-2 py-1 rounded-full font-bold text-white', getCategoryColor(event.category, true)]">
                                        {{ event.category }}
                                    </span>
                                </div>
                                <div v-if="event.location" class="flex items-start text-xs text-gray-500 dark:text-gray-400 mb-2">
                                    <i class="fa-solid fa-location-dot mt-0.5 mr-1.5 text-tokyo-500"></i>
                                    <span class="line-clamp-1">{{ event.location }}</span>
                                </div>
                                <div v-if="event.note" class="bg-rose-50 dark:bg-slate-700/50 p-2.5 rounded-lg text-xs text-rose-800 dark:text-rose-200 mb-3 whitespace-pre-wrap leading-relaxed border border-rose-100 dark:border-slate-700">
                                    {{ event.note }}
                                </div>
                                <div class="flex gap-2 mt-2 pt-2 border-t border-gray-50 dark:border-slate-700" @click.stop>
                                    <button @click="openMap(event)" class="flex-1 h-10 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-xs font-bold hover:bg-blue-100 transition flex items-center justify-center gap-1">
                                        <i class="fa-solid fa-location-arrow"></i> å°èˆª
                                    </button>
                                    <button @click="editEvent(event)" class="w-10 h-10 rounded-lg bg-gray-50 dark:bg-slate-700 text-gray-400 hover:bg-gray-100 transition flex items-center justify-center">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Expense Tab -->
            <div v-show="currentTab === 'expense'" class="pb-24 animate-fade-in">
                 <div class="px-4 mt-4 flex justify-end gap-2">
                    <button @click="showMemberModal = true" class="bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 px-3 py-2 rounded-full text-sm font-bold">
                        <i class="fa-solid fa-users"></i> æˆå“¡
                    </button>
                    <button @click="openExpenseModal" class="bg-tokyo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg hover:bg-tokyo-700 active:scale-95 transition">
                        <i class="fa-solid fa-plus"></i> è¨˜å¸³
                    </button>
                </div>

                <!-- Dashboard -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-5 m-4 rounded-2xl shadow-xl relative overflow-hidden">
                    <div class="flex justify-between items-end mb-4 relative z-10">
                        <div>
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">ç¸½æ”¯å‡º</p>
                            <h2 class="text-3xl font-bold font-mono">Â¥ {{ formatNumber(totalExpense) }}</h2>
                        </div>
                        <div class="text-right">
                            <p class="text-slate-400 text-[10px] uppercase">æ¯äººå‡æ”¤</p>
                            <p class="text-lg font-bold font-mono text-emerald-400">Â¥ {{ formatNumber(Math.round(avgExpense)) }}</p>
                        </div>
                    </div>
                    <!-- Stats Bar -->
                    <div class="flex h-3 rounded-full overflow-hidden bg-slate-700 w-full mb-4">
                        <div v-for="cat in expenseStats" :key="cat.name" :style="{ width: cat.percent + '%', backgroundColor: cat.color }" class="h-full"></div>
                    </div>
                    
                    <!-- è¦–è¦ºåŒ–åœ–è¡¨å€åŸŸ -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <!-- æ¯äººæ”¯å‡ºæ¯”ä¾‹ -->
                        <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm border border-white/10">
                            <p class="text-[10px] text-slate-300 font-bold mb-2">æ¯äººæ”¯å‡º</p>
                            <div v-for="member in memberBalances" :key="member.name" class="flex items-center mb-1.5">
                                <div class="w-2 h-2 rounded-full mr-2" :style="{backgroundColor: member.color}"></div>
                                <span class="text-xs flex-1 truncate">{{ member.name }}</span>
                                <span class="text-xs font-mono">Â¥{{ formatNumber(member.amount) }}</span>
                            </div>
                        </div>
                        
                        <!-- åˆ†é¡æ”¯å‡ºé•·æ¢åœ– -->
                        <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm border border-white/10">
                            <p class="text-[10px] text-slate-300 font-bold mb-2">åˆ†é¡æ”¯å‡º</p>
                            <div v-for="cat in expenseStats" :key="cat.name" class="mb-1.5">
                                <div class="flex justify-between text-[10px] mb-0.5">
                                    <span>{{ cat.name }}</span>
                                    <span>{{ cat.percent.toFixed(0) }}%</span>
                                </div>
                                <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                    <div :style="{width: cat.percent+'%', backgroundColor: cat.color}" class="h-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settlement -->
                    <div class="bg-white/10 rounded-xl p-3 backdrop-blur-sm border border-white/10">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-[10px] text-emerald-400 font-bold">çµç®—å»ºè­°</p>
                            <button @click="clearAllSettlementsPaid" v-if="hasSettlementsPaid" 
                                    class="text-[10px] text-slate-400 hover:text-slate-300 px-2 py-1 rounded hover:bg-white/5 transition-colors">
                                <i class="fa-solid fa-rotate-right mr-1"></i>é‡ç½®
                            </button>
                        </div>
                        <div v-for="(s, i) in settlements" :key="i" class="flex justify-between items-center text-xs py-2 border-b border-white/10 last:border-0">
                            <div class="flex items-center gap-2">
                                <button @click="toggleSettlementPaid(s)" class="w-4 h-4 rounded border flex items-center justify-center transition-all" 
                                        :class="s.paid ? 'bg-emerald-500 border-emerald-500' : 'border-slate-400 hover:border-emerald-400'">
                                    <i v-if="s.paid" class="fa-solid fa-check text-white text-[8px]"></i>
                                </button>
                                <span class="font-bold">{{ s.from }}</span>
                                <i class="fa-solid fa-arrow-right text-slate-500"></i>
                                <span class="font-bold text-emerald-300">{{ s.to }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-mono">Â¥{{ formatNumber(s.amount) }}</span>
                                <span v-if="s.paid" class="text-[10px] text-emerald-400 px-2 py-0.5 bg-emerald-900/30 rounded-full">å·²çµæ¸…</span>
                            </div>
                        </div>
                        <div v-if="settlements.length === 0" class="text-xs text-center text-slate-400 py-2">å¸³ç›®å¹³è¡¡</div>
                    </div>
                </div>

                <!-- List -->
                <div class="px-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">æœ€è¿‘æ”¯å‡º</h3>
                    <div v-for="item in sortedExpenses" :key="item.id" class="bg-white dark:bg-slate-800 p-3.5 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 mb-3 flex justify-between items-center group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm" :class="getCategoryColor(item.category, true)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 dark:text-gray-200 text-sm">{{ item.title }}</p>
                                <p class="text-[10px] text-gray-400 dark:text-gray-500 font-medium">
                                    {{ item.date }} â€¢ <span class="text-tokyo-600 dark:text-tokyo-400">{{ item.payer }}</span> å…ˆä»˜
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-800 dark:text-gray-200 font-mono">Â¥{{ formatNumber(item.amount) }}</p>
                            <button @click="deleteExpense(item.id)" class="text-[10px] text-red-400 opacity-0 group-hover:opacity-100 px-2 py-1">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Map Tab -->
			<div v-show="currentTab === 'map'" class="h-full w-full relative">
				<div id="mapContainer" class="w-full h-full bg-slate-100 dark:bg-slate-800 z-0"></div>
				<div class="absolute top-4 right-4 bg-white/90 dark:bg-slate-900/90 backdrop-blur p-2 rounded-lg shadow-lg z-[400] text-[10px] flex flex-col gap-1">
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-rose-500"></div>æ™¯é»</div>
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-orange-500"></div>ç¾é£Ÿ</div>
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-blue-500"></div>äº¤é€š</div>
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-purple-500"></div>ä½å®¿</div>
					<div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-emerald-500"></div>è³¼ç‰©</div>
				</div>
				<!-- Map Card -->
				<div v-if="mapSelectedEvent" class="absolute bottom-24 left-4 right-4 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-2xl z-[500] border border-gray-100 dark:border-slate-700 animate-slide-up">
					<div class="flex justify-between items-start mb-2">
						<h3 class="font-bold text-lg text-gray-800 dark:text-white">{{ mapSelectedEvent.title }}</h3>
						<button @click="mapSelectedEvent = null" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
					</div>
					<p class="text-xs text-gray-500 mb-4">{{ mapSelectedEvent.location }}</p>
					<a :href="`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapSelectedEvent.location)}`" target="_blank"
					   class="block w-full text-center bg-tokyo-600 text-white py-3 rounded-xl text-sm font-bold shadow-lg">é–‹å•Ÿ Google Maps</a>
				</div>
			</div>
        </main>

        <!-- Bottom Nav -->
        <nav class="bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-800 flex justify-around items-center h-[85px] pb-5 px-2 safe-bottom z-30 absolute bottom-0 w-full shadow-lg">
            <button @click="switchTab('schedule')" :class="['flex flex-col items-center justify-center w-full h-full rounded-xl', currentTab === 'schedule' ? 'text-tokyo-600 dark:text-tokyo-400' : 'text-gray-400']">
                <i class="fa-solid fa-calendar-days text-xl mb-1"></i><span class="text-[10px] font-bold">è¡Œç¨‹</span>
            </button>
            <button @click="switchTab('expense')" :class="['flex flex-col items-center justify-center w-full h-full rounded-xl', currentTab === 'expense' ? 'text-tokyo-600 dark:text-tokyo-400' : 'text-gray-400']">
                <i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px] font-bold">åˆ†å¸³</span>
            </button>
            <button @click="switchTab('map')" :class="['flex flex-col items-center justify-center w-full h-full rounded-xl', currentTab === 'map' ? 'text-tokyo-600 dark:text-tokyo-400' : 'text-gray-400']">
                <i class="fa-solid fa-map-location-dot text-xl mb-1"></i><span class="text-[10px] font-bold">åœ°åœ–</span>
            </button>
        </nav>

        <!-- Identity Modal (First Load) -->
        <div v-if="showIdentityModal" class="absolute inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <div class="text-center mb-6">
                    <i class="fa-solid fa-user-astronaut text-4xl text-tokyo-600 mb-2"></i>
                    <h3 class="text-xl font-bold">è«‹å•ä½ æ˜¯èª°ï¼Ÿ</h3>
                    <p class="text-xs text-gray-500">é€™æœƒé¡¯ç¤ºåœ¨æœ€å¾Œç·¨è¼¯è€…è³‡è¨Šä¸­</p>
                </div>
                <input v-model="tempIdentity" @keyup.enter="saveIdentity" placeholder="è¼¸å…¥æš±ç¨± (ä¾‹å¦‚: Alice)" class="w-full bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center font-bold text-lg border-2 border-transparent focus:border-tokyo-500 outline-none mb-4 dark:text-white">
                <button @click="saveIdentity" :disabled="!tempIdentity" class="w-full bg-tokyo-600 text-white py-3 rounded-xl font-bold disabled:opacity-50">é–‹å§‹ä½¿ç”¨</button>
            </div>
        </div>
        
        <!-- Token Setup Modal -->
        <div v-if="showTokenModal" class="absolute inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
            <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <div class="text-center mb-6">
                    <i class="fa-solid fa-key text-4xl text-tokyo-600 mb-2"></i>
                    <h3 class="text-xl font-bold">GitHub Token è¨­å®š</h3>
                    <p class="text-xs text-gray-500">éœ€è¦ Token æ‰èƒ½åŒæ­¥è³‡æ–™åˆ°é›²ç«¯</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-bold mb-2">GitHub Token</label>
                    <div class="token-input-container">
                        <input 
                            :type="showTokenInput ? 'text' : 'password'" 
                            v-model="tempToken" 
                            placeholder="è¼¸å…¥æ‚¨çš„ GitHub Personal Access Token" 
                            class="w-full bg-gray-50 dark:bg-slate-800 p-4 rounded-xl border-2 border-transparent focus:border-tokyo-500 outline-none dark:text-white pr-10">
                        <i @click="showTokenInput = !showTokenInput" :class="showTokenInput ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                    </div>
                    <p class="token-help">
                        <a href="https://github.com/settings/tokens/new" target="_blank" class="font-bold">å¦‚ä½•å–å¾— Tokenï¼Ÿ</a>
                        éœ€è¦æˆäºˆ gist æ¬Šé™ï¼Œä¸¦å„²å­˜åœ¨æœ¬åœ°ç«¯
                    </p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-2">Gist ID</label>
                    <input v-model="tempGistId" placeholder="è¼¸å…¥ Gist ID" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 dark:text-white">
                    <p class="token-help">é è¨­ç‚ºç¯„ä¾‹ Gist IDï¼Œå¯æ”¹ç‚ºè‡ªå·±çš„</p>
                </div>
                
                <div class="flex gap-3">
                    <button @click="showTokenModal = false" class="px-5 py-3 rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 font-bold flex-1">
                        å–æ¶ˆ
                    </button>
                    <button @click="saveToken" :disabled="!tempToken" class="px-5 py-3 rounded-xl bg-tokyo-600 text-white font-bold flex-1 disabled:opacity-50">
                        å„²å­˜è¨­å®š
                    </button>
                </div>
            </div>
        </div>

        <!-- Event Modal -->
        <div v-if="showEventModal" class="absolute inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="showEventModal = false">
            <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-auto max-h-[90vh] overflow-y-auto animate-slide-up">
                <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                <div class="space-y-4">
                    <input v-model="eventForm.title" placeholder="æ¨™é¡Œ" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold dark:text-white">
                    <div class="flex gap-2">
                        <input type="time" v-model="eventForm.time" class="w-1/3 bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold text-center dark:text-white">
                        <select v-model="eventForm.category" class="flex-1 bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold dark:text-white">
                            <option value="æ™¯é»">ğŸ—» æ™¯é»</option><option value="ç¾é£Ÿ">ğŸ± ç¾é£Ÿ</option><option value="äº¤é€š">ğŸš„ äº¤é€š</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                        </select>
                    </div>
                    <input v-model="eventForm.location" placeholder="åœ°é» (Google Map)" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 dark:text-white">
                    <textarea v-model="eventForm.note" placeholder="å‚™è¨»..." rows="3" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 resize-none dark:text-white"></textarea>
                </div>
                <div class="flex gap-3 mt-6">
                    <button v-if="isEditing" @click="deleteEvent" class="w-12 h-12 rounded-xl bg-red-50 text-red-500 flex items-center justify-center">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <button @click="showEventModal = false" class="px-5 py-3 rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 font-bold">
                        å–æ¶ˆ
                    </button>
                    <button @click="saveEvent" class="flex-1 bg-tokyo-600 text-white rounded-xl font-bold py-3">
                        å„²å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- Expense Modal -->
        <div v-if="showExpenseModal" class="absolute inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="showExpenseModal = false">
            <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">æ–°å¢æ”¯å‡º</h3>
                <div class="space-y-4">
                    <input v-model="expenseForm.title" placeholder="é …ç›®" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold dark:text-white">
                    
                    <!-- å¿«é€Ÿé‡‘é¡æŒ‰éˆ• -->
                    <div>
                        <p class="text-xs font-bold text-gray-400 mb-2">å¿«é€Ÿé‡‘é¡</p>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button v-for="amt in [500, 1000, 2000, 5000, 10000, 20000]" 
                                    @click="expenseForm.amount = amt"
                                    class="quick-amount-btn px-3 py-2 bg-gray-100 dark:bg-slate-700 rounded-lg text-sm font-mono hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors">
                                Â¥{{ amt.toLocaleString() }}
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-gray-400 font-bold">Â¥</span>
                        <input type="number" 
                               v-model.number="expenseForm.amount" 
                               inputmode="decimal"
                               placeholder="è¼¸å…¥é‡‘é¡"
                               class="w-full bg-gray-50 dark:bg-slate-800 pl-8 p-3 rounded-xl border border-gray-200 dark:border-slate-700 text-xl font-mono font-bold dark:text-white">
                    </div>
                    
                    <select v-model="expenseForm.category" class="w-full bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 font-bold dark:text-white">
                         <option value="é¤é£²">ğŸ± é¤é£²</option><option value="äº¤é€š">ğŸš„ äº¤é€š</option><option value="ä½å®¿">ğŸ¨ ä½å®¿</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="é–€ç¥¨">ğŸŸï¸ é–€ç¥¨</option><option value="å…¶ä»–">ğŸ”¹ å…¶ä»–</option>
                    </select>
                    
                    <!-- åˆ†æ”¤æ–¹å¼é¸æ“‡ -->
                    <div>
                        <p class="text-xs font-bold text-gray-400 mb-2">åˆ†æ”¤æ–¹å¼</p>
                        <div class="flex gap-2 mb-3">
                            <button @click="expenseForm.splitMethod = 'equal'" 
                                    :class="['px-3 py-2 rounded-lg text-sm font-bold border', expenseForm.splitMethod === 'equal' ? 'bg-blue-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-gray-500 border-gray-200 dark:border-slate-700']">
                                å¹³å‡åˆ†æ”¤
                            </button>
                            <button @click="expenseForm.splitMethod = 'participants'" 
                                    :class="['px-3 py-2 rounded-lg text-sm font-bold border', expenseForm.splitMethod === 'participants' ? 'bg-blue-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-gray-500 border-gray-200 dark:border-slate-700']">
                                é¸æ“‡åƒèˆ‡è€…
                            </button>
                        </div>
                        
                        <!-- é¸æ“‡åƒèˆ‡è€… -->
                        <div v-if="expenseForm.splitMethod === 'participants'" class="mt-2">
                            <p class="text-xs font-bold text-gray-400 mb-2">åƒèˆ‡è€…</p>
                            <div class="flex flex-wrap gap-2">
                                <button v-for="m in members" :key="m" 
                                        @click="toggleParticipant(m)"
                                        :class="['px-3 py-1.5 rounded-lg text-sm font-bold border', expenseForm.participants.includes(m) ? 'bg-emerald-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-gray-500 border-gray-200 dark:border-slate-700']">
                                    {{ m }}
                                </button>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div>
                        <p class="text-xs font-bold text-gray-400 mb-2">ä»˜æ¬¾äºº</p>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="m in members" :key="m" 
                                    @click="expenseForm.payer = m" 
                                    :class="['px-3 py-2 rounded-lg text-sm font-bold border', expenseForm.payer === m ? 'bg-emerald-500 text-white border-transparent' : 'bg-white dark:bg-slate-800 text-gray-500 border-gray-200 dark:border-slate-700']">
                                {{ m }}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button @click="showExpenseModal = false" class="px-5 py-3 rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 font-bold">
                        å–æ¶ˆ
                    </button>
                    <button @click="saveExpense" class="flex-1 bg-tokyo-600 text-white rounded-xl font-bold py-3">
                        è¨˜å¸³
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Member Modal -->
        <div v-if="showMemberModal" class="absolute inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center" @click.self="showMemberModal = false">
            <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
                <h3 class="text-xl font-bold mb-4 dark:text-white">æ—…ä¼´ç®¡ç†</h3>
                <div class="flex flex-wrap gap-2 mb-4">
                    <div v-for="(m, idx) in members" :key="idx" class="bg-gray-100 dark:bg-slate-800 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 dark:text-white">
                        {{ m }} <button @click="removeMember(idx)" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input v-model="newMemberName" placeholder="åå­—" class="flex-1 bg-gray-50 dark:bg-slate-800 p-3 rounded-xl border border-gray-200 dark:border-slate-700 dark:text-white">
                    <button @click="addMember" class="px-5 bg-slate-800 text-white rounded-xl font-bold">æ–°å¢</button>
                </div>
                <button @click="showMemberModal = false" class="w-full mt-4 py-3 bg-gray-100 dark:bg-slate-800 text-gray-500 font-bold rounded-xl">å®Œæˆ</button>
            </div>
        </div>

		<!-- ä¿®æ­£å¾Œå®Œæ•´çš„è®Šæ›´èº«åˆ†æ¨¡æ…‹çª— -->
		<div v-if="showIdentityConfirmModal" class="absolute inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-center justify-center p-6">
			<div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
				<div class="text-center mb-6">
					<i class="fa-solid fa-user-edit text-4xl text-tokyo-600 mb-2"></i>
					<h3 class="text-xl font-bold">è®Šæ›´èº«åˆ†</h3>
					<p class="text-xs text-gray-500">æ‚¨ç›®å‰çš„èº«åˆ†æ˜¯ <span class="font-bold text-tokyo-600">{{ currentUser }}</span></p>
				</div>
				<div class="space-y-4">
					<input v-model="tempIdentity" @keyup.enter="saveIdentity" placeholder="è¼¸å…¥æ–°çš„æš±ç¨±" class="w-full bg-gray-50 dark:bg-slate-800 p-4 rounded-xl text-center font-bold text-lg border-2 border-transparent focus:border-tokyo-500 outline-none dark:text-white">
					<p class="text-xs text-gray-500 text-center">é€™æœƒé¡¯ç¤ºåœ¨æœ€å¾Œç·¨è¼¯è€…è³‡è¨Šä¸­</p>
				</div>
				<div class="flex gap-3 mt-6">
					<button @click="cancelIdentityChange" class="flex-1 px-5 py-3 rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-300 font-bold">
						å–æ¶ˆ
					</button>
					<button @click="saveIdentity" :disabled="!tempIdentity" class="flex-1 px-5 py-3 bg-tokyo-600 text-white rounded-xl font-bold disabled:opacity-50">
						ç¢ºèªè®Šæ›´
					</button>
				</div>
			</div>
		</div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        // ==========================================
        // é è¨­ Gist ID (ç¯„ä¾‹è³‡æ–™)
        // ==========================================
        const DEFAULT_GIST_ID = 'df4aba5cee34ffcce2af18ab3de7ccda'; 
        const GIST_FILENAME = 'tokyo_trip_data.json';
        const POLL_INTERVAL = 5000; // 5ç§’æª¢æŸ¥ä¸€æ¬¡

        createApp({
            setup() {
                // --- Sync State ---
                const syncStatus = ref('idle'); // idle, syncing, error, offline
                const lastUpdated = ref(null);
                const lastUpdatedBy = ref('');
                const currentUser = ref(localStorage.getItem('tokyo_user_identity') || 'è¨ªå®¢');
                const isInitialLoading = ref(true);
                const errorMessage = ref('');
                
                // --- Token Management ---
                const githubToken = ref(localStorage.getItem('tokyo_github_token') || '');
                const gistId = ref(localStorage.getItem('tokyo_gist_id') || DEFAULT_GIST_ID);
                const hasToken = computed(() => !!githubToken.value);
                const showTokenModal = ref(false);
                const tempToken = ref('');
                const tempGistId = ref('');
                const showTokenInput = ref(false);

                // --- Dark Mode State ---
                const isDarkMode = ref(localStorage.getItem('tokyo_dark_mode') === 'true' || window.matchMedia('(prefers-color-scheme: dark)').matches);

                // --- App State ---
                const currentTab = ref('schedule');
                const currentDayIndex = ref(0);
                const days = [
                    { date: '12/18', week: 'é€±å››' }, { date: '12/19', week: 'é€±äº”' },
                    { date: '12/20', week: 'é€±å…­' }, { date: '12/21', week: 'é€±æ—¥' },
                    { date: '12/22', week: 'é€±ä¸€' }, { date: '12/23', week: 'é€±äºŒ' },
                    { date: '12/24', week: 'é€±ä¸‰' }
                ];

                // Data Containers
                const schedule = ref([]);
                const expenses = ref([]);
                const members = ref(['æˆ‘', 'æ—…ä¼´A']);
                
                // æ–°å¢ï¼šåˆ†å¸³ç‹€æ…‹è¿½è¹¤
                const settlementsPaid = ref({});

                // Forms & Modals
                const showEventModal = ref(false);
                const showExpenseModal = ref(false);
                const showMemberModal = ref(false);
                const showIdentityModal = ref(!localStorage.getItem('tokyo_user_identity'));
                const showIdentityConfirmModal = ref(false); // æ–°å¢ï¼šèº«åˆ†ç¢ºèªæ¨¡æ…‹çª—
                const isEditing = ref(false);
                const eventForm = ref({});
                const expenseForm = ref({ 
                    title: '', 
                    amount: '', 
                    payer: '', 
                    category: 'é¤é£²',
                    splitMethod: 'equal', // equal, participants, custom
                    participants: [],
                    customSplits: {}
                });
                const newMemberName = ref('');
                const tempIdentity = ref('');

                // Map
                const mapInstance = ref(null);
                const mapMarkers = ref([]);
                const mapSelectedEvent = ref(null);

                // --- èº«åˆ†ç®¡ç†å‡½æ•¸ ---
                const handleIdentityClick = () => {
                    if (currentUser.value === 'è¨ªå®¢' || !localStorage.getItem('tokyo_user_identity')) {
                        // å¦‚æœæ²’æœ‰è¨­å®šéèº«åˆ†ï¼Œç›´æ¥æ‰“é–‹è¨­å®šè¦–çª—
                        showIdentityModal.value = true;
                        tempIdentity.value = '';
                    } else {
                        // å¦‚æœå·²ç¶“æœ‰èº«åˆ†ï¼Œæ‰“é–‹ç¢ºèª/ä¿®æ”¹è¦–çª—
                        tempIdentity.value = currentUser.value;
                        showIdentityConfirmModal.value = true;
                    }
                };
                
                const saveIdentity = () => {
                    if (tempIdentity.value.trim()) {
                        currentUser.value = tempIdentity.value.trim();
                        localStorage.setItem('tokyo_user_identity', currentUser.value);
                        
                        // é—œé–‰æ¨¡æ…‹çª—
                        showIdentityModal.value = false;
                        showIdentityConfirmModal.value = false;
                        tempIdentity.value = '';
                        
                        // å¦‚æœæœ‰ tokenï¼Œæ›´æ–°è³‡æ–™ä»¥åæ˜ æ–°çš„ç·¨è¼¯è€…
                        if (hasToken.value) {
                            saveData();
                        }
                    }
                };
                
                const cancelIdentityChange = () => {
                    showIdentityConfirmModal.value = false;
                    tempIdentity.value = '';
                };

                // --- Token Functions ---
                const saveToken = () => {
                    if (tempToken.value) {
                        githubToken.value = tempToken.value;
                        localStorage.setItem('tokyo_github_token', tempToken.value);
                        
                        if (tempGistId.value) {
                            gistId.value = tempGistId.value;
                            localStorage.setItem('tokyo_gist_id', tempGistId.value);
                        }
                        
                        showTokenModal.value = false;
                        tempToken.value = '';
                        tempGistId.value = '';
                        
                        // è¼‰å…¥è³‡æ–™
                        loadData();
                    }
                };
                
                const clearToken = () => {
                    if (confirm('ç¢ºå®šè¦æ¸…é™¤ Token å—ï¼Ÿé€™æœƒåœæ­¢åŒæ­¥åŠŸèƒ½ã€‚')) {
                        localStorage.removeItem('tokyo_github_token');
                        githubToken.value = '';
                        syncStatus.value = 'error';
                        errorMessage.value = 'Token å·²æ¸…é™¤ï¼Œè«‹é‡æ–°è¨­å®šä»¥å•Ÿç”¨åŒæ­¥åŠŸèƒ½';
                    }
                };

                // --- Dark Mode Functions ---
                const toggleDarkMode = () => {
                    isDarkMode.value = !isDarkMode.value;
                    if (isDarkMode.value) {
                        document.documentElement.classList.replace('light', 'dark');
                    } else {
                        document.documentElement.classList.replace('dark', 'light');
                    }
                    localStorage.setItem('tokyo_dark_mode', isDarkMode.value);
                };

                // --- API Service ---
                const fetchGistData = async () => {
                    if (!gistId.value) return null;
                    try {
                        const response = await fetch(`https://api.github.com/gists/${gistId.value}`);
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        const content = JSON.parse(data.files[GIST_FILENAME].content);
                        return content;
                    } catch (error) {
                        console.error('Fetch error:', error);
                        syncStatus.value = 'error';
                        if (!hasToken.value) {
                            errorMessage.value = 'è«‹å…ˆè¨­å®š GitHub Token';
                        } else {
                            errorMessage.value = 'è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Gist ID å’Œ Token æ˜¯å¦æ­£ç¢º';
                        }
                        return null;
                    }
                };

                const updateGistData = async (newData) => {
                    if (!gistId.value || !githubToken.value) {
                        errorMessage.value = 'è«‹è¨­å®š Gist ID å’Œ Token';
                        syncStatus.value = 'error';
                        return;
                    }
                    syncStatus.value = 'syncing';
                    try {
                        const payload = {
                            files: {
                                [GIST_FILENAME]: {
                                    content: JSON.stringify(newData)
                                }
                            }
                        };
                        const response = await fetch(`https://api.github.com/gists/${gistId.value}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `token ${githubToken.value}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error('Save failed');
                        syncStatus.value = 'idle';
                        errorMessage.value = '';
                        lastUpdated.value = newData.lastUpdated;
                        lastUpdatedBy.value = newData.lastUpdatedBy;
                    } catch (error) {
                        console.error('Update error:', error);
                        syncStatus.value = 'error';
                        errorMessage.value = 'åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Token æ˜¯å¦æœ‰æ•ˆ';
                    }
                };

                // --- Sync Logic ---
                const applyData = (data) => {
                    if (!data) return;
                    // Check if remote is newer
                    const remoteTime = new Date(data.lastUpdated).getTime();
                    const localTime = lastUpdated.value ? new Date(lastUpdated.value).getTime() : 0;

                    if (remoteTime > localTime) {
                        schedule.value = data.schedule || [];
                        expenses.value = data.expenses || [];
                        members.value = data.members || [];
                        settlementsPaid.value = data.settlementsPaid || {};
                        lastUpdated.value = data.lastUpdated;
                        lastUpdatedBy.value = data.lastUpdatedBy;
                    }
                };

                const pollData = async () => {
                    if (document.hidden || !hasToken.value) return; // Don't poll if tab hidden or no token
                    const data = await fetchGistData();
                    if (data) applyData(data);
                };

                const saveData = async () => {
                    if (!hasToken.value) {
                        errorMessage.value = 'è«‹å…ˆè¨­å®š GitHub Token æ‰èƒ½åŒæ­¥';
                        return;
                    }
                    
                    const now = new Date().toISOString();
                    const newData = {
                        lastUpdated: now,
                        lastUpdatedBy: currentUser.value,
                        schedule: schedule.value,
                        expenses: expenses.value,
                        members: members.value,
                        settlementsPaid: settlementsPaid.value
                    };
                    // Optimistic update locally
                    lastUpdated.value = now;
                    lastUpdatedBy.value = currentUser.value;
                    
                    await updateGistData(newData);
                };
                
                const loadData = async () => {
                    if (!hasToken.value) {
                        isInitialLoading.value = false;
                        return;
                    }
                    
                    const data = await fetchGistData();
                    if (data) applyData(data);
                    isInitialLoading.value = false;
                };

                // --- Computed ---
                const statusText = computed(() => {
                    if (!hasToken.value) return 'æœªè¨­å®š Token';
                    if (syncStatus.value === 'syncing') return 'åŒæ­¥ä¸­...';
                    if (syncStatus.value === 'error') return 'é€£ç·šéŒ¯èª¤';
                    return 'å·²åŒæ­¥';
                });

                const statusColorClass = computed(() => {
                    if (!hasToken.value) return 'bg-amber-500';
                    if (syncStatus.value === 'syncing') return 'bg-yellow-400 animate-pulse';
                    if (syncStatus.value === 'error') return 'bg-red-500';
                    return 'bg-green-500';
                });

                const formattedLastUpdate = computed(() => {
                    if (!lastUpdated.value) return 'ç„¡è¨˜éŒ„';
                    const date = new Date(lastUpdated.value);
                    return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                });

                const currentDayEvents = computed(() => schedule.value.filter(e => e.dayIdx === currentDayIndex.value).sort((a,b) => a.time.localeCompare(b.time)));
                const sortedExpenses = computed(() => [...expenses.value].reverse());
                const totalExpense = computed(() => expenses.value.reduce((acc, cur) => acc + Number(cur.amount), 0));
                const avgExpense = computed(() => members.value.length ? totalExpense.value / members.value.length : 0);
                
                const expenseStats = computed(() => {
                    const stats = {};
                    expenses.value.forEach(e => stats[e.category] = (stats[e.category] || 0) + Number(e.amount));
                    const colors = { 'é¤é£²': '#f97316', 'äº¤é€š': '#3b82f6', 'ä½å®¿': '#8b5cf6', 'è³¼ç‰©': '#10b981', 'é–€ç¥¨': '#f43f5e', 'å…¶ä»–': '#64748b' };
                    return Object.keys(stats).map(key => ({ name: key, percent: (stats[key]/totalExpense.value)*100, color: colors[key]||'#ccc' })).sort((a,b)=>b.percent-a.percent);
                });
                
                // æ–°å¢ï¼šæ¯äººæ”¯å‡ºçµ±è¨ˆ
                const memberBalances = computed(() => {
                    const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#06b6d4'];
                    const bal = {};
                    members.value.forEach((m, idx) => bal[m] = { name: m, amount: 0, color: colors[idx % colors.length] });
                    
                    expenses.value.forEach(e => {
                        if (bal[e.payer]) {
                            bal[e.payer].amount += Number(e.amount);
                        }
                    });
                    
                    return Object.values(bal);
                });
                
                // æ–°å¢ï¼šæ˜¯å¦æœ‰å·²ä»˜æ¬¾é …ç›®
                const hasSettlementsPaid = computed(() => {
                    return Object.keys(settlementsPaid.value).length > 0;
                });

                // ä¿®æ”¹ï¼šçµç®—å»ºè­°ï¼ŒåŠ å…¥å·²ä»˜æ¬¾ç‹€æ…‹
                const settlements = computed(() => {
                    if(!expenses.value.length) return [];
                    const bal = {}; members.value.forEach(m => bal[m] = 0);
                    
                    // è¨ˆç®—æ¯äººå¯¦éš›æ”¯å‡º
                    expenses.value.forEach(e => { 
                        if(bal[e.payer] !== undefined) bal[e.payer] += Number(e.amount); 
                    });
                    
                    const diffs = members.value.map(m => ({ name: m, val: bal[m] - avgExpense.value })).sort((a,b) => a.val - b.val);
                    const res = [];
                    let i=0, j=diffs.length-1;
                    while(i < j) {
                        if(Math.abs(diffs[i].val) < 1) { i++; continue; }
                        if(Math.abs(diffs[j].val) < 1) { j--; continue; }
                        const amt = Math.min(Math.abs(diffs[i].val), diffs[j].val);
                        res.push({ from: diffs[i].name, to: diffs[j].name, amount: Math.round(amt) });
                        diffs[i].val += amt; diffs[j].val -= amt;
                    }
                    
                    // æ¨™è¨˜å·²ä»˜æ¬¾ç‹€æ…‹
                    return res.map(s => {
                        const key = `${s.from}-${s.to}-${s.amount}`;
                        return {
                            ...s,
                            paid: !!settlementsPaid.value[key]
                        };
                    });
                });

                // --- UI Helpers ---
                const formatTime = (t) => t;
                const formatNumber = (n) => n.toLocaleString();
                const getCategoryColor = (c, bg) => { const map = {'æ™¯é»':'rose-500','ç¾é£Ÿ':'orange-500','äº¤é€š':'blue-500','ä½å®¿':'purple-500','è³¼ç‰©':'emerald-500'}; return bg ? `bg-${map[c]||'gray-400'}` : `text-${map[c]||'gray-400'}`; };
                const getCategoryIcon = (c) => ({'æ™¯é»':'fa-camera','ç¾é£Ÿ':'fa-utensils','äº¤é€š':'fa-train','ä½å®¿':'fa-bed','è³¼ç‰©':'fa-bag-shopping'}[c]||'fa-star');
                const switchTab = (t) => { currentTab.value = t; if(t==='map') nextTick(initMap); };
                
                // Map
                const initMap = () => {
                    if(mapInstance.value) { mapInstance.value.invalidateSize(); return; }
                    const map = L.map('mapContainer', {zoomControl:false}).setView([35.6895, 139.6917], 11);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {attribution:'&copy; OSM'}).addTo(map);
                    mapInstance.value = map;
                    updateMarkers();
                };
                const updateMarkers = () => {
                    if(!mapInstance.value) return;
                    mapMarkers.value.forEach(m => m.remove());
                    schedule.value.forEach(e => {
                        if(e.lat && e.lng) {
                            const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin ${getCategoryColor(e.category, true)}"></div><i class="fa-solid ${getCategoryIcon(e.category)} marker-icon"></i>`, iconSize: [30,42], iconAnchor: [15,42] });
                            const m = L.marker([e.lat, e.lng], {icon}).addTo(mapInstance.value).on('click', () => { mapSelectedEvent.value = e; mapInstance.value.setView([e.lat,e.lng], 14); });
                            mapMarkers.value.push(m);
                        }
                    });
                };
                const openMap = (e) => {
                     mapSelectedEvent.value = e; switchTab('map'); 
                     if(!e.lat) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.location)}`, '_blank');
                };
                
                // --- åˆ†å¸³ç‹€æ…‹è¿½è¹¤å‡½æ•¸ ---
                const toggleSettlementPaid = (settlement) => {
                    const key = `${settlement.from}-${settlement.to}-${settlement.amount}`;
                    if (settlementsPaid.value[key]) {
                        delete settlementsPaid.value[key];
                    } else {
                        settlementsPaid.value[key] = {
                            from: settlement.from,
                            to: settlement.to,
                            amount: settlement.amount,
                            paidAt: new Date().toISOString(),
                            paidBy: currentUser.value
                        };
                    }
                    saveData();
                };
                
                const clearAllSettlementsPaid = () => {
                    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²ä»˜æ¬¾æ¨™è¨˜å—ï¼Ÿ')) {
                        settlementsPaid.value = {};
                        saveData();
                    }
                };
                
                // --- åˆ†æ”¤æ–¹å¼å‡½æ•¸ ---
                const toggleParticipant = (member) => {
                    const index = expenseForm.value.participants.indexOf(member);
                    if (index === -1) {
                        expenseForm.value.participants.push(member);
                    } else {
                        expenseForm.value.participants.splice(index, 1);
                    }
                };
                
                // åˆå§‹åŒ–è‡ªè¨‚åˆ†æ”¤
                const initCustomSplits = () => {
                    const splits = {};
                    members.value.forEach(m => {
                        splits[m] = 0;
                    });
                    expenseForm.value.customSplits = splits;
                };

                // --- CRUD ---
                const openEventModal = () => { eventForm.value = {id:Date.now(), dayIdx: currentDayIndex.value, time:'10:00', category:'æ™¯é»'}; isEditing.value=false; showEventModal.value=true; };
                const editEvent = (e) => { eventForm.value = {...e}; isEditing.value=true; showEventModal.value=true; };
                const saveEvent = () => { 
                    if(!eventForm.value.title) return;
                    if(isEditing.value) { const i = schedule.value.findIndex(e=>e.id===eventForm.value.id); if(i!==-1) schedule.value[i] = {...eventForm.value}; }
                    else schedule.value.push({...eventForm.value});
                    saveData(); showEventModal.value=false;
                };
                const deleteEvent = () => { if(confirm('åˆªé™¤?')) { schedule.value = schedule.value.filter(e=>e.id!==eventForm.value.id); saveData(); showEventModal.value=false; } };
                const openExpenseModal = () => { 
                    expenseForm.value={
                        id:Date.now(), 
                        category:'é¤é£²', 
                        date: new Date().toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'}), 
                        payer: members.value[0],
                        splitMethod: 'equal',
                        participants: [...members.value], // é è¨­å…¨å“¡åƒèˆ‡
                        customSplits: {}
                    };
                    initCustomSplits();
                    showExpenseModal.value=true; 
                };
                const saveExpense = () => { 
                    if(!expenseForm.value.title) return;
                    
                    // è™•ç†åˆ†æ”¤é‚è¼¯
                    const expense = {...expenseForm.value};
                    
                    // æ¸…é™¤ä¸éœ€è¦çš„å±¬æ€§
                    delete expense.splitMethod;
                    delete expense.participants;
                    delete expense.customSplits;
                    
                    expenses.value.push(expense); 
                    saveData(); 
                    showExpenseModal.value=false; 
                };
                const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) { expenses.value = expenses.value.filter(e=>e.id!==id); saveData(); } };
                const addMember = () => { if(newMemberName.value && !members.value.includes(newMemberName.value)) { members.value.push(newMemberName.value); newMemberName.value=''; saveData(); } };
                const removeMember = (i) => { if(confirm('ç§»é™¤?')) { members.value.splice(i,1); saveData(); } };
                const forceSync = () => pollData();

                // Init
                onMounted(async () => {
                    // Initialize dark mode
                    if (isDarkMode.value) {
                        document.documentElement.classList.replace('light', 'dark');
                    }
                    
                    // åˆå§‹åŒ– token å’Œ gist id
                    tempToken.value = githubToken.value;
                    tempGistId.value = gistId.value;
                    
                    // è¼‰å…¥è³‡æ–™
                    await loadData();
                    
                    // å¦‚æœæ²’æœ‰ tokenï¼Œé¡¯ç¤ºæç¤º
                    if (!hasToken.value) {
                        syncStatus.value = 'error';
                        errorMessage.value = 'è«‹å…ˆè¨­å®š GitHub Token ä»¥å•Ÿç”¨åŒæ­¥åŠŸèƒ½';
                    }
                    
                    // è¨­å®šå®šæ™‚æª¢æŸ¥
                    setInterval(pollData, POLL_INTERVAL);
                });

                watch(currentTab, (v) => { if(v==='map') nextTick(() => { initMap(); updateMarkers(); }); });

                return {
                    currentTab, currentDayIndex, days, schedule, expenses, members, sortedExpenses, currentDayEvents,
                    totalExpense, avgExpense, expenseStats, memberBalances, settlements, hasSettlementsPaid,
                    statusText, statusColorClass, lastUpdatedBy, formattedLastUpdate,
                    showEventModal, showExpenseModal, showMemberModal, showIdentityModal, showIdentityConfirmModal, showTokenModal, isEditing, eventForm, expenseForm, 
                    newMemberName, tempIdentity, tempToken, tempGistId, showTokenInput,
                    mapSelectedEvent, isInitialLoading, errorMessage, syncStatus, currentUser, isDarkMode, hasToken,
                    switchTab, openEventModal, editEvent, saveEvent, deleteEvent, openExpenseModal, saveExpense, deleteExpense,
                    addMember, removeMember, saveIdentity, cancelIdentityChange, handleIdentityClick, saveToken, clearToken, forceSync, openMap, formatTime, formatNumber, 
                    getCategoryColor, getCategoryIcon, toggleDarkMode,
                    toggleSettlementPaid, clearAllSettlementsPaid, toggleParticipant
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
